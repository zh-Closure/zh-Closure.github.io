<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="Closure" />
  <meta name="description" content="" />
  <meta name="google-site-verification" content="ume8wxFIzFnN-uS2NK6TLbEnB0OL8U3QYLpG-0v0NPM" />
  
  
  <title>
    
      AFL注释 
      
      
      |
    
     Closure
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Closure</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">主页</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">归档</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">关于我</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">AFL注释</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2022-04-27 22:16:35
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="标签"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Fuzz/" title="Fuzz">
                    #Fuzz
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="AFL注释"><a href="#AFL注释" class="headerlink" title="AFL注释"></a>AFL注释</h1><h2 id="1、afl-gcc-c："><a href="#1、afl-gcc-c：" class="headerlink" title="1、afl-gcc.c："></a>1、afl-gcc.c：</h2><p>概述：</p>
<p>afl-gcc.c是一个gcc的封装，能够实现对一些关键节点进行插桩，从而记录一些程序执行路径之类的信息，方便对程序的一些运行情况进行反馈</p>
<p>main函数：</p>
<p>主要实现三个函数的调用：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220418215016219.png"></p>
<p>详细注释：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*
  Copyright 2013 Google LLC All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/</span>

<span class="token comment">/*
   american fuzzy lop - wrapper for GCC and clang
   ----------------------------------------------

   Written and maintained by Michal Zalewski &lt;lcamtuf@google.com>

   This program is a drop-in replacement for GCC or clang. The most common way
   of using it is to pass the path to afl-gcc or afl-clang via CC when invoking
   ./configure.

   (Of course, use CXX and point it to afl-g++ / afl-clang++ for C++ code.)

   The wrapper needs to know the path to afl-as (renamed to 'as'). The default
   is /usr/local/lib/afl/. A convenient way to specify alternative directories
   would be to set AFL_PATH.

   If AFL_HARDEN is set, the wrapper will compile the target app with various
   hardening options that may help detect memory management issues more
   reliably. You can also specify AFL_USE_ASAN to enable ASAN.

   If you want to call a non-default compiler as a next step of the chain,
   specify its location via AFL_CC or AFL_CXX.

*/</span>

<span class="token comment">/*
alf是一个gcc的一个封装，能够实现对于一些关键节点的插桩==》记录一些程序执行路径之类的信息
方便程序对于一些运行情况进行反馈
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFL_MAIN</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"debug.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"alloc-inl.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">static</span> u8<span class="token operator">*</span>  as_path<span class="token punctuation">;</span>                <span class="token comment">/* Path to the AFL 'as' wrapper ：AFL as包装器的路径      */</span>
<span class="token keyword">static</span> u8<span class="token operator">*</span><span class="token operator">*</span> cc_params<span class="token punctuation">;</span>              <span class="token comment">/* Parameters passed to the real CC ：CC实际使用的编译器参数 */</span>
<span class="token keyword">static</span> u32  cc_par_cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">/* Param count, including argv0 ：参数计数包括argv0     */</span>
<span class="token keyword">static</span> u8   be_quiet<span class="token punctuation">,</span>               <span class="token comment">/* Quiet mode     ：静默模式                   */</span>
            clang_mode<span class="token punctuation">;</span>             <span class="token comment">/* Invoked as afl-clang*?   ：是否使用afl-clang*模式 */</span>


<span class="token comment">/* Try to find our "fake" GNU assembler in AFL_PATH or at the location derived
   from argv[0]. If that fails, abort. */</span>

<span class="token comment">/*该函数通过argv0（当前文件路径）寻找对应的汇编器as
as：Linux上很常用的一个汇编器，负责把生成的汇编代码编译到二进制
*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_as</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> argv0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 <span class="token operator">*</span>afl_path <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取环境中的AFL_PATH变量</span>
  u8 <span class="token operator">*</span>slash<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>afl_path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//获取成功</span>
    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/as"</span><span class="token punctuation">,</span> afl_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//通过alloc_printf动态分配一段空间存储对应的路径</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//检查这段路径是否可访问</span>
      as_path <span class="token operator">=</span> afl_path<span class="token punctuation">;</span><span class="token comment">//可访问赋值给as_path</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放alloc_printf分配的内存</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不可访问直接释放alloc_printf分配的内存</span>

  <span class="token punctuation">&#125;</span>

  slash <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv0<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取AFL_PATH变量失败，提取当前路径dir</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>slash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果获取到当前路径的dir</span>

    u8 <span class="token operator">*</span>dir<span class="token punctuation">;</span>

    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    dir <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>argv0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提取当前路径dir</span>
    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token char">'/'</span><span class="token punctuation">;</span>

    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/afl-as"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//alloc_printf为dir开辟空间存放路径</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果路径可达</span>
      as_path <span class="token operator">=</span> dir<span class="token punctuation">;</span><span class="token comment">//将路径赋值给as_path</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放alloc_printf创建的空间</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果路径不能访问，释放alloc_printf为dir开辟的空间</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>AFL_PATH <span class="token string">"/as"</span><span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//以上两种情况都没有成功==》直接找as</span>
    as_path <span class="token operator">=</span> AFL_PATH<span class="token punctuation">;</span><span class="token comment">//找到了且可以访问就直接赋值</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to find AFL wrapper binary for 'as'. Please set AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//找不到通过FATAL输出错误信息，然后exit(1)</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">/* Copy argv to cc_params, making the necessary edits. */</span>

<span class="token comment">/*该函数主要用来设置CC的参数
*/</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 fortify_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> asan_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u8 <span class="token operator">*</span>name<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>
  u8 m32_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  cc_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为cc_params开辟内存空间</span>

  name <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过找到最后一个/取出此时对应什么编译器，例：afl-gcc，将这个名字赋给name</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">else</span> name<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果以afl-clang开通</span>

    clang_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//设置clang模式参数为1</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果以afl-clang开头++</span>
      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取环境变量AFL_CXX</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang++"</span><span class="token punctuation">;</span><span class="token comment">//如果获取到环境变量值，将环境变量赋值给cc_params[]，如果没有获取则直接给字符串“clang++”</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果name变量中不是afl-clang++，就获取环境变量AFL-CC</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang"</span><span class="token punctuation">;</span><span class="token comment">//如果获取到环境变量值，将环境变量赋值给cc_params[],如果没有获取到则直接给字符串“clang”</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/* With GCJ and Eclipse installed, you can actually compile Java! The
       instrumentation will work (amazingly). Alas, unhandled exceptions do
       not call abort(), so afl-fuzz would need to be modified to equate
       non-zero exit codes with crash conditions when working with Java
       binaries. Meh. */</span>
<span class="token comment">//如果不是以afl-clang开头，并且是apple平台，进入该分支</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-g++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果对比值是afl-g++,则获取AFL-CXX环境变量赋给cc_params[0]</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-gcj"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_GCJ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果对比值是afl-gcj,则获取AFL-GCJ环境变量赋给cc_params[0]</span>
    <span class="token keyword">else</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果name值不是以上两个，则获取AFL-CC环境变量赋给CC_params[0]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果cc_params[0]没有值，则提示Mac下要使用afl-clang，如果要使用afl-gcc则需要配置路径</span>

      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"On Apple systems, 'gcc' is usually just a wrapper for clang. Please use the\n"</span>
           <span class="token string">"    'afl-clang' utility instead of 'afl-gcc'. If you really have GCC installed,\n"</span>
           <span class="token string">"    set AFL_CC or AFL_CXX to specify the correct path to that compiler.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"AFL_CC or AFL_CXX required on MacOS X"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token comment">//不是apple平台</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-g++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//对比值如果是afl-gcc++</span>
      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取AFL_CXX环境变量</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"g++"</span><span class="token punctuation">;</span><span class="token comment">//如果获取到值则直接将环境变量赋给cc_params[0],如果没有则直接将字符串“g++”赋给cc_params[0]</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-gcj"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//对比值如果是afl-gcj</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_GCJ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取AFL_GCJ环境变量</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcj"</span><span class="token punctuation">;</span><span class="token comment">//如果获取到值则直接将环境变量赋给cc_params[0],如果没有则直接将字符串“gcj”赋给cc_params[0]</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取AFL_CC环境变量</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcc"</span><span class="token punctuation">;</span><span class="token comment">//如果获取到值则直接将环境变量赋给cc_params[0],如果没有则直接将字符串“gcc”赋给cc_params[0]</span>
    <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//循环遍历参数</span>
    u8<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">++</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取参数</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-B"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果当前参数是“-B”</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"-B is already set, overriding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//判断静默模式是否关闭，如果关闭提示“-B”参数已经设置</span>
      <span class="token comment">//-B选项用于设置编译器的搜索路径，在find_as函数中处理</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cur<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> argc <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> argc<span class="token operator">--</span><span class="token punctuation">;</span> argv<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-integrated-as"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//当前参数如果是"-integrated-as"时跳出本次循环</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-pipe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//当前参数如果是"-pipe"则跳出本次循环</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span><span class="token comment">//判断如果是FreeBSD系统或者是64位系统</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-m32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m32_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//判断当前参数为"-m32"时，设置m32_set标志参数为1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> asan_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//判断当前参数为"-fsanitize=address"或者"-fsanitize=memory"时，设置asan_set参数为1==》这两个参数告诉gcc要检查内存访问错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"FORTIFY_SOURCE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> fortify_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//判断当前参数为"FORTIFY_SOURCE"，设置fortify_set参数为1==》此参数为fortify保护是否开启</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span><span class="token comment">//给cc_params赋值，cc_par_cnt全局变量初始值为1</span>

  <span class="token punctuation">&#125;</span>

  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-B"</span><span class="token punctuation">;</span>
  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> as_path<span class="token punctuation">;</span><span class="token comment">//取出find_as()函数中的as_path,组成"-B as_path"</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>clang_mode<span class="token punctuation">)</span><span class="token comment">//判断clang模式为1==>此标志参数在获取参数时进行第一次设置</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-no-integrated-as"</span><span class="token punctuation">;</span><span class="token comment">//赋值cc_params追加参数"-no-integrated-as"</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//获取环境变量AFL_HAREEN，如果成功获取，进入分支</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fstack-protector-all"</span><span class="token punctuation">;</span><span class="token comment">//赋值cc_params追加参数"-fstack-protector-all"</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fortify_set<span class="token punctuation">)</span><span class="token comment">//检查是否设置fortify_set参数，如果没有，进入分支</span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D_FORTIFY_SOURCE=2"</span><span class="token punctuation">;</span><span class="token comment">////赋值cc_params追加参数"-D_FORTIFY_SOURCE=2"</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>asan_set<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//判断是否检查检查内存，如果已经在224中设置为1</span>

    <span class="token comment">/* Pass this on to afl-as to adjust map density. */</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置"AFL_USE_ASAN"环境变量为1</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果AFL_USE_ASAN已经被设置为1，进入分支</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断获取AFL_USE_MSAN环境变量是否成功</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示ASAN和MSAN是互斥的</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断获取AFL_HADREN环境变量是否获取成功，成功则进入分支</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示ASAN与HARDEN是互斥的</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">;</span>
<span class="token comment">//如果上述两个环境变量都没有被设置，则在cc_params追加"-U_FORTIFY_SOURCE"和"-fsanitize=address"两个参数</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//获取AFL_USE_MSAN环境变量，成功则进入分支</span>
<span class="token comment">//</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//获取AFL_USE_ASAN环境变量</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示MSAN与ASAN互斥</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//获取AFL_HARDEN环境变量</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"MSAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示MSAN与HARDEN互斥</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">;</span>
<span class="token comment">//如果上述两个环境变量都没有被设置，则在cc_params追加"-U_FORTIFY_SOURCE"和"-fsanitize=memory"参数</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DONT_OPTIMIZE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//获取AFL_DONT_OPTIMIZE环境变量，失败进入分支</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>

    <span class="token comment">/* On 64-bit FreeBSD systems, clang -g -m32 is broken, but -m32 itself
       works OK. This has nothing to do with us, but let's avoid triggering
       that bug. */</span>
<span class="token comment">//在64位FreeBSD系统上，clang -g -m32不能用，但-m32本身工作正常。这与我们无关，但我们得避免触发那个漏洞</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">||</span> <span class="token operator">!</span>m32_set<span class="token punctuation">)</span><span class="token comment">//如果没有设置clang模式或者没有设置-m32参数则进入分支</span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span><span class="token comment">//cc_params中追加-g参数</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token comment">//如果不是以上两种系统则进入分支</span></span>

      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span><span class="token comment">//cc_params中追加-g参数</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-O3"</span><span class="token punctuation">;</span><span class="token comment">//cc_params中追加-O3参数</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-funroll-loops"</span><span class="token punctuation">;</span><span class="token comment">//cc_params中追加-funroll-loops参数</span>

    <span class="token comment">/* Two indicators that you're building for fuzzing; one of them is
       AFL-specific, the other is shared with libfuzzer. */</span>
<span class="token comment">//你为模糊建立的两个指标，其中一个是afl特定的，另一个是libfuzzer共享的</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D__AFL_COMPILER=1"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1"</span><span class="token punctuation">;</span>
<span class="token comment">//在cc_params中追加"-D__AFL_COMPILER=1"和"-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1"两个参数</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_BUILTIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果设置了AFL_NO_BUILTIN环境变量则进入循环</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasecmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncasecmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-memcmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strstr"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasestr"</span><span class="token punctuation">;</span>
<span class="token comment">//在cc_params中追加参数</span>
  <span class="token punctuation">&#125;</span>

  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//cc_params最后追加NULL，表示参数数组结束</span>

<span class="token punctuation">&#125;</span>


<span class="token comment">/* Main entry point */</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-cc "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span>
         <span class="token string">"This is a helper application for afl-fuzz. It serves as a drop-in replacement\n"</span>
         <span class="token string">"for gcc or clang, letting you recompile third-party code with the required\n"</span>
         <span class="token string">"runtime instrumentation. A common use pattern would be one of the following:\n\n"</span>

         <span class="token string">"  CC=%s/afl-gcc ./configure\n"</span>
         <span class="token string">"  CXX=%s/afl-g++ ./configure\n\n"</span>

         <span class="token string">"You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n"</span>
         <span class="token string">"Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n"</span><span class="token punctuation">,</span>
         BIN_PATH<span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">find_as</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主要来查找汇编器</span>

  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过我们传入编译的参数进行参数处理，将确定的参数放入cc_params[]数组</span>

  <span class="token function">execvp</span><span class="token punctuation">(</span>cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>cc_params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行afl-gcc</span>
  <span class="token comment">/*参数解析：
  cc_params[0]：编译器
  (char**)cc_params：编译器参数
  */</span>

  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h2 id="2、afl-as-c"><a href="#2、afl-as-c" class="headerlink" title="2、afl-as.c:"></a>2、afl-as.c:</h2><p>详细注释：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*
  Copyright 2013 Google LLC All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/</span>

<span class="token comment">/*
   american fuzzy lop - wrapper for GNU as
   ---------------------------------------

   Written and maintained by Michal Zalewski &lt;lcamtuf@google.com>

   The sole purpose of this wrapper is to preprocess assembly files generated
   by GCC / clang and inject the instrumentation bits included from afl-as.h. It
   is automatically invoked by the toolchain when compiling programs using
   afl-gcc / afl-clang.

   Note that it's an explicit non-goal to instrument hand-written assembly,
   be it in separate .s files or in __asm__ blocks. The only aspiration this
   utility has right now is to be able to skip them gracefully and allow the
   compilation process to continue.

   That said, see experimental/clang_asm_normalize/ for a solution that may
   allow clang users to make things work even with hand-crafted assembly. Just
   note that there is no equivalent for GCC.

*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFL_MAIN</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"config.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"debug.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"alloc-inl.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"afl-as.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>

<span class="token keyword">static</span> u8<span class="token operator">*</span><span class="token operator">*</span> as_params<span class="token punctuation">;</span>          <span class="token comment">/* Parameters passed to the real 'as'   */</span>

<span class="token keyword">static</span> u8<span class="token operator">*</span>  input_file<span class="token punctuation">;</span>         <span class="token comment">/* Originally specified input file      */</span>
<span class="token keyword">static</span> u8<span class="token operator">*</span>  modified_file<span class="token punctuation">;</span>      <span class="token comment">/* Instrumented file for the real 'as'  */</span>

<span class="token keyword">static</span> u8   be_quiet<span class="token punctuation">,</span>           <span class="token comment">/* Quiet mode (no stderr output)        */</span>
            clang_mode<span class="token punctuation">,</span>         <span class="token comment">/* Running in clang mode?               */</span>
            pass_thru<span class="token punctuation">,</span>          <span class="token comment">/* Just pass data through?              */</span>
            just_version<span class="token punctuation">,</span>       <span class="token comment">/* Just show version?                   */</span>
            sanitizer<span class="token punctuation">;</span>          <span class="token comment">/* Using ASAN / MSAN                    */</span>

<span class="token keyword">static</span> u32  inst_ratio <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span>   <span class="token comment">/* Instrumentation probability (%)      */</span>
            as_par_cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">/* Number of params to 'as'             */</span>

<span class="token comment">/* If we don't find --32 or --64 in the command line, default to 
   instrumentation for whichever mode we were compiled with. This is not
   perfect, but should do the trick for almost all use cases. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">WORD_SIZE_64</span></span>

<span class="token keyword">static</span> u8   use_64bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//64位标志位</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

<span class="token keyword">static</span> u8   use_64bit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//32位标志位</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">error</span> <span class="token string">"Sorry, 32-bit Apple platforms are not supported."</span><span class="token comment">//苹果平台不支持32位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^WORD_SIZE_64 */</span></span>


<span class="token comment">/* Examine and modify parameters to pass to 'as'. Note that the file name
   is always the last parameter passed by GCC, so we exploit this property
   to keep the code simple. */</span>
<span class="token comment">/*检查并修改要传递给as的参数，注意文件名总是GCC传递的最后一个参数
因此我们利用这个属性来保持代码简单
*/</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 <span class="token operator">*</span>tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMPDIR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>afl_as <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_AS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取环境变量TMPDIR和AFL_AS</span>
  u32 i<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__ </span><span class="token comment">//如果是APPLE平台</span></span>

  u8 use_clang_as <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* On MacOS X, the Xcode cctool 'as' driver is a bit stale and does not work
     with the code generated by newer versions of clang that are hand-built
     by the user. See the thread here: http://goo.gl/HBWDtn.

     To work around this, when using clang and running without AFL_AS
     specified, we will actually call 'clang -c' instead of 'as -q' to
     compile the assembly file.

     The tools aren't cmdline-compatible, but at least for now, we can
     seemingly get away with this by making only very minor tweaks. Thanks
     to Nico Weber for the idea. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>afl_as<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果使用clang模式并且没有获得AFL_AS环境变量</span>

    use_clang_as <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//设指use_clang_as变量为1</span>

    afl_as <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>afl_as<span class="token punctuation">)</span> afl_as <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>afl_as<span class="token punctuation">)</span> afl_as <span class="token operator">=</span> <span class="token string">"clang"</span><span class="token punctuation">;</span>  <span class="token comment">//将afl_as赋值为AFL_CC,AFL_CXX环境变量或clang中的一种</span>

  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token comment">/* Although this is not documented, GCC also uses TEMP and TMP when TMPDIR
     is not set. We need to check these non-standard variables to properly
     handle the pass_thru logic later on. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TEMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token string">"/tmp"</span><span class="token punctuation">;</span>  <span class="token comment">//为tmp_dir赋值为TMPDIR,TEMP,TMP环境变量或者/tmp中的一种</span>

  as_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//为as_params开辟空间</span>

  as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> afl_as <span class="token operator">?</span> afl_as <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"as"</span><span class="token punctuation">;</span>
  <span class="token comment">//afl_as是否已经获取到AFL_AS环境变量，如果获取到就将环境变量的值赋给as_params[0]</span>
  <span class="token comment">//如果没有获取到，就将as字符串赋给afl_as</span>

  as_params<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//设置最后一个参数为0</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//从第一个参数开始遍历到最后一个参部</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//如果遍历到--64参数，就将use_64bit设置为1</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//如果遍历到--32参数，就将use_64bit设置为0</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__  </span><span class="token comment">//如果时APPLE平台</span></span>

    <span class="token comment">/* The Apple case is a bit different... */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-arch"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果遍历到-arch参数</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"x86_64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//-arch x86_64，将use_bit设置为1</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"i386"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//是-arch i386就报错</span>
        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Sorry, 32-bit Apple platforms are not supported."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Strip options that set the preference for a particular upstream
       assembler in Xcode. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-q"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-Q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果是clang模式，并且遍历的是-q或者-Q参数，跳出循环</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__  </span><span class="token comment">//APPLE平台</span></span>

  <span class="token comment">/* When calling clang as the upstream assembler, append -c -x assembler
     and hope for the best. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>use_clang_as<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-c"</span><span class="token punctuation">;</span>
    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-x"</span><span class="token punctuation">;</span>
    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"assembler"</span><span class="token punctuation">;</span>
    <span class="token comment">//如果使用的是clang模式，追加参数-c -x assembler</span>

  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  input_file <span class="token operator">=</span> argv<span class="token punctuation">[</span>argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//将最后一个参数的值赋给input_file</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果input_file的首字母为-</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_file <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"-version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果是-version</span>
      just_version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置just_version为1</span>
      modified_file <span class="token operator">=</span> input_file<span class="token punctuation">;</span>  <span class="token comment">//modified_file设置为-version</span>
      <span class="token keyword">goto</span> wrap_things_up<span class="token punctuation">;</span>  <span class="token comment">//跳转至参数组合结尾</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Incorrect use (not called through afl-gcc?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果-后面的不是version，抛出异常</span>
      <span class="token keyword">else</span> input_file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/* Check if this looks like a standard invocation as a part of an attempt
       to compile a program, rather than using gcc on an ad-hoc .s file in
       a format we may not understand. This works around an issue compiling
       NSS. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tmp_dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/var/tmp/"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/tmp/"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> pass_thru <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">/*如果首字母不是-，则对比input_file的前strlen(tmp_dir)9~5个字节
        是否与tmp_dir,/var/tmp/,/tmp/相同，如果不相同就将pass_thru设置为1*/</span>
  <span class="token punctuation">&#125;</span>

  modified_file <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.afl-%u-%u.s"</span><span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//设置midified_file为类似tmp_dir/.afl-pid-time.s这样的字符串</span>

wrap_things_up<span class="token operator">:</span>

  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> modified_file<span class="token punctuation">;</span>  <span class="token comment">//接收参数为modified_file</span>
  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">//参数接收结束</span>

<span class="token punctuation">&#125;</span>


<span class="token comment">/* Process input file, generate modified_file. Insert instrumentation in all
   the appropriate places. */</span>
<span class="token comment">/*处理输入文件，生成modified_file，将桩插入所有释放的位置*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 line<span class="token punctuation">[</span>MAX_LINE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  FILE<span class="token operator">*</span> inf<span class="token punctuation">;</span>
  FILE<span class="token operator">*</span> outf<span class="token punctuation">;</span>
  s32 outfd<span class="token punctuation">;</span>
  u32 ins_lines <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  u8  instr_ok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> skip_csect <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> skip_next_label <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      skip_intel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> skip_app <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> instrument_next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

  u8<span class="token operator">*</span> colon_pos<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果存在输入文件名</span>

    inf <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//尝试获取input_file句柄，将fd赋值给inf</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read '%s'"</span><span class="token punctuation">,</span> input_file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//如果获取不到，抛异常</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> inf <span class="token operator">=</span> <span class="token constant">stdin</span><span class="token punctuation">;</span> <span class="token comment">//如果不存在文件名则赋值标准输入</span>

  outfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_EXCL <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//以写的方式打开modified_file，如果文件已存在就直接打开吗，如果没有就创建一个</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>outfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to write to '%s'"</span><span class="token punctuation">,</span> modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  outf <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>outfd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//尝试打开</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果文件没有写入权限则抛出异常  </span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> MAX_LINE<span class="token punctuation">,</span> inf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/*循环读取inf指向的文件的每一行到line数组，每行最多MAX_LINE(8192)个字符，含末尾\0*/</span>

    <span class="token comment">/* In some cases, we want to defer writing the instrumentation trampoline
       until after all the labels, macros, comments, etc. If we're in this
       mode, and if the line starts with a tab followed by a character, dump
       the trampoline now. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pass_thru <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_intel <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_app <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_csect <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span>
        instrument_next <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isalpha</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//判断是否为defered mode模式</span>

      <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span>
              <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//插桩</span>

      instrument_next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//instrument_next重新设置为0</span>
      ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//插桩计数器+1</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Output the actual line, call it a day in pass-thru mode. */</span>

    <span class="token function">fputs</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pass_thru<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token comment">/* All right, this is where the actual fun begins. For one, we only want to
       instrument the .text section. So, let's keep track of that in processed
       files - and let's set instr_ok accordingly. */</span>
    <span class="token comment">/*首先我们只想检测.text部分，让我们在已处理的文件中跟踪它，并相应地设置instr_ok
    */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//判断读入的行是否以\t开头，并且line[1]是否为.</span>

      <span class="token comment">/* OpenBSD puts jump tables directly inline with the code, which is
         a bit annoying. They use a specific format of p2align directives
         around them, so we use that as a signal. */</span>
      <span class="token comment">/*OpenBSD将跳转表直接内联到代码中，这有点烦人，他们使用特定格式篇p2align指令，我们将其用作信号
      */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"p2align "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> skip_next_label <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">//检查是否为p2align指令，如果是则设置skip_next_label为1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"text\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t.text"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t__TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section __TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instr_ok <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span> 
        <span class="token comment">/*匹配"text\n","section\t.text","section\t__TEXT,__text","section __TEXT,__text"
        如果匹配成功就设置instr_ok为1，跳出本次循环
        */</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"bss\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"data\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instr_ok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">/*匹配"section\t"，"section "，"bss\n"，"data\n"
        如果匹配成功就设置instr_ok为0
        */</span>
      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Detect off-flavor assembly (rare, happens in gdb). When this is
       encountered, we set skip_csect until the opposite directive is
       seen, and we do not instrument. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//判断架构</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> use_64bit<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> <span class="token operator">!</span>use_64bit<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Detect syntax changes, as could happen with hand-written assembly.
       Skip Intel blocks, resume instrumentation when back to AT&amp;T. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".intel_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//判断是否为Intel汇编语法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".att_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//判断是否为att汇编语法</span>

    <span class="token comment">/* Detect and skip ad-hoc __asm__ blocks, likewise skipping them. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//ad-hoc__asm__快是否跳过</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#NO_APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* If we're in the right mood for instrumenting, check for function
       names or conditional labels. This is a bit messy, but in essence,
       we want to catch:  插桩时终端关注对象

         ^main:      - function entry point (always instrumented)  main函数
         ^.L0:       - GCC branch label    gcc下地分支标记
         ^.LBB0_0:   - clang branch label (but only in clang mode)   clang下地分支标记
         ^\tjnz foo  - conditional branches    条件跳转分支标记

       ...but not:

         ^# BB#0:    - clang comments
         ^ # BB#0:   - ditto
         ^.Ltmp0:    - clang non-branch labels
         ^.LC0       - GCC non-branch labels
         ^.LBB0_0:   - ditto (when in GCC mode)
         ^\tjmp foo  - non-conditional jumps

       Additionally, clang and GCC on MacOS X follow a different convention
       with no leading dots on labels, hence the weird maze of #ifdefs
       later on.

     */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_intel <span class="token operator">||</span> skip_app <span class="token operator">||</span> skip_csect <span class="token operator">||</span> <span class="token operator">!</span>instr_ok <span class="token operator">||</span>
        line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token comment">/* Conditional branch instruction (jnz, etc). We append the instrumentation
       right after the branch (to instrument the not-taken path) and at the
       branch destination label (handled later on). */</span>
    <span class="token comment">/*跳转指令jnz等，我们将检测附加在分支之后（以检测未使用地路径）和分支目标标签（稍后处理）*/</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'j'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'m'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span>
                <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否为64位程序，使用fprintf函数将桩插在outf指向地文件的\tj[^m].跳转指令位置</span>
        <span class="token comment">//插入长度为R函数创建的小于MAP_SIZE的随机数</span>

        ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//插桩计数器+1，跳出循环进行下一次遍历</span>

      <span class="token punctuation">&#125;</span>

      <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Label of some sort. This may be a branch destination, but we need to
       tread carefully and account for several different formatting
       conventions. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

    <span class="token comment">/* Apple: L&lt;whatever>&lt;digit>: */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>colon_pos <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检查line中是否存在":"</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'L'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isdigit</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>colon_pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检查line是否以L开始</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

    <span class="token comment">/* Everybody else: .L&lt;whatever>: */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检查line中是否存在":"</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检查是否以"."开始</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

        <span class="token comment">/* .L0: or LBB0_0: style jump destination */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

        <span class="token comment">/* Apple: L&lt;num> / LBB&lt;num> */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"LBB"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

        <span class="token comment">/* Apple: .L&lt;num> / .LBB&lt;num> */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"LBB"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//检查line[2]是否为数字，或者clang模式下从line[1]开始的三个字节是否为LBB，并且随机数小于插桩密度</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

          <span class="token comment">/* An optimization is possible here by adding the code only if the
             label is mentioned in the code in contexts other than call / jmp.
             That said, this complicates the code by requiring two-pass
             processing (messy with stdin), and results in a speed gain
             typically under 10%, because compilers are generally pretty good
             about not generating spurious intra-function jumps.

             We use deferred output chiefly to avoid disrupting
             .Lfunc_begin0-style exception handling calculations (a problem on
             MacOS X). */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip_next_label<span class="token punctuation">)</span> instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">else</span> skip_next_label <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token comment">//设置instrument_next为1</span>
        <span class="token punctuation">&#125;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/* Function label (always instrumented, deferred mode). */</span>
        <span class="token comment">//否则代表这是一个Function label 插桩^func 设置instrument_next为1</span>
        instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ins_lines<span class="token punctuation">)</span>   <span class="token comment">//如果插桩计数器不为0</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>use_64bit <span class="token operator">?</span> main_payload_64 <span class="token operator">:</span> main_payload_32<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//向outf中写入main_payload_64或者mian_payload_32</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>inf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//关闭文件</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//关闭文件</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果使用的不是静默模式</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ins_lines<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No instrumentation targets found%s."</span><span class="token punctuation">,</span>
                          pass_thru <span class="token operator">?</span> <span class="token string">" (pass-thru mode)"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果插桩计数器为空，抛异常</span>
    <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Instrumented %u locations (%s-bit, %s mode, ratio %u%%)."</span><span class="token punctuation">,</span>
             ins_lines<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> <span class="token string">"64"</span> <span class="token operator">:</span> <span class="token string">"32"</span><span class="token punctuation">,</span>
             <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"hardened"</span> <span class="token operator">:</span> 
             <span class="token punctuation">(</span>sanitizer <span class="token operator">?</span> <span class="token string">"ASAN/MSAN"</span> <span class="token operator">:</span> <span class="token string">"non-hardened"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             inst_ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//插桩成功输出</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>


<span class="token comment">/* Main entry point */</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  s32 pid<span class="token punctuation">;</span>
  u32 rand_seed<span class="token punctuation">;</span>
  <span class="token keyword">int</span> status<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> inst_ratio_str <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_INST_RATIO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//该环境变量主要是控制每个分支的概率，取值0到1</span>

  <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">timezone</span> tz<span class="token punctuation">;</span>

  clang_mode <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-as "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span>
         <span class="token string">"This is a helper application for afl-fuzz. It is a wrapper around GNU 'as',\n"</span>
         <span class="token string">"executed by the toolchain whenever using afl-gcc or afl-clang. You probably\n"</span>
         <span class="token string">"don't want to run this program directly.\n\n"</span>

         <span class="token string">"Rarely, when dealing with extremely complex projects, it may be advisable to\n"</span>
         <span class="token string">"set AFL_INST_RATIO to a value less than 100 in order to reduce the odds of\n"</span>
         <span class="token string">"instrumenting every discovered branch.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取当前精确时间</span>

  rand_seed <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_sec <span class="token operator">^</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">^</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//通过当前时间与进程pid进行异或处理</span>

  <span class="token function">srandom</span><span class="token punctuation">(</span>rand_seed<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//获取随机化种子</span>

  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//检查并修改参数以传递给as，文件名是以GCC传递的最后一个参数</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果获取到AFL_INST_RATIO环境变量则进入分支</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">,</span> <span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>inst_ratio<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> inst_ratio <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> 
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad value of AFL_INST_RATIO (must be between 0 and 100)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果没有将覆盖率写入inst_ratio变量或者inst_ratio中的值查过100，抛异常</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//如果获取到"__AFL_AS_LOOPCHECK"环境变量</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Endless loop when calling 'as' (remove '.' from your PATH)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//抛出异常</span>

  <span class="token function">setenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置"__AFL_AS_LOOPCHECK"环境变量为1</span>

  <span class="token comment">/* When compiling with ASAN, we don't have a particularly elegant way to skip
     ASAN-specific branches. But we can probabilistically compensate for
     that... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//获取到AFL_USE_ASAN和AFL_USE_MASN环境变量，如果其中一个为1则进入分支</span>
    sanitizer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//sanitizer设置为1</span>
    inst_ratio <span class="token operator">/=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">//insr_ratio除以3</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>just_version<span class="token punctuation">)</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果不是只查询version，就会进入add_instrumentation函数</span>
  <span class="token comment">//该函数主要处理输入文件，生成modified_file，将桩插入释放的位置</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//调用fork创建一个子进程</span>

    <span class="token function">execvp</span><span class="token punctuation">(</span>as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>as_params<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用execvp函数执行命令和参数</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//不成功则抛异常</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//创建子进程失败则抛出异常</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//等待子进程结束</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_KEEP_ASSEMBLY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">unlink</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">//读取环境变量"AFL_KEEP_ASSEMBLY"失败则unlink掉modified_file</span>
  <span class="token comment">//设置该环境变量是为了防止afl-as删掉插桩后的汇编文件，设置为1会保留插桩后的汇编文件</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>







<h2 id="3、afl-fuzz-c"><a href="#3、afl-fuzz-c" class="headerlink" title="3、afl-fuzz.c:"></a>3、afl-fuzz.c:</h2><h3 id="初始配置函数"><a href="#初始配置函数" class="headerlink" title="初始配置函数"></a>初始配置函数</h3><h4 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h4><p>main函数对输入参数进行配置的第一个初始配置函数</p>
<p>作用：注册必要的信号处理函数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set up signal handlers. More complicated that needs to be, because libc on
   Solaris doesn't resume interrupted reads(), sets SA_RESETHAND when you call
   siginterrupt(), and does other unnecessary things. */</span>
<span class="token comment">/*设置信号处理程序，这里需要更加复杂===》libc Solaris不会中断reads()
在调用设置SA_RESETHAND siginterrupt()，并执行其他不必要的操作*/</span>

EXP_ST <span class="token keyword">void</span> <span class="token function">setup_signal_handlers</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">//注册必要的信号处理函数</span>
  <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>  <span class="token comment">//创建sigaction结构体变量sa</span>

  sa<span class="token punctuation">.</span>sa_handler   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  sa<span class="token punctuation">.</span>sa_flags     <span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
  sa<span class="token punctuation">.</span>sa_sigaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//初始化mask为空</span>

  <span class="token comment">/* Various ways of saying "stop".
  主要是stop函数的处理 */</span>

  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_stop_sig<span class="token punctuation">;</span>
  <span class="token comment">//handle_stop_sig设置为top_soon为1，如果child_pid存在</span>
  <span class="token comment">//向其发送SIGKILL终止信号，从而被系统杀死，如果forksrv_pid存在</span>
  <span class="token comment">//向其发送SIGKILL终止信号</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//SIGHUP,SIGINT,SIGTERM信号关联执行handle_stop_sig</span>

  <span class="token comment">/* Exec timeout notifications. 处理超时情况*/</span>

  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_timeout<span class="token punctuation">;</span>
  <span class="token comment">/*handle_timeout判断如果child_pid>0,则设置child_time_out为1,并kill掉child_pid
  如果child_pid=-1,设置child_time_out为1，并kill掉child_pid*/</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SIGALRM信号关联handle_resize</span>

  <span class="token comment">/* Window resize  处理窗口大小的变化信号 */</span>

  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_resize<span class="token punctuation">;</span>
  <span class="token comment">//handle_resize设置为clear_screen=1</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGWINCH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SIGWINCH信号关联handle_resize</span>

  <span class="token comment">/* SIGUSR1: skip entry */</span>

  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_skipreq<span class="token punctuation">;</span>  <span class="token comment">//handle_skipreq设置skip_requested=1</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//用户自定义信号，定义成skip_request(SIGUSRI),信号关联执行handle_skipreq</span>

  <span class="token comment">/* Things we don't care about.  不关心的信号种类 */</span>

  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_IGN<span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGTSTP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h4><p>检查ASAN选项，获取ASAN_OPTIONS和MSAN_OPTIONS环境变量，依据获取值抛出异常</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check ASAN options. 检查asan选项*/</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_asan_opts</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  u8<span class="token operator">*</span> x <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取ASAN_OPTIONS环境变量</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果获取了环境变量</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"abort_on_error=1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//检查是否同时设置了about_on_error=1，如果没有==》抛出异常</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"symbolize=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//检查是否同时设置了symboliz=0，如果没有==》抛出异常</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom ASAN_OPTIONS set without symbolize=0 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  x <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取环境变量MSAN_OPTIONS</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果获取了环境变量</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//检查是否同时设置了exit_code对应的状态码，如果没有==》抛出异常</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom MSAN_OPTIONS set without exit_code="</span>
            <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">" - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"symbolize=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//检查是否同时设置了symbolize=0,如果没有==》抛出异常</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom MSAN_OPTIONS set without symbolize=0 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h4><p>如果使用了-M或者-S指定了fuzzer，检查互斥，参数语法，fuzzer ID，sync_id是否过长</p>
<p>更新sync_dir和out_dir</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Validate and fix up out_dir and sync_dir when using -S. */</span>
<span class="token comment">/*在使用-S时，验证并修复out_dir和sync_dir。*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fix_up_sync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> x <span class="token operator">=</span> sync_id<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span>   <span class="token comment">//如果设置了dump_mode模式，提示-S / -M 参数与 -n 参数互斥</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-S / -M and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_deterministic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>force_deterministic<span class="token punctuation">)</span>   <span class="token comment">//-d参数纠正</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"use -S instead of -M -d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-S already implies -d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isalnum</span><span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char">'_'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span>   <span class="token comment">//fuzzer ID纠正</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Non-alphanumeric fuzzer ID specified via -S or -M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fuzzer ID too long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//sync_id过长抛出异常</span>

  x <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> sync_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  sync_dir <span class="token operator">=</span> out_dir<span class="token punctuation">;</span>   <span class="token comment">//更新sync_dir的值</span>
  out_dir  <span class="token operator">=</span> x<span class="token punctuation">;</span>       <span class="token comment">//更新out_dir的值，设置为out_dir或者sync_id</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force_deterministic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果没有设置force_deterministic</span>
    skip_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置skip_deterministic为1</span>
    use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置use_splicing为1</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="save-cmdline"><a href="#save-cmdline" class="headerlink" title="save_cmdline"></a>save_cmdline</h4><p>将当前输入参数拷贝进buf空间中</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Make a copy of the current command line.复制当前命令行 */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_cmdline</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> buf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  <span class="token comment">//计算参数长度</span>
    len <span class="token operator">+=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  
  buf <span class="token operator">=</span> orig_cmdline <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//开辟存储参数的空间</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历参数</span>

    u32 l <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//计算当前argv[i]的长度</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//将argv[i]中的内容放到buf空间</span>
    buf <span class="token operator">+=</span> l<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>buf<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
    <span class="token comment">//检查后面是否还有参数</span>

  <span class="token punctuation">&#125;</span>

  <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="fix-up-banner"><a href="#fix-up-banner" class="headerlink" title="fix_up_banner"></a>fix_up_banner</h4><p>获取目标程序名称或程序路径或路径+省略号</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Trim and possibly create a banner for the run. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fix_up_banner</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>use_banner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果没有设置use_banner</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果设置了sync_id</span>

      use_banner <span class="token operator">=</span> sync_id<span class="token punctuation">;</span>  <span class="token comment">//将sync_id赋值给use_banner</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果没有设置sync_id</span>

      u8<span class="token operator">*</span> trim <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取最后一个参数中最后一个/后面的内容（目标文件名称）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trim<span class="token punctuation">)</span> use_banner <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token keyword">else</span> use_banner <span class="token operator">=</span> trim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">//如果没有获取到，将目标文件路径赋值给use_banner</span>
      <span class="token comment">//如果获取到了，将去掉trim中的/</span>
      <span class="token comment">//例：trim=/closure,则use_banner=closure</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>use_banner<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//use_banner长度超过40</span>

    u8<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//创建一个44字节长度变量tmp</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"%.40s..."</span><span class="token punctuation">,</span> use_banner<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//取use_banary的前40个字节后面加上省略号</span>
    use_banner <span class="token operator">=</span> tmp<span class="token punctuation">;</span>  <span class="token comment">//将tmp赋值给use_banner</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty"></a>check_if_tty</h4><p>检测是否在tty终端上运行</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check if we're on TTY. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_if_tty</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">winsize</span> ws<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_UI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//如果设置了AFL_NO_UI环境变量</span>
    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Disabling the UI because AFL_NO_UI is set."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//提示禁用UI</span>
    not_on_tty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置not_on_tty为1</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> TIOCGWINSZ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//通过ioctl函数获取窗口大小</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOTTY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果报错为ENOTTY</span>
      <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Looks like we're not running on a tty, so I'll be a bit less verbose."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//提示不是在tty终端上运行的</span>
      not_on_tty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//设置not_no_tty为1</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="CPU相关管理函数"><a href="#CPU相关管理函数" class="headerlink" title="CPU相关管理函数"></a>CPU相关管理函数</h4><h5 id="get-core-count"><a href="#get-core-count" class="headerlink" title="get_core_count"></a>get_core_count</h5><p>获取CPU核心数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Count the number of logical CPU cores. */</span>
<span class="token comment">//获取CPU核心数</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">get_core_count</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 cur_runnable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span> <span class="token punctuation">(</span>__OpenBSD__<span class="token punctuation">)</span></span></span>

  <span class="token class-name">size_t</span> s <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cpu_core_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* On *BSD systems, we can just use a sysctl to get the number of CPUs. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sysctlbyname</span><span class="token punctuation">(</span><span class="token string">"hw.logicalcpu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_core_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

  <span class="token keyword">int</span> s_name<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> CTL_HW<span class="token punctuation">,</span> HW_NCPU <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sysctl</span><span class="token punctuation">(</span>s_name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu_core_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__APPLE__ */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_AFFINITY</span></span>

  cpu_core_count <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_NPROCESSORS_ONLN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

  FILE<span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/proc/stat"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  u8 tmp<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"cpu"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isdigit</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cpu_core_count<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^HAVE_AFFINITY */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^(__APPLE__ || __FreeBSD__ || __OpenBSD__) */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_core_count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    cur_runnable <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">get_runnable_processes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span> <span class="token punctuation">(</span>__OpenBSD__<span class="token punctuation">)</span></span></span>

    <span class="token comment">/* Add ourselves, since the 1-minute average doesn't include that yet. */</span>

    cur_runnable<span class="token operator">++</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ || __FreeBSD__ || __OpenBSD__ */</span></span>

    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"You have %u CPU core%s and %u runnable tasks (utilization: %0.0f%%)."</span><span class="token punctuation">,</span>
        cpu_core_count<span class="token punctuation">,</span> cpu_core_count <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">"s"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        cur_runnable<span class="token punctuation">,</span> cur_runnable <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> cpu_core_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_core_count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_runnable <span class="token operator">></span> cpu_core_count <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"System under apparent load, performance may be spotty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_runnable <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> cpu_core_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Try parallel jobs - see %s/parallel_fuzzing.txt."</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    cpu_core_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Unable to figure out the number of CPU cores."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>





<h5 id="check-crash-handling"><a href="#check-crash-handling" class="headerlink" title="check_crash_handling"></a>check_crash_handling</h5><p>确保core dump不进入程序</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Make sure that core dumps don't go to a program. */</span>
<span class="token comment">//确保核心转储不进入程序。</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_crash_handling</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

  <span class="token comment">/* Yuck! There appears to be no simple C API to query for the state of 
     loaded daemons on MacOS X, and I'm a bit hesitant to do something
     more sophisticated, such as disabling crash reporting via Mach ports,
     until I get a box to test the code. So, for now, we check for crash
     reporting the awful way. */</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"launchctl list 2>/dev/null | grep -q '\\.ReportCrash$'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
       <span class="token string">"Whoops, your system is configured to forward crash notifications to an\n"</span>
       <span class="token string">"    external crash reporting utility. This will cause issues due to the\n"</span>
       <span class="token string">"    extended delay between the fuzzed binary malfunctioning and this fact\n"</span>
       <span class="token string">"    being relayed to the fuzzer via the standard waitpid() API.\n\n"</span>
       <span class="token string">"    To avoid having crashes misinterpreted as timeouts, please run the\n"</span> 
       <span class="token string">"    following commands:\n\n"</span>

       <span class="token string">"    SL=/System/Library; PL=com.apple.ReportCrash\n"</span>
       <span class="token string">"    launchctl unload -w $&#123;SL&#125;/LaunchAgents/$&#123;PL&#125;.plist\n"</span>
       <span class="token string">"    sudo launchctl unload -w $&#123;SL&#125;/LaunchDaemons/$&#123;PL&#125;.Root.plist\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Crash reporter detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

  <span class="token comment">/* This is Linux specific, but I don't think there's anything equivalent on
     *BSD, so we can just let it slide for now. */</span>

  s32 fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/sys/kernel/core_pattern"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  u8  fchar<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Checking core_pattern..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fchar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> fchar <span class="token operator">==</span> <span class="token char">'|'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Hmm, your system is configured to send core dump notifications to an\n"</span>
         <span class="token string">"    external utility. This will cause issues: there will be an extended delay\n"</span>
         <span class="token string">"    between stumbling upon a crash and having this information relayed to the\n"</span>
         <span class="token string">"    fuzzer via the standard waitpid() API.\n\n"</span>

         <span class="token string">"    To avoid having crashes misinterpreted as timeouts, please log in as root\n"</span> 
         <span class="token string">"    and temporarily modify /proc/sys/kernel/core_pattern, like so:\n\n"</span>

         <span class="token string">"    echo core >/proc/sys/kernel/core_pattern\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Pipe at the beginning of 'core_pattern'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>
 
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__APPLE__ */</span></span>

<span class="token punctuation">&#125;</span></code></pre>





<h5 id="check-cpu-governor"><a href="#check-cpu-governor" class="headerlink" title="check_cpu_governor"></a>check_cpu_governor</h5><p>检查CPU管理者</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check CPU governor. */</span>
<span class="token comment">//检查CPU管理者</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_cpu_governor</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  FILE<span class="token operator">*</span> f<span class="token punctuation">;</span>
  u8 tmp<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  u64 min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SKIP_CPUFREQ"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Checking CPU scaling governor..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fgets</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fgets() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"perf"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fscanf</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"%llu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>min<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fscanf</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"%llu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>max<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>min <span class="token operator">==</span> max<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
       <span class="token string">"Whoops, your system uses on-demand CPU frequency scaling, adjusted\n"</span>
       <span class="token string">"    between %llu and %llu MHz. Unfortunately, the scaling algorithm in the\n"</span>
       <span class="token string">"    kernel is imperfect and can miss the short-lived processes spawned by\n"</span>
       <span class="token string">"    afl-fuzz. To keep things moving, run these commands as root:\n\n"</span>

       <span class="token string">"    cd /sys/devices/system/cpu\n"</span>
       <span class="token string">"    echo performance | tee cpu*/cpufreq/scaling_governor\n\n"</span>

       <span class="token string">"    You can later go back to the original state by replacing 'performance' with\n"</span>
       <span class="token string">"    'ondemand'. If you don't want to change the settings, set AFL_SKIP_CPUFREQ\n"</span>
       <span class="token string">"    to make afl-fuzz skip this check - but expect some performance drop.\n"</span><span class="token punctuation">,</span>
       min <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> max <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Suboptimal CPU scaling governor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="setup-post"><a href="#setup-post" class="headerlink" title="setup_post"></a>setup_post</h4><p>如果设置了AFL_POST_LIBRARY环境变量，则加载afl_portprocess函数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Load postprocessor, if available. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setup_post</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">void</span><span class="token operator">*</span> dh<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_POST_LIBRARY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//获取环境变量AFL_POST_LIBRARY</span>
  u32 tlen <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  
  <span class="token comment">//如果没有设置AFL_POST_LIBRARY,直接返回</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Loading postprocessor from '%s'..."</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//输出环境变量AFL_POST_LIBRARY</span>

  dh <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//以RTLD_NOW模式打开AFL_POST_LIBRARY环境变量指向的动态链接库</span>
  <span class="token comment">//在返回前解析处所有未定义的符号</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dh<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果dlopen没有解析出未定义的符号，报错</span>

  post_handler <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>dh<span class="token punctuation">,</span> <span class="token string">"afl_postprocess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//post_handler赋值为动态链接库中afl_postprocess()函数地址</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>post_handler<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Symbol 'afl_postprocess' not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果没有获取到afl_postprocess函数地址，抛出异常</span>

  <span class="token comment">/* Do a quick test. It's better to segfault now than later =) */</span>

  <span class="token function">post_handler</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//afl_portprocess函数测试</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Postprocessor installed successfully."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup_shm"></a>setup_shm</h4><p>设置共享内存以及virgin_bitis</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Configure shared memory and virgin_bits. This is called at startup. */</span>
<span class="token comment">//设置共享内存以及virgin_bitis</span>
<span class="token comment">/*virgin_bits:记录当前tuple信息，通过virgin_tmout和virgin_crash记录fuzz过程
中出现的所有目标程序超时及崩溃的tuple信息*/</span>
<span class="token comment">//trace_bits:记录当前的tuple信息，位于共享内存上，便于进程间通信</span>
EXP_ST <span class="token keyword">void</span> <span class="token function">setup_shm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> shm_str<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_bitmap<span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果in_bitmap为空，则初始化virgin_bits[MAP_SIZE]数组，每个元素为'255'(\xff)</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>virgin_tmout<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//初始化virgin_tmout[MAP_SIZE]数组,每个元素值为'255'(\xff)</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>virgin_crash<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//初始化virgin_crash[MAP_SIZE]数组,每个元素值为'255'(\xff)</span>

  shm_id <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//shm_id为shmget函数返回的共享内存标识符</span>
  <span class="token comment">/*
  shmget函数创建共享内存，IPC_PRIVATE为0所以创建一块新的共享内存，内存空间为MAP_SIZE字节
  权限：
  IPC_CREAT如果共享内存不存在，则创建一个共享内存
  IPC_EXEC只有在共享内存不存在的时候，新的共享内存才会创建，否则产生错误
  0600代表拥有者具有读写权限
  */</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span>shm_id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"shmget() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果没有获得共享内存标识符，即共享内存创建失败，抛出异常</span>

  <span class="token function">atexit</span><span class="token punctuation">(</span>remove_shm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//注册程序正常终止时删除共享内存</span>
  <span class="token comment">//remove_shm()函数对共享内存进行IPC_RMID操作（删除操作）</span>

  shm_str <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> shm_id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">//创建shm_id字符串变量，里面存放着shm_id</span>

  <span class="token comment">/* If somebody is asking us to fuzz instrumented binaries in dumb mode,
     we don't want them to detect instrumentation, since we won't be sending
     fork server commands. This should be replaced with better auto-detection
     later on, perhaps? */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token function">setenv</span><span class="token punctuation">(</span>SHM_ENV_VAR<span class="token punctuation">,</span> shm_str<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果没有设置dumb模式，设置"SHM_ENV_VAR"环境变量为shm_str</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>shm_str<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//释放shm_str指针</span>

  trace_bits <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//启动shmat对共享内存的访问，调用成功将trace_bits变量赋值为指向共享内存第一个字节的指针</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>trace_bits <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"shmat() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果shmat访问共享内存失败返回-1，并抛出异常</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="init-count-class16"><a href="#init-count-class16" class="headerlink" title="init_count_class16"></a>init_count_class16</h4><p>统计遍历路径的数量</p>
<p>tcace_bits是用一个字节来记录是否到达某一个路径，和这个路径被命中多少次</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> u8 count_class_lookup8<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>

  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">4</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">7</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>   <span class="token comment">//遍历4次到7次记作8次</span>
  <span class="token punctuation">[</span><span class="token number">8</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">15</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>  <span class="token comment">//遍历8次到15次记作16次</span>
  <span class="token punctuation">[</span><span class="token number">16</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">31</span><span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span>   <span class="token comment">//遍历16次到31次记作32次</span>
  <span class="token punctuation">[</span><span class="token number">32</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">127</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>   <span class="token comment">//遍历32次到127次记作64次</span>
  <span class="token punctuation">[</span><span class="token number">128</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">128</span>   <span class="token comment">//遍历128次到255次记作128次</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> u16 count_class_lookup16<span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


EXP_ST <span class="token keyword">void</span> <span class="token function">init_count_class16</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 b1<span class="token punctuation">,</span> b2<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>b1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b1 <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> b1<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> <span class="token punctuation">(</span>b2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b2 <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> b2<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token comment">/*将count_class_lookup16[65536]拆分成两个嵌套的256次循环
    256*256=65536
    */</span>
      count_class_lookup16<span class="token punctuation">[</span><span class="token punctuation">(</span>b1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> b2<span class="token punctuation">]</span> <span class="token operator">=</span> 
        <span class="token punctuation">(</span>count_class_lookup8<span class="token punctuation">[</span>b1<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        count_class_lookup8<span class="token punctuation">[</span>b2<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">/*count_class_lookup8[b1]左移8的结果同count_class_lookup8[b2]
        进行按位或操作，结果放在b1左移8加上b2下标的count_class_lookup16数组成员中
        */</span>

<span class="token punctuation">&#125;</span></code></pre>

<p>通过对路径判断是否有什么利用价值，减小该路径的循环次数&#x3D;&#x3D;》减小循环造成的影响</p>
<h4 id="setup-dirs-fds"><a href="#setup-dirs-fds" class="headerlink" title="setup_dirs_fds"></a>setup_dirs_fds</h4><p>准备输出文件目录（out_dir或sync_dir），创建plot_file</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Prepare output directories and fds. */</span>

EXP_ST <span class="token keyword">void</span> <span class="token function">setup_dirs_fds</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> tmp<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Setting up output directories..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>sync_dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span>
  <span class="token comment">//如果sync_id存在，则创建sync_dir目录，赋予读写执行权限</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//创建失败error != EEXIST时抛出异常</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//创建out_dir,赋予读写执行权限</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果error!=EEXIST，抛出异常</span>

    <span class="token function">maybe_delete_out_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用函数</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果out_dir没有被创建成功</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span><span class="token comment">//如果设置了in_place_resume，抛出异常</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Resume attempted but old output directory not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    out_dir_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//以只读的方式打开out_dir,返回out_put句柄</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__sun  </span><span class="token comment">//如果没有定义宏__sun</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_dir_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">flock</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">,</span> LOCK_EX <span class="token operator">|</span> LOCK_NB<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//如果打开打开out_dir失败，或者为out_dir通过flock()函数创建互斥锁定失败，抛出异常</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to flock() output directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* !__sun */</span></span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Queue directory for any starting &amp; discovered paths. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/queue目录，权限读写执行</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Top-level directory for queue metadata used for session
     resume and related tasks. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/queue/.state/目录，权限读写执行</span>
  <span class="token comment">//该目录用于保存session resume和tasks的队列元元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Directory for flagging queue entries that went through
     deterministic fuzzing in the past. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/deterministic_done/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/queue/.state/deterministic_done/目录，权限读写执行</span>
  <span class="token comment">//该目录标记过去经历过deterministic fuzzing的队列条目</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Directory with the auto-selected dictionary entries. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/auto_extras/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/queue/.state/auto_extras/目录，权限读写执行</span>
  <span class="token comment">//该目录用于保存带有自动选择的字典条目</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* The set of paths currently deemed redundant. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/redundant_edges/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/queue/.state/redundant_edges/，权限读写执行</span>
  <span class="token comment">//该目录保存被认为是多余的路径集</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* The set of paths showing variable behavior. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/variable_behavior/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/queue/.state/variable_behavior/,权限读写执行</span>
  <span class="token comment">//该目录保存不同行为的路径集</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Sync directory for keeping track of cooperating fuzzers. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.synced/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建out_dir/.synced/目录，权限读写执行</span>
    <span class="token comment">//该目录用于跟踪cooperating fuzzers</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_place_resume <span class="token operator">||</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* All recorded crashes. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/crashes,权限读写执行</span>
  <span class="token comment">//该目录用于记录crash</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* All recorded hangs. */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建out_dir/hangs，权限读写执行</span>
  <span class="token comment">//该目录用于记录hangs</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Generally useful file descriptors. */</span>

  dev_null_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//尝试以读写方式打开/dev/null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_null_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open /dev/null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  dev_urandom_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//尝试以读写方式打开/dev/urandom</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_urandom_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open /dev/urandom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Gnuplot output file. 建立Gnuplot目录 */</span>

  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/plot_data"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//以只写方式打开out_dir/plot_data文件</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果文件不存在就创建，返回句柄fd</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  plot_file <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//根据句柄获得FILE结构体指针plot_file</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plot_file<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">,</span> <span class="token string">"# unix_time, cycles_done, cur_path, paths_total, "</span>
                     <span class="token string">"pending_total, pending_favs, map_size, unique_crashes, "</span>
                     <span class="token string">"unique_hangs, max_depth, execs_per_sec\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//向plot_file写入unix_time, cycles_done, cur_path, paths_total，</span>
  <span class="token comment">//pending_total, pending_favs, map_size, unique_crashes,</span>
  <span class="token comment">//unique_hangs, max_depth, execs_per_sec</span>
                     <span class="token comment">/* ignore errors */</span>

<span class="token punctuation">&#125;</span></code></pre>





<h4 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases"></a>read_testcases</h4><p>从输入读取测试用例入列，在启动时调用</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">long</span> d_ino<span class="token punctuation">;</span> 				<span class="token comment">//索引节点号</span>
	<span class="token class-name">off_t</span> d_off<span class="token punctuation">;</span> 				<span class="token comment">//在目录文件中的偏移</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span> 	<span class="token comment">//文件名长</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> d_type<span class="token punctuation">;</span> 		<span class="token comment">//文件类型</span>
	<span class="token keyword">char</span> d_name <span class="token punctuation">[</span>NAME_MAX<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 	<span class="token comment">//文件名，最长255字节</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">/* Read all testcases from the input directory, then queue them for testing.
   Called at startup. */</span>
<span class="token comment">/*从输入(input)读取测试用例并入队，在启动时调用*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_testcases</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token operator">*</span>nl<span class="token punctuation">;</span>
  s32 nl_cnt<span class="token punctuation">;</span>
  u32 i<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> fn<span class="token punctuation">;</span>

  <span class="token comment">/* Auto-detect non-in-place resumption attempts.
  自动检测非原位恢复尝试 */</span>

  fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//fn："in_dir/queue"</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> in_dir <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//access()函数检查in_dir/queue是否存在(F_OK表示文件或目录是否存在)</span>
  <span class="token comment">//如果满足要检查的权限==》路径存在，返回0  /   不存在返回-1</span>
  <span class="token comment">//如果存在in_dir/queue目录==》设置in_dir为"in_dir/queue"</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Scanning '%s'..."</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* We use scandir() + alphasort() rather than readdir() because otherwise,
     the ordering  of test cases would vary somewhat randomly and would be
     difficult to control. */</span>
  <span class="token comment">/*调用scandir扫描in_dir，并将扫描结果排序后放在dirnet结构体变量nl中
  匹配到的文件个数存储在nl_cnt中
  不使用readdir==》测试用例的顺序会随机变化
  */</span>
  nl_cnt <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nl<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> alphasort<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nl_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果没有扫描到匹配文件</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOENT <span class="token operator">||</span> errno <span class="token operator">==</span> ENOTDIR<span class="token punctuation">)</span>

      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"The input directory does not seem to be valid - try again. The fuzzer needs\n"</span>
           <span class="token string">"    one or more test case to start with - ideally, a small file under 1 kB\n"</span>
           <span class="token string">"    or so. The cases must be stored as regular files directly in the input\n"</span>
           <span class="token string">"    directory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shuffle_queue <span class="token operator">&amp;&amp;</span> nl_cnt <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果设置了shuffle_queue并且扫描有结果</span>

    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Shuffling queue..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">shuffle_ptrs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>nl<span class="token punctuation">,</span> nl_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使用shuffle_ptrs函数将nl指针数组进行跟跌</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8<span class="token operator">*</span> dfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.state/deterministic_done/%s"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    u8  passed_det <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* not tracked */</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lstat</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//从fn获取的文件信息保存在st中，检测目录是否可以访问，不能访问抛异常</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to access '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* This also takes care of . and .. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token punctuation">.</span>st_size <span class="token operator">||</span> <span class="token function">strstr</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"/README.testcases"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//S_ISREG查看st.st_mode确定文件属性，st.st_size确定文件大小</span>
      <span class="token comment">//strstr(fn, "/README.testcases")匹配是否是"/README.testcases"</span>
      <span class="token comment">//排除干扰文件，如.或..或README</span>

      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>dfn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">></span> MAX_FILE<span class="token punctuation">)</span> 
    <span class="token comment">//如果是有效文件，检查文件大小是否超多规定值界限默认1024*1024，即1M</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' is too big (%s, limit is %s)"</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span>
            <span class="token function">DMS</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DMS</span><span class="token punctuation">(</span>MAX_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Check for metadata that indicates that deterministic fuzzing
       is complete for this entry. We don't want to repeat deterministic
       fuzzing when resuming aborted scans, because it would be pointless
       and probably very time-consuming. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>dfn<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> passed_det <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//检查dfn是否被创建成功，此检查用来判断是否这个入口已经完成了deterministic fuzzing</span>
    <span class="token comment">//在恢复异常终止时的扫描时不想重新进行deterministic fuzzing</span>
    <span class="token comment">//创建成功设置passwd_det为1</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>dfn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">add_to_queue</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> passed_det<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用add_to_queue将这个文件入队</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">free</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* not tracked */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued_paths<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果没有入队的输入文件，抛异常</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Looks like there are no valid test cases in the input directory! The fuzzer\n"</span>
         <span class="token string">"    needs one or more test case to start with - ideally, a small file under\n"</span>
         <span class="token string">"    1 kB or so. The cases must be stored as regular files directly in the\n"</span>
         <span class="token string">"    input directory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No usable test cases in '%s'"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  last_path_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">//设置last_path_time为0</span>
  queued_at_start <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span>    <span class="token comment">//设置queue_at_start 为 queued_paths</span>

<span class="token punctuation">&#125;</span></code></pre>

<p>scandir()函数原型：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dir<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>namelist<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>select<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>compar<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>一参：dir代表要扫描的路径</p>
<p>二参：扫描结果放在namelist列表中，每一项都是一个dirent</p>
<p>三参：select适用于过滤的函数，对于一参进行过滤</p>
<p>四参：compar将过滤后的结果进行排序</p>
<h4 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto"></a>load_auto</h4><p>load自动生成的提取出来的词典token</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Load automatically generated extras. 加载自动生成的额外文件 */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">load_auto</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> USE_AUTO_EXTRAS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//循环</span>

    u8  tmp<span class="token punctuation">[</span>MAX_AUTO_EXTRA <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.state/auto_extras/auto_%06u"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s32 fd<span class="token punctuation">,</span> len<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//以只读模式打开fn句柄获得句柄fd</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果打不开，抛异常</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ENOENT<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* We read one byte more to cheaply detect tokens that are too
       long (and skip them). */</span>

    len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> MAX_AUTO_EXTRA <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果能打开，从fd指针读取MAX_AUTO_EXTRA+1个字节到tmp数组中</span>
    <span class="token comment">//MAX_AUTO_EXTRA默认为32，+1字节判断是否读取的token过长，len为read读取长度</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read from '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//未读取成功，抛出异常</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> MIN_AUTO_EXTRA <span class="token operator">&amp;&amp;</span> len <span class="token operator">&lt;=</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span>
    <span class="token comment">//如果读取长度在MIN_AUTO_EXTRA(默认3)和MAX_AUTO_EXTRA(默认32)之间</span>
    <span class="token comment">//调用maybe_add_auto</span>
      <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Loaded %u auto-discovered dictionary tokens."</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"No auto-generated dictionary tokens to reuse."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="maybe-add-auto"><a href="#maybe-add-auto" class="headerlink" title="maybe_add_auto"></a>maybe_add_auto</h4><p>处理extras数组，判断是否添加新的a_extras[]数组项</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Maybe add automatic extra. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//men为读取的auto extro文件，len为对应的长度</span>

  u32 i<span class="token punctuation">;</span>

  <span class="token comment">/* Allow users to specify that they don't want auto dictionaries. 
  允许用户指定他们不想要生成字典*/</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MAX_AUTO_EXTRAS <span class="token operator">||</span> <span class="token operator">!</span>USE_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">//如果用户设置了MAX_AUTO_EXTRAS和USE_AUTO_EXTRAS为0，直接返回</span>

  <span class="token comment">/* Skip runs of identical bytes. 跳过相同字节的运行*/</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//从mem[1]开始遍历</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> mem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> 
    <span class="token comment">//跳过与mem[0]相同的字节，索引i停止在第一个与mem[0]不同的位置</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> len<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">//如果mem中所有的字节都相同，直接跳出函数</span>

  <span class="token comment">/* Reject builtin interesting values. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果len长度为2</span>

    i <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token comment">//让mem与interesting_16[]数组中的元素进行比较</span>
    <span class="token comment">//如果有相同，直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> interesting_16<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span>
          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果len长度为4</span>

    i <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span>  <span class="token comment">//让mem与interesting_32进行比较</span>
    <span class="token comment">//如果有相同，直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> interesting_32<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span>
          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Reject anything that matches existing extras. Do a case-insensitive
     match. We optimize by exploiting the fact that extras[] are sorted
     by size. */</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extras_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token comment">//由于extras数组保存元素的顺序时从小到大==》依次遍历比较长度==》</span>
  <span class="token comment">//直接在相同的位置进行比较</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">>=</span> len<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extras_cnt <span class="token operator">&amp;&amp;</span> extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">==</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">memcmp_nocase</span><span class="token punctuation">(</span>extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">//与extras[]数组中已经存放extras相比，相等就直接返回</span>

  <span class="token comment">/* Last but not least, check a_extras[] for matches. There are no
     guarantees of a particular sort order. */</span>

  auto_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//设置auto_changed为1</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a_extras_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历a_extras数组</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">memcmp_nocase</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//比较a_extras[i].data与mem是否相同</span>

      a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hit_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">//如果相同a_extras[i].hit.cut命中次数+1</span>
      <span class="token comment">//==》代表预料中被使用的次数</span>
      <span class="token keyword">goto</span> sort_a_extras<span class="token punctuation">;</span> <span class="token comment">//跳转至sort_a_extras</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* At this point, looks like we're dealing with a new entry. So, let's
     append it if we have room. Otherwise, let's randomly evict some other
     entry from the bottom half of the list. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">&lt;</span> MAX_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果a_extras_cut小于MAX_AUTO_EXTRAS（默认USE_AUTO_EXTRAS * 10）</span>
    <span class="token comment">//说明a_extras_cut未满，需要构造一个新项放进a_extras数组中</span>

    a_extras <span class="token operator">=</span> <span class="token function">ck_realloc_block</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span>
                                <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//调整a_extras_cut未a_extras_cut+1</span>

    a_extras<span class="token punctuation">[</span>a_extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">ck_memdup</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//a_extras[a_extras_cnt].data设置为mem</span>
    a_extras<span class="token punctuation">[</span>a_extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>len  <span class="token operator">=</span> len<span class="token punctuation">;</span>
    <span class="token comment">//a_extras[a_extras_cnt].len设置为len</span>
    a_extras_cnt<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//a_extras_cut计数+1</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果a_extras已经填满了</span>

    i <span class="token operator">=</span> MAX_AUTO_EXTRAS <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span>
        <span class="token function">UR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MAX_AUTO_EXTRAS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取一个随机数i</span>

    <span class="token function">ck_free</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//随机替换掉一个a_extras[i].data</span>

    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data    <span class="token operator">=</span> <span class="token function">ck_memdup</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//替换成mem</span>
    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len     <span class="token operator">=</span> len<span class="token punctuation">;</span>   <span class="token comment">//长度替换成len</span>
    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hit_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//hit_cnt替换成0</span>

  <span class="token punctuation">&#125;</span>

sort_a_extras<span class="token operator">:</span>

  <span class="token comment">/* First, sort all auto extras by use count, descending order. */</span>

  <span class="token function">qsort</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        compare_extras_use_d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//按照使用次数，降序对所有a_extras[i]进行排序</span>

  <span class="token comment">/* Then, sort the top USE_AUTO_EXTRAS entries by size. */</span>

  <span class="token function">qsort</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>USE_AUTO_EXTRAS<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compare_extras_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//按size对a_extras中前USE_AUTO_EXTRAS个进行排序(默认50)</span>
<span class="token punctuation">&#125;</span></code></pre>



<h4 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h4><p>为input中的测试用例创建硬链接</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Create hard links for input test cases in the output directory, choosing
   good names and pivoting accordingly. */</span>
<span class="token comment">//为input中的测试用例创建硬链接</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">pivot_inputs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span> <span class="token comment">//创建fuzzing队列结构体queue</span>
  u32 id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Creating hard links for all input files..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u8  <span class="token operator">*</span>nfn<span class="token punctuation">,</span> <span class="token operator">*</span>rsl <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将测试用例文件名称赋给rsl</span>
    u32 orig_id<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rsl<span class="token punctuation">)</span> rsl <span class="token operator">=</span> q<span class="token operator">-></span>fname<span class="token punctuation">;</span> <span class="token keyword">else</span> rsl<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">//如果没有获取文件名称</span>
    <span class="token comment">//将用例文件路径赋给rsl</span>

    <span class="token comment">/* If the original file name conforms to the syntax and the recorded
       ID matches the one we'd assign, just use the original file name.
       This is valuable for resuming fuzzing runs. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES  </span><span class="token comment">//如果没有定义SIMPLE_FILES(单文件)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">CASE_PREFIX</span> <span class="token string">"id:"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">CASE_PREFIX</span> <span class="token string">"id_"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>rsl<span class="token punctuation">,</span> CASE_PREFIX<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>rsl <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>orig_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> orig_id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">/*比较rsl前三个字节如果是CASE_OREFIX，并且可以将CASE_PREFIX之后的数组(id)以格式化
          "%06u"的形式写入orig_id,并且orig_id == id*/</span>

      u8<span class="token operator">*</span> src_str<span class="token punctuation">;</span>
      u32 src_id<span class="token punctuation">;</span>

      resuming_fuzz <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置resuming_fuzz为1</span>
      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> rsl<span class="token punctuation">)</span><span class="token punctuation">;</span>


      <span class="token comment">/* Since we're at it, let's also try to find parent and figure out the
         appropriate depth for this entry. */</span>

      src_str <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>rsl <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//搜索第一次出现":"之后的字符串</span>
      <span class="token comment">//保存在src_str中</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>src_str <span class="token operator">&amp;&amp;</span> <span class="token function">sscanf</span><span class="token punctuation">(</span>src_str <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果获取到src_str,并且能够以格式化"%06u"的形式写入src_id中</span>

        <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> s <span class="token operator">=</span> queue<span class="token punctuation">;</span>  <span class="token comment">//创建queue_entry结构体指针s</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>src_id<span class="token operator">--</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">)</span> s <span class="token operator">=</span> s<span class="token operator">-></span>next<span class="token punctuation">;</span>  <span class="token comment">//从指针s从头开始扫描，没扫描一个元素，src_id--</span>
        <span class="token comment">//s后移到下一个元素</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> q<span class="token operator">-></span>depth <span class="token operator">=</span> s<span class="token operator">-></span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//src_id--至0，并且s队列中还有数值</span>
        <span class="token comment">//队列深度+1</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>max_depth <span class="token operator">&lt;</span> q<span class="token operator">-></span>depth<span class="token punctuation">)</span> max_depth <span class="token operator">=</span> q<span class="token operator">-></span>depth<span class="token punctuation">;</span>
        <span class="token comment">//判断队列深度是否超过最大深度</span>
        <span class="token comment">//如果超过，则指定最大深度</span>

      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果不是以CASE_PREFIX开头</span>

      <span class="token comment">/* No dice - invent a new name, capturing the original one as a
         substring. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES   </span><span class="token comment">//如果没有定义SIMPLE_FILES(单文件)</span></span>

      u8<span class="token operator">*</span> use_name <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>rsl<span class="token punctuation">,</span> <span class="token string">",orig:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检测srl是否存在",orig:"为前缀的字符串</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>use_name<span class="token punctuation">)</span> use_name <span class="token operator">+=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token keyword">else</span> use_name <span class="token operator">=</span> rsl<span class="token punctuation">;</span>
      <span class="token comment">//存在前缀，取后面的字符串赋值给use_name</span>
      <span class="token comment">//如果没有则use_name被赋值为rsl</span>
      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id:%06u,orig:%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> id<span class="token punctuation">,</span> use_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//nfn：out_dir/queue/id:000000,orig:a.txt(id为0为例)</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token comment">//如果定义了SIMPLE_FILES(单文件)</span></span>

      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//拼接</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Pivot to the new queue entry. */</span>

    <span class="token function">link_or_copy</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> nfn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用link_or_copy创建硬链接   q->fname到nfn</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    q<span class="token operator">-></span>fname <span class="token operator">=</span> nfn<span class="token punctuation">;</span>   <span class="token comment">//重新对队列中这一元素的fname进行赋值为nfn</span>

    <span class="token comment">/* Make sure that the passed_det value carries over, too. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>passed_det<span class="token punctuation">)</span> <span class="token function">mark_as_det_done</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果设置了q->passed_det为1</span>
    <span class="token comment">//调用mark_as_det_done函数标记queue这一项已经fuzz过了</span>
    <span class="token comment">//保持q->passed_det为1</span>

    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>   <span class="token comment">//指向下一个队列元素</span>
    id<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment">//id增加</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> <span class="token function">nuke_resume_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//遍历结束后增加检查in_place_resume</span>
  <span class="token comment">//如果设置了，调用nuke_resume_dir删除output/_resume/*临时目录，该目录主要用于本地临时恢复</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h4><p>如果定义了extras_dir,从extras_dir读取extras到extras数组里，并按size排序</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Read extras from the extras directory and sort them by size. */</span>
<span class="token comment">//从extras_dir读取extras到extras数组里，并按size排序</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">load_extras</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> dir<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  DIR<span class="token operator">*</span> d<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> de<span class="token punctuation">;</span>
  u32 min_len <span class="token operator">=</span> MAX_DICT_FILE<span class="token punctuation">,</span> max_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dict_level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u8<span class="token operator">*</span> x<span class="token punctuation">;</span>

  <span class="token comment">/* If the name ends with @, extract level and continue. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token char">'@'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检测dir目录中是否存在@字符</span>

    <span class="token operator">*</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//如果有的话替换为空字节</span>
    dict_level <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//将@后面的字符以int形式赋值给dict_level变量</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Loading extra dictionary from '%s' (level %u)..."</span><span class="token punctuation">,</span> dir<span class="token punctuation">,</span> dict_level<span class="token punctuation">)</span><span class="token punctuation">;</span>

  d <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//打开dir路径</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//打开失败</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOTDIR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果报错为ENOTDIR，表示这不是一个目录文件</span>
      <span class="token function">load_extras_file</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_len<span class="token punctuation">,</span> dict_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> check_and_sort<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//报错不为ENOTDIR，直接抛异常</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Dictionary levels not supported for directories."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>de <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//循环扫描并读取目录下的文件到extras[]中，按照size大小排序</span>

    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>
    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> dir<span class="token punctuation">,</span> de<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s32 fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lstat</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to access '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* This also takes care of . and .. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">></span> MAX_DICT_FILE<span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Extra '%s' is too big (%s, limit is %s)"</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span>
            <span class="token function">DMS</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DMS</span><span class="token punctuation">(</span>MAX_DICT_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>min_len <span class="token operator">></span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span> min_len <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>max_len <span class="token operator">&lt;</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span> max_len <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>

    extras <span class="token operator">=</span> <span class="token function">ck_realloc_block</span><span class="token punctuation">(</span>extras<span class="token punctuation">,</span> <span class="token punctuation">(</span>extras_cnt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span>
               <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    extras<span class="token punctuation">[</span>extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    extras<span class="token punctuation">[</span>extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>len  <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    extras_cnt<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">closedir</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

check_and_sort<span class="token operator">:</span>   <span class="token comment">//检查token的size</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extras_cnt<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No usable files in '%s'"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">qsort</span><span class="token punctuation">(</span>extras<span class="token punctuation">,</span> extras_cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compare_extras_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Loaded %u extra tokens, size range %s to %s."</span><span class="token punctuation">,</span> extras_cnt<span class="token punctuation">,</span>
      <span class="token function">DMS</span><span class="token punctuation">(</span>min_len<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DMS</span><span class="token punctuation">(</span>max_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>max_len <span class="token operator">></span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Some tokens are relatively large (%s) - consider trimming."</span><span class="token punctuation">,</span>
          <span class="token function">DMS</span><span class="token punctuation">(</span>max_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>extras_cnt <span class="token operator">></span> MAX_DET_EXTRAS<span class="token punctuation">)</span>
    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"More than %u tokens - will use them probabilistically."</span><span class="token punctuation">,</span>
          MAX_DET_EXTRAS<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="find-timeout"><a href="#find-timeout" class="headerlink" title="find_timeout"></a>find_timeout</h4><p>当恢复本地会话时没有使用参数-t参数进行设置，防止不停调整超过时间</p>
<p>调用此函数需判断timeout_given变量是否进行设置，如果没有设置，调用本函数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* The same, but for timeouts. The idea is that when resuming sessions without
   -t given, we don't want to keep auto-scaling the timeout over and over
   again to prevent it from growing due to random flukes. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_timeout</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 tmp<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Ought to be enough for anybody. */</span>

  u8  <span class="token operator">*</span>fn<span class="token punctuation">,</span> <span class="token operator">*</span>off<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  u32 ret<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resuming_fuzz<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">//如果没有设置resuming_fuzz，直接return</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/fuzzer_stats"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果设置了in_place_resume为1</span>
  <span class="token comment">//fn:out_dir/fuzzer_stats</span>
  <span class="token keyword">else</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/../fuzzer_stats"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果没有设置</span>
  <span class="token comment">//fn：in_dir/../fuzzer_stats</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//以只读的模式打开fn</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token comment">//如果没打开直接返回</span>

  i <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>
  <span class="token comment">//读取文件内容到tmp[4096]中</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  off <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"exec_timeout      : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//在tmp中查找字符串"exec_timeout      : "</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>off<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token comment">//没找到直接返回</span>

  ret <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>off <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//读取这个timeout值给ret</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token comment">//如果timeout值小于等于4，直接退出</span>

  exec_tmout <span class="token operator">=</span> ret<span class="token punctuation">;</span>   <span class="token comment">//如果大于4，赋值给exec_tmout变量</span>
  timeout_given <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>   <span class="token comment">//timeout_given设置为3</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h4><p>检查输入argv中是否存在@@，替换成out_dir&#x2F;.cur_input</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Detect @@ in args. */</span>

EXP_ST <span class="token keyword">void</span> <span class="token function">detect_file_args</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u8<span class="token operator">*</span> cwd <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//获取当前工作目录的绝对路径</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cwd<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"getcwd() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果没有获取到，抛出异常</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//遍历输入的参数</span>

    u8<span class="token operator">*</span> aa_loc <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"@@"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查找本次循环中参数是否存在@@，找到了就将其位置放在aa_loc中</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>aa_loc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果存在</span>

      u8 <span class="token operator">*</span>aa_subst<span class="token punctuation">,</span> <span class="token operator">*</span>n_arg<span class="token punctuation">;</span>

      <span class="token comment">/* If we don't have a file name chosen yet, use a safe default. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_file<span class="token punctuation">)</span>    <span class="token comment">//如果没有设置out_file</span>
        out_file <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.cur_input"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//赋值out_file为路径：out_dir/.cur_input</span>

      <span class="token comment">/* Be sure that we're always using fully-qualified paths. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> aa_subst <span class="token operator">=</span> out_file<span class="token punctuation">;</span>
      <span class="token comment">//判断路径是否以/开始</span>
      <span class="token comment">//如果是，则直接赋值给aa_subst变量</span>
      <span class="token keyword">else</span> aa_subst <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> cwd<span class="token punctuation">,</span> out_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果不是以/开始，则直接拼接绝对路径</span>

      <span class="token comment">/* Construct a replacement argv value. */</span>

      <span class="token operator">*</span>aa_loc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//将当前@@替换成空字符</span>
      n_arg <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s%s%s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> aa_subst<span class="token punctuation">,</span> aa_loc <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//跳过aal_loc两个字节进行拼接</span>
      argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> n_arg<span class="token punctuation">;</span>   <span class="token comment">//n_arg:out_dir/.cur_input</span>
      <span class="token operator">*</span>aa_loc <span class="token operator">=</span> <span class="token char">'@'</span><span class="token punctuation">;</span>   <span class="token comment">//将当前位置替换为@</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token function">ck_free</span><span class="token punctuation">(</span>aa_subst<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    i<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">free</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* not tracked */</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="setup-stdio-file"><a href="#setup-stdio-file" class="headerlink" title="setup_stdio_file"></a>setup_stdio_file</h4><p>如果没有设置out_file，调用该函数，如果没有使用-f，删除原本的out_dir&#x2F;.cur_input</p>
<p>创建一个新的out_dir&#x2F;.cur_input，保存其文件描述符在out_fd中</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Setup the output file for fuzzed data, if not using -f. */</span>

EXP_ST <span class="token keyword">void</span> <span class="token function">setup_stdio_file</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.cur_input"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//fn： out_dir/.cur_input</span>

  <span class="token function">unlink</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

  out_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//删除原本的out_dir/.cur_input，创建新的，将文件描述符交给out_fd</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>out_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//open失败，抛出异常</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="check-binary"><a href="#check-binary" class="headerlink" title="check_binary"></a>check_binary</h4><p>检查指定路径要执行的程序是否存在，是否为shell脚本，同时检查elf文件头是否合法及程序是否被插桩</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Do a PATH search and find target binary to see that it exists and
   isn't a shell script - a common and painful mistake. We also check for
   a valid ELF header and for evidence of AFL instrumentation. */</span>

EXP_ST <span class="token keyword">void</span> <span class="token function">check_binary</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> fname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> env_path <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

  s32 fd<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> f_data<span class="token punctuation">;</span>
  u32 f_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Validating target binary..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strchr</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>env_path <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"PATH"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    target_path <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token number">0111</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>f_len <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Program '%s' not found or not executable"</span><span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>env_path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      u8 <span class="token operator">*</span>cur_elem<span class="token punctuation">,</span> <span class="token operator">*</span>delim <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>env_path<span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>delim<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        cur_elem <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>delim <span class="token operator">-</span> env_path <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>cur_elem<span class="token punctuation">,</span> env_path<span class="token punctuation">,</span> delim <span class="token operator">-</span> env_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        delim<span class="token operator">++</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> cur_elem <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>env_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

      env_path <span class="token operator">=</span> delim<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_elem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        target_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> cur_elem<span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        target_path <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">ck_free</span><span class="token punctuation">(</span>cur_elem<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">stat</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token number">0111</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>f_len <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token function">ck_free</span><span class="token punctuation">(</span>target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      target_path <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target_path<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Program '%s' not found or not executable"</span><span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SKIP_BIN_CHECK"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">/* Check for blatant user errors. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> <span class="token string">"/tmp/"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strchr</span><span class="token punctuation">(</span>target_path <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> <span class="token string">"/var/tmp/"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strchr</span><span class="token punctuation">(</span>target_path <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Please don't keep binaries in /tmp or /var/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  f_data <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>f_data <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to mmap file '%s'"</span><span class="token punctuation">,</span> target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>f_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">&amp;&amp;</span> f_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Oops, the target binary looks like a shell script. Some build systems will\n"</span>
         <span class="token string">"    sometimes generate shell stubs for dynamically linked programs; try static\n"</span>
         <span class="token string">"    library mode (./configure --disable-shared) if that's the case.\n\n"</span>

         <span class="token string">"    Another possible cause is that you are actually trying to use a shell\n"</span> 
         <span class="token string">"    wrapper around the fuzzed component. Invoking shell can slow down the\n"</span> 
         <span class="token string">"    fuzzing process by a factor of 20x or more; it's best to write the wrapper\n"</span>
         <span class="token string">"    in a compiled language instead.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Program '%s' is a shell script"</span><span class="token punctuation">,</span> target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__APPLE__</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>f_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0x7f</span> <span class="token operator">||</span> <span class="token function">memcmp</span><span class="token punctuation">(</span>f_data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ELF"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Program '%s' is not an ELF binary"</span><span class="token punctuation">,</span> target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>f_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0xCF</span> <span class="token operator">||</span> f_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0xFA</span> <span class="token operator">||</span> f_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0xED</span><span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Program '%s' is not a 64-bit Mach-O binary"</span><span class="token punctuation">,</span> target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!__APPLE__ */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qemu_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token function">memmem</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> SHM_ENV_VAR<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>SHM_ENV_VAR<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Looks like the target binary is not instrumented! The fuzzer depends on\n"</span>
         <span class="token string">"    compile-time instrumentation to isolate interesting test cases while\n"</span>
         <span class="token string">"    mutating the input data. For more information, and for tips on how to\n"</span>
         <span class="token string">"    instrument binaries, please see %s/README.\n\n"</span>

         <span class="token string">"    When source code is not available, you may be able to leverage QEMU\n"</span>
         <span class="token string">"    mode support. Consult the README for tips on how to enable this.\n"</span>

         <span class="token string">"    (It is also possible to use afl-fuzz as a traditional, \"dumb\" fuzzer.\n"</span>
         <span class="token string">"    For that, you can use the -n option - but expect much worse results.)\n"</span><span class="token punctuation">,</span>
         doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No instrumentation detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode <span class="token operator">&amp;&amp;</span>
      <span class="token function">memmem</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> SHM_ENV_VAR<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>SHM_ENV_VAR<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"This program appears to be instrumented with afl-gcc, but is being run in\n"</span>
         <span class="token string">"    QEMU mode (-Q). This is probably not what you want - this setup will be\n"</span>
         <span class="token string">"    slow and offer no practical benefits.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Instrumentation found in -Q mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memmem</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> <span class="token string">"libasan.so"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token function">memmem</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> <span class="token string">"__msan_init"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> uses_asan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">/* Detect persistent &amp; deferred init signatures in the binary. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memmem</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> PERSIST_SIG<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>PERSIST_SIG<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">OKF</span><span class="token punctuation">(</span>cPIN <span class="token string">"Persistent mode binary detected."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span>PERSIST_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    persistent_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PERSISTENT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"AFL_PERSISTENT is no longer supported and may misbehave!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memmem</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">,</span> DEFER_SIG<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>DEFER_SIG<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">OKF</span><span class="token punctuation">(</span>cPIN <span class="token string">"Deferred forkserver binary detected."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span>DEFER_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    deferred_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DEFER_FORKSRV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"AFL_DEFER_FORKSRV is no longer supported and may misbehave!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">munmap</span><span class="token punctuation">(</span>f_data<span class="token punctuation">,</span> f_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"unmap() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="get-cur-time"><a href="#get-cur-time" class="headerlink" title="get_cur_time"></a>get_cur_time</h4><p>以毫秒为单位获取unix时间</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Get unix time in milliseconds */</span>

<span class="token keyword">static</span> u64 <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">timezone</span> tz<span class="token punctuation">;</span>

  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>tv<span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> <span class="token number">1000ULL</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>tv<span class="token punctuation">.</span>tv_usec <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h4><p>执行所有的测试用例，以检查是否按照预期工作</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Perform dry run of all test cases to confirm that the app is working as
   expected. This is done only for the initial inputs, and only once. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">perform_dry_run</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  u32 cal_failures <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u8<span class="token operator">*</span> skip_crashes <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SKIP_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//循环队列</span>

    u8<span class="token operator">*</span> use_mem<span class="token punctuation">;</span>
    u8  res<span class="token punctuation">;</span>
    s32 fd<span class="token punctuation">;</span>

    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//获取测试用例名称，以a.txt为例</span>
    <span class="token comment">//fn：id:000000,orig:a.txt</span>

    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Attempting dry run with '%s'..."</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//以只读模式尝试打开测试用例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//打开失败，抛出异常</span>

    use_mem <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建q->len大小的内存空间，内存指针赋给use_mem变量</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> use_mem<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token operator">!=</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span>  <span class="token comment">//将测试用例文件中的内容读进use_mem中</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Short read from '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//没有成功，抛出异常</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> q<span class="token punctuation">,</span> use_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//校准测试用例</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>use_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token comment">//如果设置了stop_soon，直接返回</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> crash_mode <span class="token operator">||</span> res <span class="token operator">==</span> FAULT_NOBITS<span class="token punctuation">)</span>  <span class="token comment">//如果res结果为crash_mode或者FAULT_NOBITS</span>
      <span class="token function">SAYF</span><span class="token punctuation">(</span>cGRA <span class="token string">"    len = %u, map size = %u, exec speed = %llu us\n"</span> cRST<span class="token punctuation">,</span> 
           q<span class="token operator">-></span>len<span class="token punctuation">,</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">,</span> q<span class="token operator">-></span>exec_us<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//打印q->len, q->bitmap_size, q->exec_us</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//进入switch大循环判断res错误类型</span>

      <span class="token keyword">case</span> FAULT_NONE<span class="token operator">:</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> queue<span class="token punctuation">)</span> <span class="token function">check_map_coverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果q是第一个测试用例，调用check_map_coverage函数==》评估覆盖率</span>
        <span class="token comment">//计数trace_bits发现的路径数，如果小于100，直接返回</span>
        <span class="token comment">//在ttrace_bits的数组后半段，如果有值就直接返回</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' does *NOT* crash"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果设置了crash_mode，抛出异常</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_TMOUT<span class="token operator">:</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//如果指定了-t参数</span>

          <span class="token comment">/* The -t nn+ syntax in the command line sets timeout_given to '2' and
             instructs afl-fuzz to tolerate but skip queue entries that time
             out. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Test case results in a timeout (skipping)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            q<span class="token operator">-></span>cal_failed <span class="token operator">=</span> CAL_CHANCES<span class="token punctuation">;</span>   <span class="token comment">//设置q->cal_failed为CAL_CHANCES</span>
            cal_failures<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment">//cal_failures计数+1</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token string">"The program took more than %u ms to process one of the initial test cases.\n"</span>
               <span class="token string">"    Usually, the right thing to do is to relax the -t option - or to delete it\n"</span>
               <span class="token string">"    altogether and allow the fuzzer to auto-calibrate. That said, if you know\n"</span>
               <span class="token string">"    what you are doing and want to simply skip the unruly test cases, append\n"</span>
               <span class="token string">"    '+' at the end of the value passed to -t ('-t %u+').\n"</span><span class="token punctuation">,</span> exec_tmout<span class="token punctuation">,</span>
               exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a timeout"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token string">"The program took more than %u ms to process one of the initial test cases.\n"</span>
               <span class="token string">"    This is bad news; raising the limit with the -t option is possible, but\n"</span>
               <span class="token string">"    will probably make the fuzzing process extremely slow.\n\n"</span>

               <span class="token string">"    If this test case is just a fluke, the other option is to just avoid it\n"</span>
               <span class="token string">"    altogether, and find one that is less of a CPU hog.\n"</span><span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a timeout"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>

      <span class="token keyword">case</span> FAULT_CRASH<span class="token operator">:</span>  

        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">//如果设置了crash_mod，直接break</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_crashes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//如果设置了skip_crash</span>
          <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Test case results in a crash (skipping)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          q<span class="token operator">-></span>cal_failed <span class="token operator">=</span> CAL_CHANCES<span class="token punctuation">;</span>  <span class="token comment">//设置q->cal_failed为CAL_CHANCES</span>
          cal_failures<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">//cal_failures计数+1</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果设置了mem_limit，提示内存不足，抛出异常</span>

          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token string">"Oops, the program crashed with one of the test cases provided. There are\n"</span>
               <span class="token string">"    several possible explanations:\n\n"</span>

               <span class="token string">"    - The test case causes known crashes under normal working conditions. If\n"</span>
               <span class="token string">"      so, please remove it. The fuzzer should be seeded with interesting\n"</span>
               <span class="token string">"      inputs - but not ones that cause an outright crash.\n\n"</span>

               <span class="token string">"    - The current memory limit (%s) is too low for this program, causing\n"</span>
               <span class="token string">"      it to die due to OOM when parsing valid files. To fix this, try\n"</span>
               <span class="token string">"      bumping it up with the -m setting in the command line. If in doubt,\n"</span>
               <span class="token string">"      try something along the lines of:\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>
               <span class="token string">"      ( ulimit -Sv $[%llu &lt;&lt; 10]; /path/to/binary [...] &lt;testcase )\n\n"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
               <span class="token string">"      ( ulimit -Sd $[%llu &lt;&lt; 10]; /path/to/binary [...] &lt;testcase )\n\n"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>

               <span class="token string">"      Tip: you can use http://jwilk.net/software/recidivm to quickly\n"</span>
               <span class="token string">"      estimate the required amount of virtual memory for the binary. Also,\n"</span>
               <span class="token string">"      if you are using ASAN, see %s/notes_for_asan.txt.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
  
               <span class="token string">"    - On MacOS X, the semantics of fork() syscalls are non-standard and may\n"</span>
               <span class="token string">"      break afl-fuzz performance optimizations when running platform-specific\n"</span>
               <span class="token string">"      binaries. To fix this, set AFL_NO_FORKSRV=1 in the environment.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

               <span class="token string">"    - Least likely, there is a horrible bug in the fuzzer. If other options\n"</span>
               <span class="token string">"      fail, poke &lt;lcamtuf@coredump.cx> for troubleshooting tips.\n"</span><span class="token punctuation">,</span>
               <span class="token function">DMS</span><span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mem_limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token string">"Oops, the program crashed with one of the test cases provided. There are\n"</span>
               <span class="token string">"    several possible explanations:\n\n"</span>

               <span class="token string">"    - The test case causes known crashes under normal working conditions. If\n"</span>
               <span class="token string">"      so, please remove it. The fuzzer should be seeded with interesting\n"</span>
               <span class="token string">"      inputs - but not ones that cause an outright crash.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
  
               <span class="token string">"    - On MacOS X, the semantics of fork() syscalls are non-standard and may\n"</span>
               <span class="token string">"      break afl-fuzz performance optimizations when running platform-specific\n"</span>
               <span class="token string">"      binaries. To fix this, set AFL_NO_FORKSRV=1 in the environment.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

               <span class="token string">"    - Least likely, there is a horrible bug in the fuzzer. If other options\n"</span>
               <span class="token string">"      fail, poke &lt;lcamtuf@coredump.cx> for troubleshooting tips.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>

        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a crash"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_ERROR<span class="token operator">:</span>
      <span class="token comment">//无法执行目标应用程序</span>

        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application ('%s')"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_NOINST<span class="token operator">:</span>
      <span class="token comment">//样例没有出现任何路径信息</span>

        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No instrumentation detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_NOBITS<span class="token operator">:</span> 

        useless_at_start<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">//useless_at_start计数器+1</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_bitmap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shuffle_queue<span class="token punctuation">)</span>
        <span class="token comment">//如果这个案例有出现路径信息，但是没有出现新的路径，会被认为是一条无效的路径</span>
          <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No new instrumentation output, test case may be useless."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>var_behavior<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Instrumentation output varies across runs."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果这个样例的var_behavior为真==》说明他多次运行，同样的输入条件下，却出现不同的覆盖信息</span>

    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token comment">//指向下一条用例</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//如果设置了cal_failures</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures <span class="token operator">==</span> queued_paths<span class="token punctuation">)</span>   <span class="token comment">//代表所有用例均超时</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"All test cases time out%s, giving up!"</span><span class="token punctuation">,</span>
            skip_crashes <span class="token operator">?</span> <span class="token string">" or crash"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Skipped %u test cases (%0.02f%%) due to timeouts%s."</span><span class="token punctuation">,</span> cal_failures<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>cal_failures<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">/</span> queued_paths<span class="token punctuation">,</span>
          skip_crashes <span class="token operator">?</span> <span class="token string">" or crashes"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">></span> queued_paths<span class="token punctuation">)</span>
    <span class="token comment">//计算cal_failures * 5是否大于queued_paths</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"High percentage of rejected test cases, check settings!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//测试用例的问题比例很高，可能需要重新检查设置</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All test cases processed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h4><p>评估inputs路径下的case是否存在异常行为，在新发现路径时评估testcase的行为是否为可变</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">calibrate_case</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8<span class="token operator">*</span> use_mem<span class="token punctuation">,</span>
                         u32 handicap<span class="token punctuation">,</span> u8 from_queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 first_trace<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//创建first_trace数组</span>

  u8  fault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> new_bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> var_detected <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> hnb <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      first_run <span class="token operator">=</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//q->exec_cksum为0，说明这个case是第一次运行</span>
      <span class="token comment">//即来自input目录下，将first_run变量设置为1</span>

  u64 start_us<span class="token punctuation">,</span> stop_us<span class="token punctuation">;</span>

  s32 old_sc <span class="token operator">=</span> stage_cur<span class="token punctuation">,</span> old_sm <span class="token operator">=</span> stage_max<span class="token punctuation">;</span>
  u32 use_tmout <span class="token operator">=</span> exec_tmout<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> old_sn <span class="token operator">=</span> stage_name<span class="token punctuation">;</span>

  <span class="token comment">/* Be a bit more generous about timeouts when resuming sessions, or when
     trying to calibrate already-added finds. This helps avoid trouble due
     to intermittent latency. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from_queue <span class="token operator">||</span> resuming_fuzz<span class="token punctuation">)</span>
  <span class="token comment">//如果from_queue为0或者resuming_fuzz为1==》</span>
  <span class="token comment">//代表不来自于queue中或者resuming sessions的时候</span>
    use_tmout <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">+</span> CAL_TMOUT_ADD<span class="token punctuation">,</span>
                    exec_tmout <span class="token operator">*</span> CAL_TMOUT_PERC <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//则设置use_tmout的值被设置的很大</span>

  q<span class="token operator">-></span>cal_failed<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">//q->cal_failed记录+1</span>

  stage_name <span class="token operator">=</span> <span class="token string">"calibration"</span><span class="token punctuation">;</span>   <span class="token comment">//stage_name设置为"calibration"</span>
  stage_max  <span class="token operator">=</span> fast_cal <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> CAL_CYCLES<span class="token punctuation">;</span>
  <span class="token comment">//根据判断fast_cal是否为1.来设置stage_max的值为3或者CAL_CYCLES（默认8）</span>

  <span class="token comment">//每个新测试用例以及显示出来可变行为的测试用例的校准周期数，以及本次stage要执行几次</span>

  <span class="token comment">/* Make sure the forkserver is up before we do anything, and let's not
     count its spin-up time toward binary calibration. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>no_forkserver <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>forksrv_pid<span class="token punctuation">)</span>
  <span class="token comment">//如果不是dumb_mode模式或者no_forkserver为0(禁用forkserver)，并且forksrv_pid为0</span>
    <span class="token function">init_forkserver</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用init_forkserver函数启动fork server</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果q->exec_cksum不为空，说明queue不是来自input文件夹，而是评估新的case</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>first_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将trace_bits拷贝至first_trace中</span>
    hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用has_new_bits函数计算，将结果赋值给hnb</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">></span> new_bits<span class="token punctuation">)</span> new_bits <span class="token operator">=</span> hnb<span class="token punctuation">;</span>
    <span class="token comment">//如果新计算结果大于new_bits</span>
    <span class="token comment">//给new_bits重新赋值</span>

  <span class="token punctuation">&#125;</span>

  start_us <span class="token operator">=</span> <span class="token function">get_cur_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//获取当前系统时间</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//循环stage_max次</span>

    u32 cksum<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first_run <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>stage_cur <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果这个queue不是来自input文件夹，而是评估case，并且第一轮calibration stage执行结束</span>
    <span class="token comment">//调用show_stats函数画出界面，用来展示本次执行结果</span>

    <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>use_mem<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//从q->fname中读取内容写到.cur_input中</span>

    fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> use_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//run结果保存在fault中</span>

    <span class="token comment">/* stop_soon is set by the handler for Ctrl+C. When it's pressed,
       we want to bail out quickly. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> fault <span class="token operator">!=</span> crash_mode<span class="token punctuation">)</span> <span class="token keyword">goto</span> abort_calibration<span class="token punctuation">;</span>
    <span class="token comment">//如果出现终止或者fault结果不为crash_mode，跳转到abort_calibration</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stage_cur <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">count_bytes</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果不是dumb_mode模式，并且这是calibration stage为第一次运行</span>
      <span class="token comment">//并且共享内存中没有任何路径</span>
      fault <span class="token operator">=</span> FAULT_NOINST<span class="token punctuation">;</span>   <span class="token comment">//fault被设置为FAULT_NOINST</span>
      <span class="token keyword">goto</span> abort_calibration<span class="token punctuation">;</span>    <span class="token comment">//跳转至abort_calibration</span>
    <span class="token punctuation">&#125;</span>

    cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//hash32计算的32位uint值保存在cksum中</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum <span class="token operator">!=</span> cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果不相等，代表这是第一次运行</span>
      <span class="token comment">//或者在相同参数下，每次运行，cksum却不同</span>
      <span class="token comment">//是一个路径可变的queue</span>

      hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">></span> new_bits<span class="token punctuation">)</span> new_bits <span class="token operator">=</span> hnb<span class="token punctuation">;</span>
      <span class="token comment">//若条件成立，将new_bits赋值为计算结果</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//判断是否可变queue，如果为1，则说明不是第一次执行queue</span>

        u32 i<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>var_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> first_trace<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> trace_bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果first_byts[i]为1，并且不等于trace_bits[i],说明不可变的queue</span>

            var_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//如果var_bytes[i]为空则赋值为1</span>
            stage_max    <span class="token operator">=</span> CAL_CYCLES_LONG<span class="token punctuation">;</span>    <span class="token comment">//设置stage_max为CAL_CYCLES_LONG</span>

          <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>

        var_detected <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//将var_detected为1</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果q->exec_cksum为0，代表第一次执行queue</span>

        q<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> cksum<span class="token punctuation">;</span>   <span class="token comment">//设置q->exec_cksum的值为计算出来的本次执行的cksum</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>first_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将trace_bits拷贝至first_trace中</span>

      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  stop_us <span class="token operator">=</span> <span class="token function">get_cur_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//保存停止时间</span>

  total_cal_us     <span class="token operator">+=</span> stop_us <span class="token operator">-</span> start_us<span class="token punctuation">;</span>  <span class="token comment">//总轮次执行时间存放在total_cal_us中</span>
  total_cal_cycles <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>    <span class="token comment">//总执行轮次放在stage_max中</span>

  <span class="token comment">/* OK, let's collect some stats about the performance of this test case.
     This is used for fuzzing air time calculations in calculate_score(). */</span>

  q<span class="token operator">-></span>exec_us     <span class="token operator">=</span> <span class="token punctuation">(</span>stop_us <span class="token operator">-</span> start_us<span class="token punctuation">)</span> <span class="token operator">/</span> stage_max<span class="token punctuation">;</span>  <span class="token comment">//计算单词执行时间的平均值赋值给q->exec_us</span>
  q<span class="token operator">-></span>bitmap_size <span class="token operator">=</span> <span class="token function">count_bytes</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//最后一次执行所覆盖的路径数赋值给q->bitmap_size</span>
  q<span class="token operator">-></span>handicap    <span class="token operator">=</span> handicap<span class="token punctuation">;</span>
  q<span class="token operator">-></span>cal_failed  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  total_bitmap_size <span class="token operator">+=</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">;</span>   <span class="token comment">//加上这个queue所覆盖到的路径数</span>
  total_bitmap_entries<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* If this case didn't result in new output from the instrumentation, tell
     parent. This is a non-critical problem, but something to warn the user
     about. */</span>
 <span class="token comment">/*如果fault为FAULT_NONE，并且不是dumb_mode模式，并且是第一次运行，
 并且new_bits为0，代表在这个样例所有轮次的执行里，都没有发现新的路径和异常*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> first_run <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fault <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>new_bits<span class="token punctuation">)</span> fault <span class="token operator">=</span> FAULT_NOBITS<span class="token punctuation">;</span>
  <span class="token comment">//设置fault为FAULT_NOBITS</span>

abort_calibration<span class="token operator">:</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_bits <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>q<span class="token operator">-></span>has_new_cov<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//new_bits为2并且q->has_new_cov为空</span>
    q<span class="token operator">-></span>has_new_cov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置q->has_new_cov为1</span>
    queued_with_cov<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//+1==》代表queue发现一条新的路径</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Mark variable paths. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>var_detected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//var_detected为1==》这个queue为一个可变的路径</span>

    var_byte_count <span class="token operator">=</span> <span class="token function">count_bytes</span><span class="token punctuation">(</span>var_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//计算var_bytes里被置位的tuple个数，保存到var_byte_count中，代表tuple具有可变行为</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>var_behavior<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">mark_as_variable</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//创建符号链接out_dir/queue/.state/variable_behavior/fname</span>
      <span class="token comment">//设置queue的var_behavior为1</span>
      queued_variable<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">//queued_variable计数器+1</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  stage_name <span class="token operator">=</span> old_sn<span class="token punctuation">;</span>
  stage_cur  <span class="token operator">=</span> old_sc<span class="token punctuation">;</span>
  stage_max  <span class="token operator">=</span> old_sm<span class="token punctuation">;</span>   <span class="token comment">//恢复之前的stage</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first_run<span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果不是第一次运行这个queue，展示状态</span>

  <span class="token keyword">return</span> fault<span class="token punctuation">;</span>  <span class="token comment">//返回fault值</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init_forkserver"></a>init_forkserver</h4><p>为目标程序创建通信通道，并且通过fork server fork出子进程，判断启动失败的原因</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Spin up fork server (instrumented mode only). The idea is explained here:

   http://lcamtuf.blogspot.com/2014/10/fuzzing-binaries-without-execve.html

   In essence, the instrumentation allows us to skip execve(), and just keep
   cloning a stopped child. So, we just execute once, and then send commands
   through a pipe. The other part of this logic is in afl-as.h. */</span>

EXP_ST <span class="token keyword">void</span> <span class="token function">init_forkserver</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span>
  <span class="token keyword">int</span> st_pipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctl_pipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> status<span class="token punctuation">;</span>
  s32 rlen<span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Spinning up the fork server..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">pipe</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"pipe() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果无法创建管道，抛出异常</span>

  forksrv_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//fork出一个子进程</span>
  <span class="token comment">/*如果fork成功，会出现一个子进程和父进程
  在子进程中fork函数的返回值为0
  在父进程中，fork返回创建的子进程的进程ID*/</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>forksrv_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断是否fork成功</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forksrv_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//判断当前为父进程或者子进程</span>

    <span class="token comment">/*          子进程开始                */</span>

    <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>

    <span class="token comment">/* Umpf. On OpenBSD, the default fd limit for root users is set to
       soft 128. Let's try to fix that... */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">&lt;</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>

      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

      <span class="token comment">/* This takes care of OpenBSD, which doesn't have RLIMIT_AS, but
         according to reliable sources, RLIMIT_DATA covers anonymous
         maps - so we should be getting good protection against OOM bugs. */</span>

      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>


    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Dumping cores is slow and can lead to anomalies if SIGKILL is delivered
       before the dump is complete. */</span>

    r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

    <span class="token comment">/* Isolate the process and configure standard descriptors. If out_file is
       specified, stdin is /dev/null; otherwise, out_fd is cloned instead. */</span>

    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//创建一个新的session 使子进程完全独立，脱离控制</span>

    <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//重新配置fd 关闭子进程的stdout和stderr</span>
    <span class="token comment">//将其重定位至/dev/null中</span>
    <span class="token comment">//相当于关闭了子进程的全部输出</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//设置out_file</span>

      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//关闭子进程的stdin，重定向到/dev/null</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

      <span class="token function">dup2</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//关闭stdin，重定向至out_fd</span>
      <span class="token function">close</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//关闭out_td</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Set up control and status pipes, close the unneeded original fds. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FORKSRV_FD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将FORKSRV_FD重定向至ctl_pipe[0],子进程只能读取命令</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将FORKSRV_FD + 1重定向至st_pipe[1]，子进程只能发送"写出"状态</span>

    <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>dev_urandom_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//关闭一些进程中的文件描述符</span>

    <span class="token comment">/* This should improve performance a bit, since it stops the linker from
       doing extra work post-fork(). */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LD_BIND_LAZY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"LD_BIND_NOW"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果没有设置LD_BIND_LAZY环境变量</span>
    <span class="token comment">//设置LD_BIND_NOW为1，防止linker在fork之后做额外的操作</span>

    <span class="token comment">/* Set sane defaults for ASAN if nothing else specified. */</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"abort_on_error=1:"</span>
                           <span class="token string">"detect_leaks=0:"</span>
                           <span class="token string">"symbolize=0:"</span>
                           <span class="token string">"allocator_may_return_null=1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                           <span class="token comment">//设置ASAN选项</span>

    <span class="token comment">/* MSAN is tricky, because it doesn't support abort_on_error=1 at this
       point. So, we do this in a very hacky way. */</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">":"</span>
                           <span class="token string">"symbolize=0:"</span>
                           <span class="token string">"abort_on_error=1:"</span>
                           <span class="token string">"allocator_may_return_null=1:"</span>
                           <span class="token string">"msan_track_origins=0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                           <span class="token comment">//设置MSAN选项</span>

    <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//带参数执行target，该参数除非出错，否则不会返回</span>
    <span class="token comment">//execv会替换原有的进程空间为target_path代表的程序，这个进程结束相当于子进程结束</span>
    <span class="token comment">//第一个target会进入__afl_maybe_log里的__afl_fork_wait_loop,并充当fork server</span>
    <span class="token comment">//在整个fuzz过程中都不会结束</span>
    <span class="token comment">//每次要fuzz一次target都会从这个fork server中fork出一个子进程去fuzz</span>

    <span class="token comment">/* Use a distinctive bitmap signature to tell the parent about execv()
       falling through. */</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>
  <span class="token comment">//              子进程结束</span>

  <span class="token comment">/* Close the unneeded endpoints. */</span>

  <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//关闭ctl_pipe[0]和st_pipe[1]，控制管道读与状态管道写（父进程不需要）</span>

  fsrv_ctl_fd <span class="token operator">=</span> ctl_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  fsrv_st_fd  <span class="token operator">=</span> st_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Wait for the fork server to come up, but don't wait too long. */</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">*</span> FORK_WAIT_MULT<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">*</span> FORK_WAIT_MULT<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token comment">//等待fork server 启动（不能等太久）</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  rlen <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//从管道中读取4个字节放在status中</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//超时报错</span>

  <span class="token comment">/* If we have a four-byte "hello" message from the server, we're all set.
     Otherwise, try to figure out what went wrong. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rlen <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//读取了4个字节</span>
    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All right - fork server is up."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//准备就绪，直接返回</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out<span class="token punctuation">)</span>    <span class="token comment">//如果设置了child_time_out</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Timeout while initializing fork server (adjusting -t may help)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//提醒调整-t参数</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//否则等待forksrv返回status</span>
    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//等待forksrv是否返回的异常退出信号</span>
  <span class="token comment">//如果是异常退出信号</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">&lt;</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> uses_asan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//判断是否由于设置的mem_limit过小导致的</span>

      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"Whoops, the target binary crashed suddenly, before receiving any input\n"</span>
           <span class="token string">"    from the fuzzer! Since it seems to be built with ASAN and you have a\n"</span>
           <span class="token string">"    restrictive memory limit configured, this is expected; please read\n"</span>
           <span class="token string">"    %s/notes_for_asan.txt for help.\n"</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//由于未收到任何input就crash，可能是由于asan和mem_limit的原因</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果没有设置mem_limit</span>

      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"Whoops, the target binary crashed suddenly, before receiving any input\n"</span>
           <span class="token string">"    from the fuzzer! There are several probable explanations:\n\n"</span>

           <span class="token string">"    - The binary is just buggy and explodes entirely on its own. If so, you\n"</span>
           <span class="token string">"      need to fix the underlying problem or find a better replacement.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

           <span class="token string">"    - On MacOS X, the semantics of fork() syscalls are non-standard and may\n"</span>
           <span class="token string">"      break afl-fuzz performance optimizations when running platform-specific\n"</span>
           <span class="token string">"      targets. To fix this, set AFL_NO_FORKSRV=1 in the environment.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

           <span class="token string">"    - Less likely, there is a horrible bug in the fuzzer. If other options\n"</span>
           <span class="token string">"      fail, poke &lt;lcamtuf@coredump.cx> for troubleshooting tips.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//告知原因</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//否则告知原因</span>

      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"Whoops, the target binary crashed suddenly, before receiving any input\n"</span>
           <span class="token string">"    from the fuzzer! There are several probable explanations:\n\n"</span>

           <span class="token string">"    - The current memory limit (%s) is too restrictive, causing the\n"</span>
           <span class="token string">"      target to hit an OOM condition in the dynamic linker. Try bumping up\n"</span>
           <span class="token string">"      the limit with the -m setting in the command line. A simple way confirm\n"</span>
           <span class="token string">"      this diagnosis would be:\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>
           <span class="token string">"      ( ulimit -Sv $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
           <span class="token string">"      ( ulimit -Sd $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>

           <span class="token string">"      Tip: you can use http://jwilk.net/software/recidivm to quickly\n"</span>
           <span class="token string">"      estimate the required amount of virtual memory for the binary.\n\n"</span>

           <span class="token string">"    - The binary is just buggy and explodes entirely on its own. If so, you\n"</span>
           <span class="token string">"      need to fix the underlying problem or find a better replacement.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>

           <span class="token string">"    - On MacOS X, the semantics of fork() syscalls are non-standard and may\n"</span>
           <span class="token string">"      break afl-fuzz performance optimizations when running platform-specific\n"</span>
           <span class="token string">"      targets. To fix this, set AFL_NO_FORKSRV=1 in the environment.\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

           <span class="token string">"    - Less likely, there is a horrible bug in the fuzzer. If other options\n"</span>
           <span class="token string">"      fail, poke &lt;lcamtuf@coredump.cx> for troubleshooting tips.\n"</span><span class="token punctuation">,</span>
           <span class="token function">DMS</span><span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mem_limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server crashed with signal %d"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过WIERMSIG(status)获取信号告知用户single原因</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span>
  <span class="token comment">//检查trace_bits == EXEC_FAIL_SIG，如果设置了说明没有正常执行</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application ('%s')"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">&lt;</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> uses_asan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//判断条件，可能是由于配置的内存限制导致的</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"Hmm, looks like the target binary terminated before we could complete a\n"</span>
           <span class="token string">"    handshake with the injected code. Since it seems to be built with ASAN and\n"</span>
           <span class="token string">"    you have a restrictive memory limit configured, this is expected; please\n"</span>
           <span class="token string">"    read %s/notes_for_asan.txt for help.\n"</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果没有设置mem_limit，可能是fuzzer的bug</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Hmm, looks like the target binary terminated before we could complete a\n"</span>
         <span class="token string">"    handshake with the injected code. Perhaps there is a horrible bug in the\n"</span>
         <span class="token string">"    fuzzer. Poke &lt;lcamtuf@coredump.cx> for troubleshooting tips.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//告知用户可能是其他原因</span>

    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Hmm, looks like the target binary terminated before we could complete a\n"</span>
         <span class="token string">"    handshake with the injected code. There are %s probable explanations:\n\n"</span>

         <span class="token string">"%s"</span>
         <span class="token string">"    - The current memory limit (%s) is too restrictive, causing an OOM\n"</span>
         <span class="token string">"      fault in the dynamic linker. This can be fixed with the -m option. A\n"</span>
         <span class="token string">"      simple way to confirm the diagnosis may be:\n\n"</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>
         <span class="token string">"      ( ulimit -Sv $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
         <span class="token string">"      ( ulimit -Sd $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>

         <span class="token string">"      Tip: you can use http://jwilk.net/software/recidivm to quickly\n"</span>
         <span class="token string">"      estimate the required amount of virtual memory for the binary.\n\n"</span>

         <span class="token string">"    - Less likely, there is a horrible bug in the fuzzer. If other options\n"</span>
         <span class="token string">"      fail, poke &lt;lcamtuf@coredump.cx> for troubleshooting tips.\n"</span><span class="token punctuation">,</span>
         <span class="token function">getenv</span><span class="token punctuation">(</span>DEFER_ENV_VAR<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"three"</span> <span class="token operator">:</span> <span class="token string">"two"</span><span class="token punctuation">,</span>
         <span class="token function">getenv</span><span class="token punctuation">(</span>DEFER_ENV_VAR<span class="token punctuation">)</span> <span class="token operator">?</span>
         <span class="token string">"    - You are using deferred forkserver, but __AFL_INIT() is never\n"</span>
         <span class="token string">"      reached before the program terminates.\n\n"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
         <span class="token function">DMS</span><span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mem_limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server handshake failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="has-new-bits"><a href="#has-new-bits" class="headerlink" title="has_new_bits"></a>has_new_bits</h4><p>检查有没有新路径或者某个路径的执行次数有所不同</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check if the current execution path brings anything new to the table.
   Update virgin bits to reflect the finds. Returns 1 if the only change is
   the hit-count for a particular tuple; 2 if there are new tuples seen. 
   Updates the map, so subsequent calls will always return 0.

   This function is called after every exec() on a fairly large buffer, so
   it needs to be fast. We do this in 32-bit and 64-bit flavors. */</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> u8 <span class="token function">has_new_bits</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> virgin_map<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">WORD_SIZE_64   </span><span class="token comment">//64位实现</span></span>

  u64<span class="token operator">*</span> current <span class="token operator">=</span> <span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">;</span>   <span class="token comment">//current指向trace_bits的首地址</span>
  u64<span class="token operator">*</span> virgin  <span class="token operator">=</span> <span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>virgin_map<span class="token punctuation">;</span>    <span class="token comment">//virgin指向virgin_map的首地址</span>

  u32  i <span class="token operator">=</span> <span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//代表MAP_SIZE除以2的3次方，即MAP_SIZE/8，按照8个字节一组，一共分了i组</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token comment">//32位实现</span>

  u32<span class="token operator">*</span> current <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">;</span>
  u32<span class="token operator">*</span> virgin  <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>virgin_map<span class="token punctuation">;</span>

  u32  i <span class="token operator">=</span> <span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//代表MAP_SIZE除以2的2次方，即MAP_SIZE/4，按照4个字节一组，一共分了i组</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^WORD_SIZE_64 */</span></span>

  u8   ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//循环遍历分组</span>

    <span class="token comment">/* Optimize for (*current &amp; *virgin) == 0 - i.e., no bits in current bitmap
       that have not been already cleared from the virgin map - since this will
       almost always be the case. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>current <span class="token operator">&amp;</span> <span class="token operator">*</span>virgin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果*current不为0且*current &amp; *virgin</span>
      <span class="token comment">//代表current发现了新的路径或者某条路径的执行次数和之前有所不同</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        u8<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>current<span class="token punctuation">;</span>   <span class="token comment">//cur指向current第一个字节</span>
        u8<span class="token operator">*</span> vir <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>virgin<span class="token punctuation">;</span>    <span class="token comment">//vir指向virgin第一个字节</span>

        <span class="token comment">/* Looks like we have not found any new bytes yet; see if any non-zero
           bytes in current[] are pristine in virgin[]. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">WORD_SIZE_64</span></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token comment">//判断cur[i] &amp;&amp; vir[i] == 0xff</span>
            <span class="token comment">//有一个为真</span>
            <span class="token comment">//设置ret为2，代表发现了之前没有出现的tuple</span>
        <span class="token keyword">else</span> ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//否则设置ret为1，代表只是命中次数更新</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cur<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> vir<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token keyword">else</span> ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^WORD_SIZE_64 */</span></span>

      <span class="token punctuation">&#125;</span>

      <span class="token operator">*</span>virgin <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token operator">*</span>current<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    current<span class="token operator">++</span><span class="token punctuation">;</span>
    virgin<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">//current和virgin移动到下一个8字节，直到MAP_SIZE全部被遍历完</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> virgin_map <span class="token operator">==</span> virgin_bits<span class="token punctuation">)</span> bitmap_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">//如果传入的参数virgin_map值为virgin_bits，并且ret不为0</span>
  <span class="token comment">//设置bitmap_changed为1</span>

  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>  <span class="token comment">//返回ret值</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="run-target"><a href="#run-target" class="headerlink" title="run_target"></a>run_target</h4><p>通过子进程的方式执行目标应用，这个函数部分代码和前面的init_forkserver很像</p>
<p>但是这个函数处理了在设置了no_forkserver的情况的下的处理过程</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Execute target application, monitoring for timeouts. Return status
   information. The called program will update trace_bits[]. */</span>

<span class="token keyword">static</span> u8 <span class="token function">run_target</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u32 timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span>
  <span class="token keyword">static</span> u32 prev_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> u64 exec_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u32 tb4<span class="token punctuation">;</span>

  child_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* After this memset, trace_bits[] are effectively volatile, so we
     must prevent any earlier operations from venturing into that
     territory. */</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//清空trace_bits[MAP_SIZE]为0</span>
  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* If we're running in "dumb" mode, we can't rely on the fork server
     logic compiled into the target program, so we will just keep calling
     execve(). There is a bit of code duplication between here and 
     init_forkserver(), but c'est la vie. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果dumb_mode等于1或设置no_forkserver</span>

    child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//fork出一个子进程</span>
    <span class="token comment">//调用execv执行子进程中的target_path</span>
    <span class="token comment">//如果失败了就向trace_bits中写入EXEC_FAIL_SIG</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>

        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>

      <span class="token punctuation">&#125;</span>

      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

      <span class="token comment">/* Isolate the process and configure standard descriptors. If out_file is
         specified, stdin is /dev/null; otherwise, out_fd is cloned instead. */</span>

      <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

        <span class="token function">dup2</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span>

      <span class="token comment">/* On Linux, would be faster to use O_CLOEXEC. Maybe TODO. */</span>

      <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>dev_urandom_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* Set sane defaults for ASAN if nothing else specified. */</span>

      <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"abort_on_error=1:"</span>
                             <span class="token string">"detect_leaks=0:"</span>
                             <span class="token string">"symbolize=0:"</span>
                             <span class="token string">"allocator_may_return_null=1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">":"</span>
                             <span class="token string">"symbolize=0:"</span>
                             <span class="token string">"msan_track_origins=0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* Use a distinctive bitmap value to tell the parent about execv()
         falling through. */</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//代表此时已经有一个fork server正在进行</span>

    s32 res<span class="token punctuation">;</span>

    <span class="token comment">/* In non-dumb mode, we have the fork server up and running, so simply
       tell it to have at it, and then read back PID. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fsrv_ctl_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_timed_out<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//向控制管道中写入4个字节的prev_timed_out</span>
      <span class="token comment">//命令fork server开始fork出一个子进程进行fuzz</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to request new process from fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>child_pid<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//从状态管道中读取fork server返回的fork出的子进程的ID到child_pid中</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to request new process from fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server is misbehaving (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Configure timeout, as requested by user, then wait for child to terminate. */</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//超时报错</span>

  <span class="token comment">/* The SIGALRM handler simply kills the child_pid and sets child_timed_out. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果满足说明无fork server，以子进程的方式execv</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//waitpid等待子进程的status</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    s32 res<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//否则从状态管道中读取status</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to communicate with fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> child_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">getitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
  exec_ms <span class="token operator">=</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span> timeout <span class="token operator">-</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span>
                             it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token comment">//计算执行时间</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  total_execs<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">//执行次数计数+1</span>

  <span class="token comment">/* Any subsequent operations on trace_bits must not be moved by the
     compiler below this point. Past this location, trace_bits[] behave
     very normally and do not have to be treated as volatile. */</span>

  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  tb4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">WORD_SIZE_64</span></span>
  <span class="token function">classify_counts</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token function">classify_counts</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^WORD_SIZE_64 */</span></span>

  prev_timed_out <span class="token operator">=</span> child_timed_out<span class="token punctuation">;</span>

  <span class="token comment">/* Report outcome to caller. */</span>
 <span class="token comment">//判断子进程是否是异常退出，如果是，判断异常输出原因后返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stop_soon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//WIFSIGNALED(status)若为异常结束子进程返回的状态，则为真</span>

    kill_signal <span class="token operator">=</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取子进程终止的信号代码</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out <span class="token operator">&amp;&amp;</span> kill_signal <span class="token operator">==</span> SIGKILL<span class="token punctuation">)</span> <span class="token keyword">return</span> FAULT_TMOUT<span class="token punctuation">;</span>
    <span class="token comment">//如果child_timed_out为1且状态码为SIGKILL</span>
    <span class="token comment">//返回FAULT_TMOUT</span>

    <span class="token keyword">return</span> FAULT_CRASH<span class="token punctuation">;</span>  <span class="token comment">//返回FAULT_CRASH</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* A somewhat nasty hack for MSAN, which doesn't support abort_on_error and
     must use a special exit code. */</span>
  <span class="token comment">/*这是对MSAN的一种恶意攻击，它不支持abort_on_error，并且必须使用特殊的退出代码*/</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>uses_asan <span class="token operator">&amp;&amp;</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> MSAN_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    kill_signal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> FAULT_CRASH<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> tb4 <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span>
  <span class="token comment">//判断是否是无forkserver的execve执行失败</span>
    <span class="token keyword">return</span> FAULT_ERROR<span class="token punctuation">;</span>

  <span class="token comment">/* It makes sense to account for the slowest units only if the testcase was run
  under the user defined timeout. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>timeout <span class="token operator">></span> exec_tmout<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>slowest_exec_ms <span class="token operator">&lt;</span> exec_ms<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果最慢执行时间小于当前执行时间，并且timeout &lt; exec_ms</span>
    slowest_exec_ms <span class="token operator">=</span> exec_ms<span class="token punctuation">;</span>  <span class="token comment">//更新slowest_exec_ms</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> FAULT_NONE<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="classify-counts"><a href="#classify-counts" class="headerlink" title="classify_counts"></a>classify_counts</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">classify_counts</span><span class="token punctuation">(</span>u64<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>   <span class="token comment">//每8个字节一组，一共i组 </span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//循环遍历每组</span>

    <span class="token comment">/* Optimize for sparse bitmaps. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//如果对应的mem不为0</span>

      u16<span class="token operator">*</span> mem16 <span class="token operator">=</span> <span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>    <span class="token comment">//每次取两个字节</span>

      mem16<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem16<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem16<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//i从0~4，计算mem[i]的值，在count_class_lookup16[mem16[i]]中找到对应的值赋给mem16[i]</span>

    <span class="token punctuation">&#125;</span>

    mem<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="update-bitmap-score"><a href="#update-bitmap-score" class="headerlink" title="update_bitmap_score"></a>update_bitmap_score</h4><p>每当发现新的路径，就调用这个函数来比较是否为更有利的路径&#x3D;&#x3D;》最小的路径经济和来遍历到所有bitmap中的位</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* When we bump into a new path, we call this to see if the path appears
   more "favorable" than any of the existing ones. The purpose of the
   "favorables" is to have a minimal set of paths that trigger all the bits
   seen in the bitmap so far, and focus on fuzzing them at the expense of
   the rest.

   The first step of the process is to maintain a list of top_rated[] entries
   for every byte in the bitmap. We win that slot if there is no previous
   contender, or if the contender has a more favorable speed x size factor. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>
  u64 fav_factor <span class="token operator">=</span> q<span class="token operator">-></span>exec_us <span class="token operator">*</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>
  <span class="token comment">//fav_factor=该case的执行时间乘以样例大小，以这两个指标来衡量favorable的权重，越小越优</span>

  <span class="token comment">/* For every byte set in trace_bits[], see if there is a previous winner,
     and how it compares to us. */</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token comment">//遍历trace_bits数组</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>trace_bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果当前trace_bits数组值不为0，代表这是已经覆盖到path</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果该path对应的top_rated存在</span>

         <span class="token comment">/* Faster-executing or smaller test cases are favored. */</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span>fav_factor <span class="token operator">></span> top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>exec_us <span class="token operator">*</span> top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
         <span class="token comment">//如果fav_factor &lt;本次path的乘积，代表top_rared[i]的更优</span>
         <span class="token comment">//跳出循环遍历下一个path</span>

         <span class="token comment">/* Looks like we're going to win. Decrease ref count for the
            previous winner, discard its trace_bits[] if necessary. */</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>tc_ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">//如果该path长度top_rated乘积更大，则将top_rated对应的tc_ref字段-1</span>
           <span class="token function">ck_free</span><span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">)</span><span class="token punctuation">;</span>
           top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//释放并清空trace_mini</span>
         <span class="token punctuation">&#125;</span>

       <span class="token punctuation">&#125;</span>

       <span class="token comment">/* Insert ourselves as the new winner. */</span>

       top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>  <span class="token comment">//设置top_rated为当前case，替换为更优</span>
       q<span class="token operator">-></span>tc_ref<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment">//tc_ref+1</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>trace_mini<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//如果trace_mini为空</span>
         q<span class="token operator">-></span>trace_mini <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">minimize_bits</span><span class="token punctuation">(</span>q<span class="token operator">-></span>trace_mini<span class="token punctuation">,</span> trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//将trace_bits经过minimize_bits压缩，存放在trace_mini中</span>
       <span class="token punctuation">&#125;</span>

       score_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//设置score_changed为1</span>

     <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="minimize-bits"><a href="#minimize-bits" class="headerlink" title="minimize_bits"></a>minimize_bits</h4><p>将数据本身转换成位置记录下来</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Compact trace bytes into a smaller bitmap. We effectively just drop the
   count information here. This is called only sporadically, for some
   new paths. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">minimize_bits</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> dst<span class="token punctuation">,</span> u8<span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>src<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dst<span class="token punctuation">[</span>i <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    *(src++)==>每次取trace_bits[]数组中一个元素的值
    i >> 3==>获得dst的index，即这个数据会被压缩到dst[index]的bit中
    i &amp; 7==>不考虑高位的情况下只保留低三位，相当于dst[]byte中的哪一个bit
    1 &lt;&lt; (i &amp; 7)==> 把1放在表示对应数组的bit上*/</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//遍历下一个</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h4><p>精简队列</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* The second part of the mechanism discussed above is a routine that
   goes over top_rated[] entries, and then sequentially grabs winners for
   previously-unseen bytes (temp_v) and marks them as favored, at least
   until the next run. The favored entries are given more air time during
   all fuzzing steps. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//精简队列</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">;</span>
  <span class="token keyword">static</span> u8 temp_v<span class="token punctuation">[</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">||</span> <span class="token operator">!</span>score_changed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">//如果设置了dumb_mode或没有设置score_changed,直接返回</span>

  score_changed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//设置score_changed为0</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>temp_v<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//初始化temp_v数组，初始值为0xff</span>
  <span class="token comment">//如果为1代表还没有覆盖到</span>
  <span class="token comment">//如果为0代表已经覆盖到了</span>

  queued_favored  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//设置queued_favored为0</span>
  pending_favored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//设置pending_favored为0</span>

  q <span class="token operator">=</span> queue<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//循环队列</span>
    q<span class="token operator">-></span>favored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//设置favored都为0</span>
    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token comment">//指向下一个用例</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Let's see if anything in the bitmap isn't captured in temp_v.
     If yes, and if it has a top_rated[] contender, let's use it. 
     让我们看看位图中是否有什么东西没有在temp_v中捕获。如果是，并且它有一个top_rated[]竞争者，我们就使用它*/</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>temp_v<span class="token punctuation">[</span>i <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//判断path对应的bit有没有被置位</span>

      u32 j <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>

      <span class="token comment">/* Remove all bits belonging to the current entry from temp_v.
      从temp_var中删除所有属于当前条目的位 */</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>j<span class="token operator">--</span><span class="token punctuation">)</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">//如果top_rated[i]有值，且该path在tmp_v里被置位</span>
          temp_v<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">//从temp_v中清除所有top_rated[i]覆盖到path</span>
          <span class="token comment">//将对应的bit设置为0</span>

      top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>favored <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//设置本次favored为1</span>
      queued_favored<span class="token operator">++</span><span class="token punctuation">;</span>     <span class="token comment">//queued_favored计数器+1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>was_fuzzed<span class="token punctuation">)</span> pending_favored<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">//如果top_rated[i]->was_fuzzed被设置为0，证明还没有被fuzz过</span>
      <span class="token comment">//pending_favored计数器+1</span>

    <span class="token punctuation">&#125;</span>

  q <span class="token operator">=</span> queue<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//遍历队列</span>
    <span class="token function">mark_as_redundant</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">!</span>q<span class="token operator">-></span>favored<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果不是favored的case，就标记成redundant_edges</span>
    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="mark-as-redundant"><a href="#mark-as-redundant" class="headerlink" title="mark_as_redundant"></a>mark_as_redundant</h4><p>标记&#x2F;取消标记为冗余(仅限边缘)</p>
<p>不用于恢复状态，在后面处理数据集有用</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Mark / unmark as redundant (edge-only). This is not used for restoring state,
   but may be useful for post-processing datasets. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mark_as_redundant</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8 state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> fn<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> q<span class="token operator">-></span>fs_redundant<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  q<span class="token operator">-></span>fs_redundant <span class="token operator">=</span> state<span class="token punctuation">;</span>  <span class="token comment">//条件不成立，赋值</span>

  fn <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/redundant_edges/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> fn <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//拼接路径</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果state为1</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//尝试连接out_dir/queue/.state/redundant_edges/fname</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果state为0</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlink</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to remove '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//尝试删除路径out_dir/queue/.state/redundant_edges/fname</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="show-init-stats"><a href="#show-init-stats" class="headerlink" title="show_init_stats"></a>show_init_stats</h4><p>在处理输入目录的末尾显示快速统计信息，还有一堆警告</p>
<p>其中还有一些校准在此结束，还有一些硬编码的常量</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Display quick statistics at the end of processing the input directory,
   plus a bunch of warnings. Some calibration stuff also ended up here,
   along with several hardcoded constants. Maybe clean up eventually. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">show_init_stats</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  u32 min_bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max_bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u64 min_us <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max_us <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u64 avg_us <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u32 max_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>total_cal_cycles<span class="token punctuation">)</span> avg_us <span class="token operator">=</span> total_cal_us <span class="token operator">/</span> total_cal_cycles<span class="token punctuation">;</span>
  <span class="token comment">//total_cal_us  总执行时间</span>
  <span class="token comment">//total_cal_cycles   //总执行轮次</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//遍历queue，更新min_us,max_us,min_bits,max_bits,max_len</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>min_us <span class="token operator">||</span> q<span class="token operator">-></span>exec_us <span class="token operator">&lt;</span> min_us<span class="token punctuation">)</span> min_us <span class="token operator">=</span> q<span class="token operator">-></span>exec_us<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">></span> max_us<span class="token punctuation">)</span> max_us <span class="token operator">=</span> q<span class="token operator">-></span>exec_us<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>min_bits <span class="token operator">||</span> q<span class="token operator">-></span>bitmap_size <span class="token operator">&lt;</span> min_bits<span class="token punctuation">)</span> min_bits <span class="token operator">=</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">></span> max_bits<span class="token punctuation">)</span> max_bits <span class="token operator">=</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>len <span class="token operator">></span> max_len<span class="token punctuation">)</span> max_len <span class="token operator">=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>

    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>avg_us <span class="token operator">></span> <span class="token punctuation">(</span>qemu_mode <span class="token operator">?</span> <span class="token number">50000</span> <span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//如果avg_us大于10000就警告</span>
    <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"The target binary is pretty slow! See %s/perf_tips.txt."</span><span class="token punctuation">,</span>
          doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Let's keep things moving with slow binaries. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>avg_us <span class="token operator">></span> <span class="token number">50000</span><span class="token punctuation">)</span> havoc_div <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>     <span class="token comment">/* 0-19 execs/sec   */</span>
  <span class="token comment">//如果大于50000，设置havoc_div为10</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avg_us <span class="token operator">></span> <span class="token number">20000</span><span class="token punctuation">)</span> havoc_div <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">/* 20-49 execs/sec  */</span>
  <span class="token comment">//如果大于20000，设置havoc_div为5</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avg_us <span class="token operator">></span> <span class="token number">10000</span><span class="token punctuation">)</span> havoc_div <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">/* 50-100 execs/sec */</span>
  <span class="token comment">//如果大于10000，设置havoc_div为2</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resuming_fuzz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//如果不是resuming_fuzz</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>max_len <span class="token operator">></span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>   <span class="token comment">//对queue的大小超限发出警告</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"Some test cases are huge (%s) - see %s/perf_tips.txt!"</span><span class="token punctuation">,</span>
            <span class="token function">DMS</span><span class="token punctuation">(</span>max_len<span class="token punctuation">)</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>max_len <span class="token operator">></span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Some test cases are big (%s) - see %s/perf_tips.txt."</span><span class="token punctuation">,</span>
            <span class="token function">DMS</span><span class="token punctuation">(</span>max_len<span class="token punctuation">)</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>useless_at_start <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>in_bitmap<span class="token punctuation">)</span>   <span class="token comment">//如果useless_at_start不为0，就警告可以精简样本</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"Some test cases look useless. Consider using a smaller set."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>queued_paths <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span>   <span class="token comment">//对queue的个数超限发出警告</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"You probably have far too many input files! Consider trimming down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>queued_paths <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"You have lots of input files; try starting small."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Here are some useful stats:\n\n"</span>

      cGRA <span class="token string">"    Test case count : "</span> cRST <span class="token string">"%u favored, %u variable, %u total\n"</span>
      cGRA <span class="token string">"       Bitmap range : "</span> cRST <span class="token string">"%u to %u bits (average: %0.02f bits)\n"</span>
      cGRA <span class="token string">"        Exec timing : "</span> cRST <span class="token string">"%s to %s us (average: %s us)\n"</span><span class="token punctuation">,</span>
      queued_favored<span class="token punctuation">,</span> queued_variable<span class="token punctuation">,</span> queued_paths<span class="token punctuation">,</span> min_bits<span class="token punctuation">,</span> max_bits<span class="token punctuation">,</span> 
      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>total_bitmap_size<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>total_bitmap_entries <span class="token operator">?</span> total_bitmap_entries <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">DI</span><span class="token punctuation">(</span>min_us<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>max_us<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>avg_us<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout_given<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果timeout_given为0</span>

    <span class="token comment">/* Figure out the appropriate timeout. The basic idea is: 5x average or
       1x max, rounded up to EXEC_TM_ROUND ms and capped at 1 second.

       If the program is slow, the multiplier is lowered to 2x or 3x, because
       random scheduler jitter is less likely to have any impact, and because
       our patience is wearing thin =) */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>avg_us <span class="token operator">></span> <span class="token number">50000</span><span class="token punctuation">)</span> exec_tmout <span class="token operator">=</span> avg_us <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avg_us <span class="token operator">></span> <span class="token number">10000</span><span class="token punctuation">)</span> exec_tmout <span class="token operator">=</span> avg_us <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> exec_tmout <span class="token operator">=</span> avg_us <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    exec_tmout <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>exec_tmout<span class="token punctuation">,</span> max_us <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//exec_tmout和所有样例中执行时间最长的样例进行比较，取最大值给exec_tmout</span>
    exec_tmout <span class="token operator">=</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">+</span> EXEC_TM_ROUND<span class="token punctuation">)</span> <span class="token operator">/</span> EXEC_TM_ROUND <span class="token operator">*</span> EXEC_TM_ROUND<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">></span> EXEC_TIMEOUT<span class="token punctuation">)</span> exec_tmout <span class="token operator">=</span> EXEC_TIMEOUT<span class="token punctuation">;</span>
    <span class="token comment">//如果exec_tmout大于EXEC_TIMEOUT，就设置为EXEC_TIMEOUT</span>

    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"No -t option specified, so I'll use exec timeout of %u ms."</span><span class="token punctuation">,</span> 
         exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    timeout_given <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置timeout_given为1</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//代表这是resuming session</span>

    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Applying timeout settings from resumed session (%u ms)."</span><span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* In dumb mode, re-running every timing out test case with a generous time
     limit is very expensive, so let's select a more conservative default. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">//如果是dumb_mode模式，并且没有设置AFL_HANG_TMOUT环境变量</span>
    hang_tmout <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>EXEC_TIMEOUT<span class="token punctuation">,</span> exec_tmout <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置hang_tmout为exec_tmout * 2 + 100和EXEC_TIMEOUT中的最小值</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All set and ready to roll!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="find-start-position"><a href="#find-start-position" class="headerlink" title="find_start_position"></a>find_start_position</h4><p>恢复时请尝试查找要从其开始的队列位置,这仅在resume时以及当我们可以找到原始的fuzzer_stats时才有意义</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* When resuming, try to find the queue position to start from. This makes sense
   only when resuming, and when we can find the original fuzzer_stats. */</span>

<span class="token keyword">static</span> u32 <span class="token function">find_start_position</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 tmp<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Ought to be enough for anybody. */</span>

  u8  <span class="token operator">*</span>fn<span class="token punctuation">,</span> <span class="token operator">*</span>off<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  u32 ret<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resuming_fuzz<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//如果不是resuming_fuzz，直接返回</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/fuzzer_stats"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果是in_place_resume</span>
  <span class="token comment">//拼接out_dir/fuzzer_stats</span>
  <span class="token keyword">else</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/../fuzzer_stats"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//拼接in_dir/../fuzzer_stats</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//以只读的模式打开fn指向的文件</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  i <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>
  <span class="token comment">//将这个文件中的内容读到tmp中</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  off <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"cur_path          : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//寻找cur_path</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>off<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  ret <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>off <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将cur_path后面的值设置为ret的值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> queued_paths<span class="token punctuation">)</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//如果大于queued_paths就设置ret为0</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="write-stats-file"><a href="#write-stats-file" class="headerlink" title="write_stats_file"></a>write_stats_file</h4><p>更新统计信息文件以进入无人值守的监视</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Update stats file for unattended monitoring. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_stats_file</span><span class="token punctuation">(</span><span class="token keyword">double</span> bitmap_cvg<span class="token punctuation">,</span> <span class="token keyword">double</span> stability<span class="token punctuation">,</span> <span class="token keyword">double</span> eps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> <span class="token keyword">double</span> last_bcvg<span class="token punctuation">,</span> last_stab<span class="token punctuation">,</span> last_eps<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">rusage</span> usage<span class="token punctuation">;</span>

  u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/fuzzer_stats"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//拼接out_dir/fuzzer_stats</span>
  s32 fd<span class="token punctuation">;</span>
  FILE<span class="token operator">*</span> f<span class="token punctuation">;</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//创建文件</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  f <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Keep last values in case we're called from another context
     where exec/sec stats and such are not readily available. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bitmap_cvg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stability <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    bitmap_cvg <span class="token operator">=</span> last_bcvg<span class="token punctuation">;</span>
    stability  <span class="token operator">=</span> last_stab<span class="token punctuation">;</span>
    eps        <span class="token operator">=</span> last_eps<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    last_bcvg <span class="token operator">=</span> bitmap_cvg<span class="token punctuation">;</span>
    last_stab <span class="token operator">=</span> stability<span class="token punctuation">;</span>
    last_eps  <span class="token operator">=</span> eps<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//写入统计信息</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"start_time        : %llu\n"</span>    <span class="token comment">//fuzz运行的开始时间</span>
             <span class="token string">"last_update       : %llu\n"</span>    <span class="token comment">//当前时间</span>
             <span class="token string">"fuzzer_pid        : %u\n"</span>      <span class="token comment">//获取当前pid</span>
             <span class="token string">"cycles_done       : %llu\n"</span>    <span class="token comment">//queue_cycle在queue_cur为空，即执行到当前队列尾的时候才增加1，所以这代表queue队列被完全变异一次的次数</span>
             <span class="token string">"execs_done        : %llu\n"</span>    <span class="token comment">//total_execs，target的总的执行次数，每次run_target的时候会增加1</span>
             <span class="token string">"execs_per_sec     : %0.02f\n"</span>  <span class="token comment">//每秒执行的次数</span>
             <span class="token string">"paths_total       : %u\n"</span>      <span class="token comment">//queued_paths在每次add_to_queue的时候会增加1，代表queue里的样例总数</span>
             <span class="token string">"paths_favored     : %u\n"</span>      <span class="token comment">//queued_favored，有价值的路径总数</span>
             <span class="token string">"paths_found       : %u\n"</span>      <span class="token comment">//queued_discovered在每次common_fuzz_stuff去执行一次fuzz时，发现新的interesting case的时候会增加1，代表在fuzz运行期间发现的新queue entry</span>
             <span class="token string">"paths_imported    : %u\n"</span>      <span class="token comment">//queued_imported是master-slave模式下，如果sync过来的case是interesting的，就增加1</span>
             <span class="token string">"max_depth         : %u\n"</span>      <span class="token comment">//最大路径深度</span>
             <span class="token string">"cur_path          : %u\n"</span>      <span class="token comment">//current_entry一般情况下代表的是正在执行的queue entry的整数ID,queue首节点的ID是0  /* Must match find_start_position() */</span>
             <span class="token string">"pending_favs      : %u\n"</span>      <span class="token comment">//pending_favored 等待fuzz的favored paths数</span>
             <span class="token string">"pending_total     : %u\n"</span>      <span class="token comment">//pending_not_fuzzed 在queue中等待fuzz的case数</span>
             <span class="token string">"variable_paths    : %u\n"</span>      <span class="token comment">//queued_variable在calibrate_case去评估一个新的test case的时候，如果发现这个case的路径是可变的，则将这个计数器加一，代表发现了一个可变case</span>
             <span class="token string">"stability         : %0.02f%%\n"</span><span class="token comment">//稳定性</span>
             <span class="token string">"bitmap_cvg        : %0.02f%%\n"</span><span class="token comment">//</span>
             <span class="token string">"unique_crashes    : %llu\n"</span>    <span class="token comment">//unique_crashes这是在save_if_interesting时，如果fault是FAULT_CRASH，就将unique_crashes计数器加一</span>
             <span class="token string">"unique_hangs      : %llu\n"</span>    <span class="token comment">//unique_hangs这是在save_if_interesting时，如果fault是FAULT_TMOUT，且exec_tmout小于hang_tmout，就以hang_tmout为超时时间再执行一次，如果还超时，就让hang计数器加一</span>
             <span class="token string">"last_path         : %llu\n"</span>    <span class="token comment">//在add_to_queue里将一个新case加入queue时，就设置一次last_path_time为当前时间，last_path_time / 1000</span>
             <span class="token string">"last_crash        : %llu\n"</span>    <span class="token comment">//同上，在unique_crashes加一的时候，last_crash也更新时间，last_crash_time / 1000</span>
             <span class="token string">"last_hang         : %llu\n"</span>    <span class="token comment">//同上，在unique_hangs加一的时候，last_hang也更新时间，last_hang_time / 1000</span>
             <span class="token string">"execs_since_crash : %llu\n"</span>    <span class="token comment">//total_execs - last_crash_execs,这里last_crash_execs是在上一次crash的时候的总计执行了多少次</span>
             <span class="token string">"exec_timeout      : %u\n"</span>      <span class="token comment">//配置好的超时时间，有三种可能的配置方式   /* Must match find_timeout() */</span>
             <span class="token string">"afl_banner        : %s\n"</span>
             <span class="token string">"afl_version       : "</span> VERSION <span class="token string">"\n"</span>
             <span class="token string">"target_mode       : %s%s%s%s%s%s%s\n"</span>
             <span class="token string">"command_line      : %s\n"</span>
             <span class="token string">"slowest_exec_ms   : %llu\n"</span><span class="token punctuation">,</span>
             start_time <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             queue_cycle <span class="token operator">?</span> <span class="token punctuation">(</span>queue_cycle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> total_execs<span class="token punctuation">,</span> eps<span class="token punctuation">,</span>
             queued_paths<span class="token punctuation">,</span> queued_favored<span class="token punctuation">,</span> queued_discovered<span class="token punctuation">,</span> queued_imported<span class="token punctuation">,</span>
             max_depth<span class="token punctuation">,</span> current_entry<span class="token punctuation">,</span> pending_favored<span class="token punctuation">,</span> pending_not_fuzzed<span class="token punctuation">,</span>
             queued_variable<span class="token punctuation">,</span> stability<span class="token punctuation">,</span> bitmap_cvg<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">,</span>
             unique_hangs<span class="token punctuation">,</span> last_path_time <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> last_crash_time <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span>
             last_hang_time <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> total_execs <span class="token operator">-</span> last_crash_execs<span class="token punctuation">,</span>
             exec_tmout<span class="token punctuation">,</span> use_banner<span class="token punctuation">,</span>
             qemu_mode <span class="token operator">?</span> <span class="token string">"qemu "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> dumb_mode <span class="token operator">?</span> <span class="token string">" dumb "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
             no_forkserver <span class="token operator">?</span> <span class="token string">"no_forksrv "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> crash_mode <span class="token operator">?</span> <span class="token string">"crash "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
             persistent_mode <span class="token operator">?</span> <span class="token string">"persistent "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> deferred_mode <span class="token operator">?</span> <span class="token string">"deferred "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span>qemu_mode <span class="token operator">||</span> dumb_mode <span class="token operator">||</span> no_forkserver <span class="token operator">||</span> crash_mode <span class="token operator">||</span>
              persistent_mode <span class="token operator">||</span> deferred_mode<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
             orig_cmdline<span class="token punctuation">,</span> slowest_exec_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">/* ignore errors */</span>

  <span class="token comment">/* Get rss value from the children
     We must have killed the forkserver process and called waitpid
     before calling getrusage */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getrusage</span><span class="token punctuation">(</span>RUSAGE_CHILDREN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>usage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"getrusage failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>usage<span class="token punctuation">.</span>ru_maxrss <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"peak_rss_mb       : not available while afl is running\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"peak_rss_mb       : %zu\n"</span><span class="token punctuation">,</span> usage<span class="token punctuation">.</span>ru_maxrss <span class="token operator">>></span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"peak_rss_mb       : %zu\n"</span><span class="token punctuation">,</span> usage<span class="token punctuation">.</span>ru_maxrss <span class="token operator">>></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__APPLE__ */</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="save-auto"><a href="#save-auto" class="headerlink" title="save_auto"></a>save_auto</h4><p>保存自动生成的extras</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Save automatically generated extras. */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>auto_changed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">//如果auto_changed为0，则直接返回</span>
  auto_changed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//如果不为0，就设置为0</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">MIN</span><span class="token punctuation">(</span>USE_AUTO_EXTRAS<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/auto_extras/auto_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拼接路径out_dir/queue/.state/auto_extras/auto_00000i</span>
    s32 fd<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//创建out_dir/queue/.state/auto_extras/auto_00000i</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//写入extras</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h3 id="FUZZ主要执行流程"><a href="#FUZZ主要执行流程" class="headerlink" title="FUZZ主要执行流程"></a>FUZZ主要执行流程</h3><p>fuzz主循环</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">//fuzz主循环</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u8 skipped_fuzz<span class="token punctuation">;</span>

    <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//精简队列</span>
<span class="token comment">//queue_cur指向当前队列中的元素（entry）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue_cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果queye_cur中为空，代表queue被执行了一轮</span>

      queue_cycle<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//+1：说明走了一个循环</span>
      current_entry     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      cur_skipped_paths <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      queue_cur         <span class="token operator">=</span> queue<span class="token punctuation">;</span><span class="token comment">//重新指向队头</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>seek_to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果seek_to不为0</span>
        current_entry<span class="token operator">++</span><span class="token punctuation">;</span>
        seek_to<span class="token operator">--</span><span class="token punctuation">;</span>
        queue_cur <span class="token operator">=</span> queue_cur<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token comment">//queue_cur顺着队列持续后移==》最终移动到seek_to的位置上</span>
      <span class="token punctuation">&#125;</span>

      <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示状态</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>not_on_tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果不是终端模式</span>
        <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Entering queue cycle %llu."</span><span class="token punctuation">,</span> queue_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出当前是第几个循环</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">/* If we had a full queue cycle with no new finds, try
         recombination strategies next. 
         如果我们经历了一个完整的扫描周期后都没有新的路径发现，那么尝试调整策略
         */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>queued_paths <span class="token operator">==</span> prev_queued<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_splicing<span class="token punctuation">)</span> cycles_wo_finds<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token keyword">else</span> use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//当设置了use_splicing，cycles_wo_finds计数加一</span>
<span class="token comment">//否则use_splicing为1</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> cycles_wo_finds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      prev_queued <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id <span class="token operator">&amp;&amp;</span> queue_cycle <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_IMPORT_FIRST"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//如果设置了sync_id，并且queue_cycle==1，并且环境变量中设置了AFL_IMPORT_FIRST</span>
        <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用sync_fuzzers</span>

    <span class="token punctuation">&#125;</span>

    skipped_fuzz <span class="token operator">=</span> <span class="token function">fuzz_one</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//对样本进行变换后fuzz，返回skipped_fuzz</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> sync_id <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipped_fuzz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//若stop_soon为0，设置了sync_id，skipped_fuzz为0</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sync_interval_cnt<span class="token operator">++</span> <span class="token operator">%</span> SYNC_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//若sync_interval_cnt没有到一个周期（% SYNC_INTERVAL）</span>
        <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//同步其他fuzzer</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> exit_1<span class="token punctuation">)</span> stop_soon <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">//如果没有设置stop_soon,且exit_1不为0，那么设置stop_soon=2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment">//设置了stop_soon，退出fuzz主循环</span>
    queue_cur <span class="token operator">=</span> queue_cur<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token comment">//否则准备qemu中的下一个样本</span>
    current_entry<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span></code></pre>



<h4 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one:"></a>fuzz_one:</h4><p>首先是准备fuzz：</p>
<p>初始化变量，根据概率及前期轮次结果判断返回节点，映射case</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Take the current entry from the queue, fuzz it for a while. This
   function is a tad too long... returns 0 if fuzzed successfully, 1 if
   skipped or bailed out. */</span>
<span class="token comment">/* 从队列中取出放前的一项，然后进行fuzz，返回0则fuzz成功
*/</span>
<span class="token keyword">static</span> u8 <span class="token function">fuzz_one</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token comment">//前期准备</span>

  s32 len<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> temp_len<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
  u8  <span class="token operator">*</span>in_buf<span class="token punctuation">,</span> <span class="token operator">*</span>out_buf<span class="token punctuation">,</span> <span class="token operator">*</span>orig_in<span class="token punctuation">,</span> <span class="token operator">*</span>ex_tmp<span class="token punctuation">,</span> <span class="token operator">*</span>eff_map <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u64 havoc_queued<span class="token punctuation">,</span>  orig_hit_cnt<span class="token punctuation">,</span> new_hit_cnt<span class="token punctuation">;</span>
  u32 splice_cycle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> perf_score <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> orig_perf<span class="token punctuation">,</span> prev_cksum<span class="token punctuation">,</span> eff_cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  u8  ret_val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> doing_det <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  u8  a_collect<span class="token punctuation">[</span>MAX_AUTO_EXTRA<span class="token punctuation">]</span><span class="token punctuation">;</span>
  u32 a_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">IGNORE_FINDS</span></span>

  <span class="token comment">/* In IGNORE_FINDS mode, skip any entries that weren't in the
     initial data set. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>depth <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pending_favored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果设置了pendling_favored</span>

    <span class="token comment">/* If we have any favored, non-fuzzed new arrivals in the queue,
       possibly skip to them at the expense of already-fuzzed or non-favored
       cases. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>was_fuzzed <span class="token operator">||</span> <span class="token operator">!</span>queue_cur<span class="token operator">-></span>favored<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> SKIP_TO_NEW_PROB<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//查看当前queue中的一项是否已经fuzz过了或者不是favored，并且打印一个100以内的随机数，如果小于SKIP_TO_NEW_PROB，return 1</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>queue_cur<span class="token operator">-></span>favored <span class="token operator">&amp;&amp;</span> queued_paths <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//如果非dumb_mode,且当前的不是favored，并且queued_paths > 10==》</span>
    <span class="token comment">/* Otherwise, still possibly skip non-favored cases, albeit less often.
       The odds of skipping stuff are higher for already-fuzzed inputs and
       lower for never-fuzzed entries. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cycle <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>queue_cur<span class="token operator">-></span>was_fuzzed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//如果queue_cycle > 1 并且queue_cur还没有fuzz过</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> SKIP_NFAV_NEW_PROB<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//打一个100以内的随机数，如果小于SKIP_NFAV_NEW_PROB，直接return 1</span>
<span class="token comment">//SKIP_NFAV_NEW_PROB默认为75</span>
<span class="token comment">//75%</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> SKIP_NFAV_OLD_PROB<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//否则打一个100以内的随机数，如果小于SKIP_NFAV_OLD_PROB，直接return 1</span>
<span class="token comment">//SKIP_NFAV_OLD_PROB默认为95</span>
<span class="token comment">//95%</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^IGNORE_FINDS */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>not_on_tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果不是tty模式</span>
    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Fuzzing test case #%u (%u total, %llu uniq crashes found)..."</span><span class="token punctuation">,</span>
         current_entry<span class="token punctuation">,</span> queued_paths<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//输出current_entry, queued_paths, unique_crashes提示信息</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//刷新stdout缓冲区</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Map the test case into memory. */</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开case文件</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> queue_cur<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开失败报错</span>

  len <span class="token operator">=</span> queue_cur<span class="token operator">-></span>len<span class="token punctuation">;</span><span class="token comment">//将当前case大小赋值给len</span>

  orig_in <span class="token operator">=</span> in_buf <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将当前的test case映射进入内存</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>orig_in <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to mmap '%s'"</span><span class="token punctuation">,</span> queue_cur<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//映射失败报错</span>

  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* We could mmap() out_buf as MAP_PRIVATE, but we end up clobbering every
     single byte anyway, so it wouldn't give us any performance or memory usage
     benefits. */</span>

  out_buf <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分配len大小的空间，初始化为0</span>
  <span class="token comment">//将空间首地址赋值给out_buf</span>

  subseq_tmouts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//设置连续超时次数为0</span>

  cur_depth <span class="token operator">=</span> queue_cur<span class="token operator">-></span>depth<span class="token punctuation">;</span><span class="token comment">//设置cur_depth为当前case路径深度</span></code></pre>



<h5 id="CALIBRATION"><a href="#CALIBRATION" class="headerlink" title="CALIBRATION"></a>CALIBRATION</h5><p>(only if failed earlier on)</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/*******************************************
   * CALIBRATION (only if failed earlier on) *
   *******************************************/</span>

<span class="token comment">//校准：主要核实case的校验错误，如果小于3则调用calibrate_case进行重新校验，再根据返回结果做下一步判断</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>cal_failed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果当前queue_cur->cal_failed==》存在标准错误</span>

    u8 res <span class="token operator">=</span> FAULT_TMOUT<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>cal_failed <span class="token operator">&lt;</span> CAL_CHANCES<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//标准错误小于3次</span>

      <span class="token comment">/* Reset exec_cksum to tell calibrate_case to re-execute the testcase
         avoiding the usage of an invalid trace_bits.
          重制exec_cksum来告诉calibrate_case重新执行testcase来避免对于无效trace_bits的使用。
         For more info: https://github.com/AFLplusplus/AFLplusplus/pull/425 */</span>

      queue_cur<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> queue_cur<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> queue_cycle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进行重新校验</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span><span class="token comment">//如果返回值为FAULT_ERROR，直接报错终止</span>
        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> res <span class="token operator">!=</span> crash_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果设置了stop_soon或者res不等于crash_mode</span>
      cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//计数+1</span>
      <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span><span class="token comment">//跳转到abandon_entry</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span></code></pre>



<h5 id="TRIMMING"><a href="#TRIMMING" class="headerlink" title="TRIMMING"></a>TRIMMING</h5><pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/************
   * TRIMMING *
   ************/</span>

<span class="token comment">//判断case是否已被修剪，没有过就调用trim_case修剪一次，更新修剪后case的大小</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>queue_cur<span class="token operator">-></span>trim_done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果不是dumb_mode模式，并且case没有经过修剪</span>

    u8 res <span class="token operator">=</span> <span class="token function">trim_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> queue_cur<span class="token punctuation">,</span> in_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//调用trim_case进行修剪，返回res</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span><span class="token comment">//如果res结果为FAULT_ERROR，抛异常</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果设置了stop_soon</span>
      cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//计数+1</span>
      <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span><span class="token comment">//跳转到abandon_entry</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Don't retry trimming, even if it failed. */</span>

    queue_cur<span class="token operator">-></span>trim_done <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//标记为已被修剪</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">!=</span> queue_cur<span class="token operator">-></span>len<span class="token punctuation">)</span> len <span class="token operator">=</span> queue_cur<span class="token operator">-></span>len<span class="token punctuation">;</span>
<span class="token comment">//如果修剪前的case大小不等于修建后长度，更新为修剪后长度</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将in_buf拷贝len个字节到out_buf中</span></code></pre>



<h5 id="PERFORMANCE-SCORE"><a href="#PERFORMANCE-SCORE" class="headerlink" title="PERFORMANCE SCORE"></a>PERFORMANCE SCORE</h5><pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/*********************
   * PERFORMANCE SCORE *
   *********************/</span>

<span class="token comment">//判断该case是否已经经历过deterministic阶段，如果已经经历过，直接跳转至havoc阶段</span>

  orig_perf <span class="token operator">=</span> perf_score <span class="token operator">=</span> <span class="token function">calculate_score</span><span class="token punctuation">(</span>queue_cur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算当前case的可取性</span>

  <span class="token comment">/* Skip right away if -d is given, if we have done deterministic fuzzing on
     this entry ourselves (was_fuzzed), or if it has gone through deterministic
     testing in earlier, resumed runs (passed_det). 
     如果给出了-d，如果我们自己对这个条目进行了确定性模糊化(was_fuzzed)，或者如果它在之前已经进行了确定性测试，则立即跳过，继续运行(passed_det)
     */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_deterministic <span class="token operator">||</span> queue_cur<span class="token operator">-></span>was_fuzzed <span class="token operator">||</span> queue_cur<span class="token operator">-></span>passed_det<span class="token punctuation">)</span>
  <span class="token comment">//如果已经设置了skip_deterministic或者case已经被fuzz过，或者queue_cur->passed_det==1</span>
    <span class="token keyword">goto</span> havoc_stage<span class="token punctuation">;</span><span class="token comment">//跳转</span>

  <span class="token comment">/* Skip deterministic fuzzing if exec path checksum puts this out of scope
     for this master instance. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>master_max <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>exec_cksum <span class="token operator">%</span> master_max<span class="token punctuation">)</span> <span class="token operator">!=</span> master_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token comment">////如果执行路径校验和将其置于此主实例的范围之外</span>
    <span class="token keyword">goto</span> havoc_stage<span class="token punctuation">;</span><span class="token comment">//跳转</span>

  doing_det <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre>



<h5 id="SIMPLE-BITFLIP"><a href="#SIMPLE-BITFLIP" class="headerlink" title="SIMPLE BITFLIP"></a>SIMPLE BITFLIP</h5><p>(+dictionary construction)</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/*********************************************
   * SIMPLE BITFLIP (+dictionary construction) *
   *********************************************/</span>

<span class="token comment">//将case中内容按位取反的变异过程</span>

<span class="token comment">//首先定义一个宏</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FLIP_BIT</span><span class="token expression"><span class="token punctuation">(</span>_ar<span class="token punctuation">,</span> _b<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>
    <span class="token expression">u8<span class="token operator">*</span> _arf <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ar<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression">u32 _bf <span class="token operator">=</span> <span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression">_arf<span class="token punctuation">[</span><span class="token punctuation">(</span>_bf<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_bf<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span></code></pre>

<p>该宏为变异的主要实现：</p>
<p><strong>一参</strong>：</p>
<p>传入FLIP_BIT的一参：_ar&#x3D;&#x3D;》out_buf&#x3D;&#x3D;》从case映射到内存的内容</p>
<p><strong>注意点</strong>：</p>
<p>out_buf为u8（4字节char）</p>
<p>假设case内容为”12345678”&#x3D;&#x3D;》第一组取值：”1234”</p>
<p>在将数据加载进内存的时候是以字符串的形式</p>
<p><strong>二参</strong>：</p>
<p>在对len&lt;&lt;3之后的结果作为循环条件&#x3D;&#x3D;》</p>
<p>从0~32依次作为二参_b传入FLIP_BIT</p>
<p>传入后：</p>
<pre class="language-none"><code class="language-none">_arf：out_buf (1234)
_bf: 0~31 (out_buf为4字节，字节8位，共32)</code></pre>



<pre class="language-c" data-language="c"><code class="language-c">_arf<span class="token punctuation">[</span><span class="token punctuation">(</span>_bf<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_bf<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>&#x3D;&#x3D;&gt;</p>
<pre class="language-none"><code class="language-none">closure1&#x3D;(_bf) &amp; 7)

closure2&#x3D;128 &lt;&lt; closure1

closure3&#x3D;(_bf) &gt;&gt; 3

_arf[closure3]&#x3D;_arf[closure3]^closure2</code></pre>

<p><strong>步骤一</strong>：</p>
<pre class="language-none"><code class="language-none">closure1&#x3D;(_bf) &amp; 7)</code></pre>

<p>_bf为不断循环传入的0<del>31&#x3D;&#x3D;&gt;0</del>31分别与7进行与运算</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220422171724534.png"></p>
<p>&#x3D;&#x3D;》结果分为4组，每组的值为0~7</p>
<p><strong>步骤二</strong>：</p>
<pre class="language-none"><code class="language-none">closure2&#x3D;128 &lt;&lt; closure1</code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220423145243863.png"></p>
<p>结果为按照位的位置依次变1</p>
<p><strong>步骤三</strong>：</p>
<pre class="language-none"><code class="language-none">closure3&#x3D;(_bf) &gt;&gt; 3</code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220423150916569.png"></p>
<p><strong>步骤四</strong>：</p>
<pre class="language-none"><code class="language-none">_arf[closure3]&#x3D;_arf[closure3]^closure2</code></pre>

<p>closure3作为_afl指针数组的下标&#x3D;&#x3D;》closure变化为0，1，2，3&#x3D;&#x3D;》</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/image-20220423152823405.png"></p>
<p>注意closure3是连续8个0，1，2，3&#x3D;&#x3D;》_afl[0],_afl[1],_afl[2],_afl[3]分别要与closure2进行8此异或操作&#x3D;&#x3D;》</p>
<p>每次的异或结果还将刷新_afl[index]的值&#x3D;&#x3D;》</p>
<p>例：</p>
<pre class="language-c" data-language="c"><code class="language-c">_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">10000000</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">01000000</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">00100000</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">00010000</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">00001000</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">00000100</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">00000010</span> 
_arf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">00110001</span> <span class="token operator">^</span> <span class="token number">00000001</span> </code></pre>

<p>&#x3D;&#x3D;》对out_buf中的内容进行按位取反&#x3D;&#x3D;》</p>
<p>对FLIP_BIT调用：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将out_buf中的内容进行按位取反</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
<span class="token comment">//调用common_fuzz_stuff进行fuzz，保存interesting种子</span>
<span class="token comment">//如果返回为1，跳转至abandon_entry</span>

<span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将out_buf恢复</span></code></pre>



<p><strong>bitflip 1&#x2F;1</strong> &amp;&amp; collect tokens 按位取反 &amp;&amp; 搜集token：</p>
<p>bitflip 1&#x2F;1主要进行case内容的位取反工作，记录token，刷新新路径和crash次数</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/*********************************************
   * SIMPLE BITFLIP (+dictionary construction) *
   *********************************************/</span>

<span class="token comment">//将case中内容按位取反的变异过程</span>

<span class="token comment">//首先定义一个宏</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FLIP_BIT</span><span class="token expression"><span class="token punctuation">(</span>_ar<span class="token punctuation">,</span> _b<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>
    <span class="token expression">u8<span class="token operator">*</span> _arf <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ar<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression">u32 _bf <span class="token operator">=</span> <span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression">_arf<span class="token punctuation">[</span><span class="token punctuation">(</span>_bf<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_bf<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

  <span class="token comment">/* Single walking bit. */</span>

  stage_short <span class="token operator">=</span> <span class="token string">"flip1"</span><span class="token punctuation">;</span>
  stage_max   <span class="token operator">=</span> len <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">//定义stage_max由len决定</span>
  stage_name  <span class="token operator">=</span> <span class="token string">"bitflip 1/1"</span><span class="token punctuation">;</span>  <span class="token comment">//bitflip 1/1变异策略</span>

  stage_val_type <span class="token operator">=</span> STAGE_VAL_NONE<span class="token punctuation">;</span>

  orig_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  prev_cksum <span class="token operator">=</span> queue_cur<span class="token operator">-></span>exec_cksum<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//循环给FLIP_BIT提供二参</span>

    stage_cur_byte <span class="token operator">=</span> stage_cur <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将out_buf中的内容进行按位取反</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
    <span class="token comment">//调用common_fuzz_stuff进行fuzz，保存interesting种子</span>
    <span class="token comment">//如果返回为1，跳转至abandon_entry</span>

    <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将out_buf恢复</span>

    <span class="token comment">/* While flipping the least significant bit in every byte, pull of an extra
       trick to detect possible syntax tokens. In essence, the idea is that if
       you have a binary blob like this:

       xxxxxxxxIHDRxxxxxxxx

       ...and changing the leading and trailing bytes causes variable or no
       changes in program flow, but touching any character in the "IHDR" string
       always produces the same, distinctive path, it's highly likely that
       "IHDR" is an atomically-checked magic value of special significance to
       the fuzzed format.

       We do this here, rather than as a separate stage, because it's a nice
       way to keep the operation approximately "free" (i.e., no extra execs).
       
       Empirically, performing the check when flipping the least significant bit
       is advantageous, compared to doing it at the time of more disruptive
       changes, where the program flow may be affected in more violent ways.

       The caveat is that we won't generate dictionaries in the -d mode or -S
       mode - but that's probably a fair trade-off.

       This won't work particularly well with paths that exhibit variable
       behavior, but fails gracefully, so we'll carry out the checks anyway.

      */</span>

      <span class="token comment">/*经过bitflip 1/1变异时，会对每一个byte的最低有效位取反后进行识别处理，如果连续 多个bytes的最低位被取反后程序的路径都没有变化，
	     但是与原始路径不一致，就会把这一段 连续的bytes判断是一条token（分词器选中词条）

       举例，如果输入数据为“select * from table”时，原始路径应该是执行SQL语句流程路径，第一次取反的应该是“s”，但是在变异后“felect”并不符合语法，
       那么在执行SQL语句时流程路径就会走向报错，与原始路径不同，但是“s”会取反8次，每一次的结果“kelect”、“oekect”....都不符合SQL语句语法，
       因此执行路径就会和“felect”相同。也就是说破坏“select”被破坏将会与正确路径不一致，而破坏之后的路径都一样，那么AFL就会将“select”作为token记录下来*/</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果不是dumb_mode模式并且(stage_cur &amp; 7) == 7==》</span>
      <span class="token comment">//意味着只有stage_cur==7、15、23...，即当翻转到每个字节最低有效位的时候进入分支</span>

      u32 cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//对当前trace_bits户进行hash32运算，值记录在cksum中</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">==</span> stage_max <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> cksum <span class="token operator">==</span> prev_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//循环至stage_max - 1也就是内容结尾</span>
        <span class="token comment">//并且校验与上次相同，即当前路径与上一次路径相比没有变化</span>

        <span class="token comment">/* If at end of file and we are still collecting a string, grab the
           final character and force output. */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>a_len <span class="token operator">&lt;</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span> a_collect<span class="token punctuation">[</span>a_len<span class="token punctuation">]</span> <span class="token operator">=</span> out_buf<span class="token punctuation">[</span>stage_cur <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//如果当前token数量小于32(MAX_AUTO_EXTRA默认为32)</span>
        <span class="token comment">//将当前字符作为token拼接到a_collect[]数组中</span>
        a_len<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//token数量+1</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>a_len <span class="token operator">>=</span> MIN_AUTO_EXTRA <span class="token operator">&amp;&amp;</span> a_len <span class="token operator">&lt;=</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span>
        <span class="token comment">//如果token数量大于等于3(MIN_AUTO_EXTRA默认为3)且小于等于32(MAX_AUTO_EXTRA默认为32)</span>
          <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>a_collect<span class="token punctuation">,</span> a_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//调用maybe_add_auto将累计的a_collect[]数组中的内容添加到a_extras[]数组中</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cksum <span class="token operator">!=</span> prev_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果当前校验和与上一次校验和不一样，说明与上一次执行路径不一样，那么本次编译的字节是存在问题的</span>

        <span class="token comment">/* Otherwise, if the checksum has changed, see if we have something
           worthwhile queued up, and collect that if the answer is yes. */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>a_len <span class="token operator">>=</span> MIN_AUTO_EXTRA <span class="token operator">&amp;&amp;</span> a_len <span class="token operator">&lt;=</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span>
        <span class="token comment">//如果token数量大于等于3(MIN_AUTO_EXTRA默认为3)且小于等于32(MAX_AUTO_EXTRA默认为32)</span>
          <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>a_collect<span class="token punctuation">,</span> a_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//调用maybe_add_auto将a_collect中的token添加到a_extras数组中</span>

        a_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//清空a_len</span>
        prev_cksum <span class="token operator">=</span> cksum<span class="token punctuation">;</span>  <span class="token comment">//刷新prev_cksum为当前cksum</span>

      <span class="token punctuation">&#125;</span>

      <span class="token comment">/* Continue collecting string, but only if the bit flip actually made
         any difference - we don't want no-op tokens. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cksum <span class="token operator">!=</span> queue_cur<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果当前路径与原始路径不相同，这说明可能是因为token被破坏导致与原始执行路径不符</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>a_len <span class="token operator">&lt;</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span> a_collect<span class="token punctuation">[</span>a_len<span class="token punctuation">]</span> <span class="token operator">=</span> out_buf<span class="token punctuation">[</span>stage_cur <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//如果token数量小于32</span>
        <span class="token comment">//将当前循环字符添加到a_collect数组中</span>
        a_len<span class="token operator">++</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  stage_finds<span class="token punctuation">[</span>STAGE_FLIP1<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
  <span class="token comment">//stage_finds[STAGE_FLIP1]累加整个FLIP_BIT过程中新发现的路径和crash总和</span>
  stage_cycles<span class="token punctuation">[</span>STAGE_FLIP1<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
  <span class="token comment">//stage_cycles[STAGE_FLIP1]累加整个FLIP_BIT过程中变异的次数</span></code></pre>



<p><strong>bitflip 2&#x2F;1</strong>  相邻两位进行取反：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Two walking bits. */</span>

stage_name  <span class="token operator">=</span> <span class="token string">"bitflip 2/1"</span><span class="token punctuation">;</span>  <span class="token comment">//bitflip 2/1相邻两位取反变异策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"flip2"</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  stage_cur_byte <span class="token operator">=</span> stage_cur <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//第一次按位取反</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//第二次按位取反</span>
  <span class="token comment">//在stage_cur+1==》说明这两次取反会将out_buf中相邻两位数据进行取反</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
  <span class="token comment">//调用common_fuzz_stuff对变异后数据进行测试，记录interesting</span>
  <span class="token comment">//如果返回1跳转到abandon_entry</span>

  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//第一次取反恢复</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//相邻位取反恢复</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_FLIP2<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_FLIP2]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_FLIP2<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_FLIP2]累加bitflip 2/1变异次数</span></code></pre>



<p><strong>bitflip 4&#x2F;1</strong>  相邻四位进行取反</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Four walking bits. */</span>

stage_name  <span class="token operator">=</span> <span class="token string">"bitflip 4/1"</span><span class="token punctuation">;</span>  <span class="token comment">//bitflip 4/1相邻四位取反变异策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"flip4"</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  stage_cur_byte <span class="token operator">=</span> stage_cur <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//第一位取反</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//相邻第二位取反</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//相邻第三位取反</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//相邻第四位取反</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
  <span class="token comment">//调用common_fuzz_stuff对变异后数据进行测试，记录interesting</span>
  <span class="token comment">//如果返回1跳转到abandon_entry</span>

  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//第一位取反恢复</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//第二位取反恢复</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//第三位取反恢复</span>
  <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> stage_cur <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//第四位取反霍夫</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_FLIP4<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_FLIP4]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_FLIP4<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_FLIP4]累加bitflip 4/1变异次数</span></code></pre>



<p><strong>bitflip 8&#x2F;8</strong> </p>
<p>effector map byte取反</p>
<p>构建effector map</p>
<p>&#x3D;&#x3D;》不使用前面定义的宏进行反转&#x3D;&#x3D;》直接将0xFF与其进行异或实现翻转</p>
<p>&#x3D;&#x3D;》</p>
<p>在这个进程中会生成了一个effector map[]数组，在对每个</p>
<p>在一个byte完全反转，如果造成执行路径与原始路径不一样&#x3D;&#x3D;》将byte在effector map中标记为1&#x3D;&#x3D;》有效</p>
<p>否则标记为0&#x3D;&#x3D;》无效</p>
<p>在某些情况下并不会检测有效字符，在dumb_mode模式下或者指定fuzzer情况下，此时所有字符都有可能进行变异</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/* Effector map setup. These macros calculate:

     EFF_APOS      - position of a particular file offset in the map.
     EFF_ALEN      - length of a map with a particular number of bytes.
     EFF_SPAN_ALEN - map span for a sequence of bytes.

   */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EFF_APOS</span><span class="token expression"><span class="token punctuation">(</span>_p<span class="token punctuation">)</span>          <span class="token punctuation">(</span><span class="token punctuation">(</span>_p<span class="token punctuation">)</span> <span class="token operator">>></span> EFF_MAP_SCALE2<span class="token punctuation">)</span></span></span>
<span class="token comment">//EFF_APOS(_p)&#123; p >> 3 &#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EFF_REM</span><span class="token expression"><span class="token punctuation">(</span>_x<span class="token punctuation">)</span>           <span class="token punctuation">(</span><span class="token punctuation">(</span>_x<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> EFF_MAP_SCALE2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//EFF_REM(_x)&#123; x &amp; ((1&lt;&lt;3)-1) &#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EFF_ALEN</span><span class="token expression"><span class="token punctuation">(</span>_l<span class="token punctuation">)</span>          <span class="token punctuation">(</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>_l<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">EFF_REM</span><span class="token punctuation">(</span>_l<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//EFF_ALEN(_l)&#123; (l>>3) + ((l&amp;((1&lt;&lt;3)-1))==0)?0:1 &#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EFF_SPAN_ALEN</span><span class="token expression"><span class="token punctuation">(</span>_p<span class="token punctuation">,</span> _l<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_p<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>_l<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">EFF_APOS</span><span class="token punctuation">(</span>_p<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//EFF_SPAN_ALEN(_p, _l)&#123; (p+l-1) >> 3 - (p>>3) +1 &#125;</span>

  <span class="token comment">/* Initialize effector map for the next step (see comments below). Always
     flag first and last byte as doing something. */</span>

  eff_map    <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token function">EFF_ALEN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//为eff_map开辟case字节长度空间</span>
  eff_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//设置eff_map[0]为1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果(len-1)>>3不等于0，即case数据长度大于等于9</span>
    eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置eff_map[(len-1)>>3]为1</span>
    eff_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Walking byte. */</span>

  stage_name  <span class="token operator">=</span> <span class="token string">"bitflip 8/8"</span><span class="token punctuation">;</span>  <span class="token comment">//bitflip 8/8 字节翻转变异策略</span>
  stage_short <span class="token operator">=</span> <span class="token string">"flip8"</span><span class="token punctuation">;</span>
  stage_max   <span class="token operator">=</span> len<span class="token punctuation">;</span>

  orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//stage_max为len</span>

    stage_cur_byte <span class="token operator">=</span> stage_cur<span class="token punctuation">;</span>

    out_buf<span class="token punctuation">[</span>stage_cur<span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    <span class="token comment">//对out_buf中的每一个bit做异或反转</span>
    <span class="token comment">//0xFF=11111111</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
    <span class="token comment">//调用common_fuzz_stuff对变异后数据进行测试，记录interesting</span>
    <span class="token comment">//如果返回1跳转到abandon_entry</span>

    <span class="token comment">/* We also use this stage to pull off a simple trick: we identify
       bytes that seem to have no effect on the current execution path
       even when fully flipped - and we skip them during more expensive
       deterministic stages, such as arithmetics or known ints. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>stage_cur<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果eff_map[stage_cur>>3]为0</span>

      u32 cksum<span class="token punctuation">;</span>

      <span class="token comment">/* If in dumb mode or if the file is very short, just flag everything
         without wasting time on checksums. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> len <span class="token operator">>=</span> EFF_MIN_LEN<span class="token punctuation">)</span>
      <span class="token comment">//如果不是dumb_mode模式并且len大于等于128(EFF_MIN_LEN默认128)</span>
        cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//计算当前校验和</span>
      <span class="token keyword">else</span>
      <span class="token comment">//否则如果是dumb_mode模式或len小于128</span>
        cksum <span class="token operator">=</span> <span class="token operator">~</span>queue_cur<span class="token operator">-></span>exec_cksum<span class="token punctuation">;</span>
        <span class="token comment">//cksum等于queue_cur->exec_cksum按位取反结果</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cksum <span class="token operator">!=</span> queue_cur<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>stage_cur<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//产生新的路径，发生了变化，此时直接将对应的eff_map中的项标记为1</span>
        eff_cnt<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//标记次数+1</span>
      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    out_buf<span class="token punctuation">[</span>stage_cur<span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>  <span class="token comment">//取反复位</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* If the effector map is more than EFF_MAX_PERC dense, just flag the
     whole thing as worth fuzzing, since we wouldn't be saving much time
     anyway. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>eff_cnt <span class="token operator">!=</span> <span class="token function">EFF_ALEN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      eff_cnt <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">/</span> <span class="token function">EFF_ALEN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">></span> EFF_MAX_PERC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果eff_map的密度超过EFF_MAX_PERC（默认90）</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>eff_map<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">EFF_ALEN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//初始化eff_map为1</span>

    blocks_eff_select <span class="token operator">+=</span> <span class="token function">EFF_ALEN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//blocks_eff_select累加更新EFF_ALEN(len)</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    blocks_eff_select <span class="token operator">+=</span> eff_cnt<span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  blocks_eff_total <span class="token operator">+=</span> <span class="token function">EFF_ALEN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

  new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  stage_finds<span class="token punctuation">[</span>STAGE_FLIP8<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
  <span class="token comment">//stage_finds[STAGE_FLIP8]累加出现的新路径与crash次数的和</span>
  stage_cycles<span class="token punctuation">[</span>STAGE_FLIP8<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
  <span class="token comment">//stage_cycles[STAGE_FLIP8]累加bitflip 8/1变异次数</span>

  <span class="token comment">/* Two walking bytes. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_bitflip<span class="token punctuation">;</span>
  <span class="token comment">//如果len&lt;2</span>
  <span class="token comment">//调转至skip_bitflip</span></code></pre>



<p><strong>bitflip 16&#x2F;8</strong></p>
<p>连续两个字节翻转</p>
<pre class="language-c" data-language="c"><code class="language-c">stage_name  <span class="token operator">=</span> <span class="token string">"bitflip 16/8"</span><span class="token punctuation">;</span>  <span class="token comment">//连续两字节翻转</span>
stage_short <span class="token operator">=</span> <span class="token string">"flip16"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//检查eff_map对应连续两个字节是否为0</span>
    stage_max<span class="token operator">--</span><span class="token punctuation">;</span>   <span class="token comment">//--跳过</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>  <span class="token comment">//连续两个字节翻转</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
  <span class="token comment">//调用common_fuzz_stuff测试记录</span>
  <span class="token comment">//如果返回值为1，跳转至abandon_entry</span>
  stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//stage_cur计数+1</span>

  <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>  <span class="token comment">//翻转+1</span>


<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_FLIP16<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_FLIP16]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_FLIP16<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_FLIP16]累加bitflip 16/8变异次数</span></code></pre>



<p><strong>bitflip 32&#x2F;8</strong></p>
<p>连续4个byte翻转</p>
<pre class="language-c" data-language="c"><code class="language-c">  stage_name  <span class="token operator">=</span> <span class="token string">"bitflip 32/8"</span><span class="token punctuation">;</span>  <span class="token comment">//连续4个字节翻转</span>
  stage_short <span class="token operator">=</span> <span class="token string">"flip32"</span><span class="token punctuation">;</span>
  stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  stage_max   <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>

  orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/* Let's consult the effector map... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//判断eff_map连续四项是否为空</span>
      stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//--跳过</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>   <span class="token comment">//连续4个字节跳转</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
    <span class="token comment">//调用common_fuzz_stuff测试记录</span>
    <span class="token comment">//返回值为1，跳转至abandon_entry</span>
    stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//计数器+1</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>  <span class="token comment">//翻转恢复</span>

  <span class="token punctuation">&#125;</span>

  new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  stage_finds<span class="token punctuation">[</span>STAGE_FLIP32<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
  <span class="token comment">//stage_finds[STAGE_FLIP32]累加出现的新路径与crash次数的和</span>
  stage_cycles<span class="token punctuation">[</span>STAGE_FLIP32<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
  <span class="token comment">//stage_cycles[STAGE_FLIP32]累加bitflip 32/8变异次数</span>

skip_bitflip<span class="token operator">:</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>no_arith<span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_arith<span class="token punctuation">;</span></code></pre>



<h5 id="ARITHMETIC-INC-x2F-DEC"><a href="#ARITHMETIC-INC-x2F-DEC" class="headerlink" title="ARITHMETIC INC&#x2F;DEC"></a>ARITHMETIC INC&#x2F;DEC</h5><p>在该阶段会做加减变异，这个阶段和上一个bitfilp阶段差不多&#x3D;&#x3D;》按照位数递增变异&#x3D;&#x3D;》</p>
<p>该阶段的变异存在上限：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARITH_MAX</span>           <span class="token expression"><span class="token number">35</span> </span><span class="token comment">//config.h~143行</span></span></code></pre>

<p>在config.h中定义了ARITH_MAX宏，默认为35&#x3D;&#x3D;》</p>
<p>会对目标整数进行+1，+2，+3……+35，-1，-2，~-35&#x3D;&#x3D;》</p>
<p>整数存在大端序和小端序&#x3D;&#x3D;》该阶段会对这两种端序进行变异</p>
<p>跳过字节变异情况：</p>
<p>1、选中字节对应的在effector map中是无效的&#x3D;&#x3D;》跳过</p>
<p>2、变异结果在bitflip阶段已经完成了（在上一个阶段已经测试过了，避免重复）&#x3D;&#x3D;》跳过</p>
<p><strong>arith 8&#x2F;8</strong></p>
<p>单字(8 bit)加减运算</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**********************
 * ARITHMETIC INC/DEC *
 **********************/</span>

<span class="token comment">/* 8-bit arithmetics. */</span>

stage_name  <span class="token operator">=</span> <span class="token string">"arith 8/8"</span><span class="token punctuation">;</span> <span class="token comment">//arith 8/8变异策略，对每个byte(8 bit)进行加减运算</span>
stage_short <span class="token operator">=</span> <span class="token string">"arith8"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> len <span class="token operator">*</span> ARITH_MAX<span class="token punctuation">;</span>

stage_val_type <span class="token operator">=</span> STAGE_VAL_LE<span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历out_buf</span>

  u8 orig <span class="token operator">=</span> out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//orig为一个字节</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//判断该字节对应eff_map中是否有效</span>
    stage_max <span class="token operator">-=</span> <span class="token number">2</span> <span class="token operator">*</span> ARITH_MAX<span class="token punctuation">;</span>
    <span class="token comment">//如果无效，stage_max减去2倍的ARITH_MAX，跳过本次变异</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> ARITH_MAX<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u8 r <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token punctuation">(</span>orig <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//orig与orig+j做亦或</span>

    <span class="token comment">/* Do arithmetic operations only if the result couldn't be a product
       of a bitflip. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//判断是否可以通过上一种bitfilp变异方式来获得本次变异结果，如果不能进入分支</span>

      stage_cur_val <span class="token operator">=</span> j<span class="token punctuation">;</span>
      out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> orig <span class="token operator">+</span> j<span class="token punctuation">;</span>   <span class="token comment">//按字节做加法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试和记录</span>
      <span class="token comment">//如果返回值为1，则跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//如果能够通过bitfilp获得，则跳过这个byte</span>

    r <span class="token operator">=</span>  orig <span class="token operator">^</span> <span class="token punctuation">(</span>orig <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//orig与orig - j做亦或</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//判断是否可以通过上一种bitfilp变异方式来获得本次变异结果，如果不能进入分支</span>

      stage_cur_val <span class="token operator">=</span> <span class="token operator">-</span>j<span class="token punctuation">;</span>
      out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> orig <span class="token operator">-</span> j<span class="token punctuation">;</span> <span class="token comment">//按字节做减法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试和记录</span>
      <span class="token comment">//如果返回值为1，则跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//如果能够通过bitfilp获得，则跳过这个byte</span>

    out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> orig<span class="token punctuation">;</span>  <span class="token comment">//复位</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_ARITH8<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_ARITH8]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_ARITH8<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_ARITH8]累加arith 8/8变异次数</span></code></pre>



<p><strong>arith 16&#x2F;8</strong></p>
<p>对每个双字(16 bit)进行加减运算（大小端序）</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* 16-bit arithmetics, both endians. */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_arith<span class="token punctuation">;</span>

stage_name  <span class="token operator">=</span> <span class="token string">"arith 16/8"</span><span class="token punctuation">;</span>
<span class="token comment">//arith 16/8变异策略，对每个双字(16 bit)进行加减运算</span>
stage_short <span class="token operator">=</span> <span class="token string">"arith16"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> ARITH_MAX<span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//遍历out_buf</span>

  u16 orig <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//检验eff_map中本次循环中对应的双字是否有效</span>
    stage_max <span class="token operator">-=</span> <span class="token number">4</span> <span class="token operator">*</span> ARITH_MAX<span class="token punctuation">;</span>
    <span class="token comment">//如果无效则跳过</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> ARITH_MAX<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//SWAP16((_ret &lt;&lt; 8) | (_ret >> 8))</span>

    u16 r1 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token punctuation">(</span>orig <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//orig与orig+j做亦或（小端）</span>
        r2 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token punctuation">(</span>orig <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//orig与orig-j做亦或（小端）</span>
        r3 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token function">SWAP16</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//orig与orig+j做亦或（大端）</span>
        r4 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token function">SWAP16</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//orig与orig-j做亦或（大端）</span>

    <span class="token comment">/* Try little endian addition and subtraction first. Do it only
       if the operation would affect more than one byte (hence the 
       &amp; 0xff overflow checks) and if it couldn't be a product of
       a bitflip. */</span>

    stage_val_type <span class="token operator">=</span> STAGE_VAL_LE<span class="token punctuation">;</span> 

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>orig <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">+</span> j <span class="token operator">></span> <span class="token number">0xff</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r1不能通过bitflip得到且(orig &amp; 0xff) + j > 0xff</span>

      stage_cur_val <span class="token operator">=</span> j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig <span class="token operator">+</span> j<span class="token punctuation">;</span>  <span class="token comment">//做加法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数计数器+1</span>
 
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>orig <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> j <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r2不能通过bitflip得到且(orig &amp; 0xff) &lt; j</span>

      stage_cur_val <span class="token operator">=</span> <span class="token operator">-</span>j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig <span class="token operator">-</span> j<span class="token punctuation">;</span>  <span class="token comment">//做减法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token comment">/* Big endian comes next. Same deal. */</span>

    stage_val_type <span class="token operator">=</span> STAGE_VAL_BE<span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>orig <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> j <span class="token operator">></span> <span class="token number">0xff</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r3不能通过bitflip得到且(orig >> 8) + j > 0xff</span>

      stage_cur_val <span class="token operator">=</span> j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token function">SWAP16</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//大端做加法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>orig <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> j <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r4不能通过bitflip得到且(orig >> 8) &lt; j</span>

      stage_cur_val <span class="token operator">=</span> <span class="token operator">-</span>j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token function">SWAP16</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//大端做减法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig<span class="token punctuation">;</span>  <span class="token comment">//复位</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_ARITH16<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_ARITH16]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_ARITH16<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_ARITH16]累加arith 16/8变异次数</span></code></pre>



<p><strong>arith 32&#x2F;8</strong></p>
<p>对每四字(32 bit)的大小端序进行加减运算</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* 32-bit arithmetics, both endians. */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_arith<span class="token punctuation">;</span>

stage_name  <span class="token operator">=</span> <span class="token string">"arith 32/8"</span><span class="token punctuation">;</span>
<span class="token comment">//arith 32/8变异策略，对每个四字(32 bit)进行加减运算</span>
stage_short <span class="token operator">=</span> <span class="token string">"arith32"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> ARITH_MAX<span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历out_buf</span>

  u32 orig <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//检验本次循环中对应的四字在eff_map中是否有效</span>
    stage_max <span class="token operator">-=</span> <span class="token number">4</span> <span class="token operator">*</span> ARITH_MAX<span class="token punctuation">;</span>  <span class="token comment">//如果无效跳过本次循环</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> ARITH_MAX<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u32 r1 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token punctuation">(</span>orig <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//orig与orig+j做亦或(小端)</span>
        r2 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token punctuation">(</span>orig <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//orig与orig-j做亦或(小端)</span>
        r3 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//orig与orig+j做亦或(大端)</span>
        r4 <span class="token operator">=</span> orig <span class="token operator">^</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//orig与orig-j做亦或(大端)</span>

    <span class="token comment">/* Little endian first. Same deal as with 16-bit: we only want to
       try if the operation would have effect on more than two bytes. */</span>

    stage_val_type <span class="token operator">=</span> STAGE_VAL_LE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>orig <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> j <span class="token operator">></span> <span class="token number">0xffff</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r1不能由bitflip得到且(orig &amp; 0xffff) + j > 0xffff</span>

      stage_cur_val <span class="token operator">=</span> j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig <span class="token operator">+</span> j<span class="token punctuation">;</span>  <span class="token comment">//做加法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>orig <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> j <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r2不能由bitflip得到且(orig &amp; 0xffff) &lt; j</span>

      stage_cur_val <span class="token operator">=</span> <span class="token operator">-</span>j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig <span class="token operator">-</span> j<span class="token punctuation">;</span>  <span class="token comment">//做减法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token comment">/* Big endian next. */</span>

    stage_val_type <span class="token operator">=</span> STAGE_VAL_BE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> j <span class="token operator">></span> <span class="token number">0xffff</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r3不能由bitflip得到且(SWAP32(orig) &amp; 0xffff) + j > 0xffff</span>

      stage_cur_val <span class="token operator">=</span> j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//大端做加法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> j <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>r4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果r4不能由bitflip得到且(SWAP32(orig) &amp; 0xffff) &lt; j</span>

      stage_cur_val <span class="token operator">=</span> <span class="token operator">-</span>j<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span> <span class="token operator">-</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//大端做减法</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig<span class="token punctuation">;</span>  <span class="token comment">//复位</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_ARITH32<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_ARITH32]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_ARITH32<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_ARITH32]累加arith 32/8变异次数</span></code></pre>



<h5 id="INTERESTING-VALUES"><a href="#INTERESTING-VALUES" class="headerlink" title="INTERESTING VALUES"></a>INTERESTING VALUES</h5><p>该阶段主要将out_buf中的字节替换成AFL内部预设的数值，该数值在config.h文件中：</p>
<p>存放着一些整型溢出的数据，在每一次变异时会去检查在前两个阶段bitfilp和arithmetic阶段是否已经产生过&#x3D;&#x3D;》</p>
<p>若已经产生过&#x3D;&#x3D;》跳过，验证effector map中对于目标字节的项是否有效</p>
<p>若无效&#x3D;&#x3D;》跳过</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> s8 interesting_8<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>INTERESTING_8<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> s16 interesting_16<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>INTERESTING_8<span class="token punctuation">,</span> INTERESTING_16<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> s32 interesting_32<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>INTERESTING_8<span class="token punctuation">,</span> INTERESTING_16<span class="token punctuation">,</span> INTERESTING_32<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_8</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">128</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit when decremented  */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">1</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">16</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">32</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">64</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">100</span><span class="token punctuation">,</span>          </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">127</span>           </span><span class="token comment">/* Overflow signed 8-bit when incremented  */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_16</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">32768</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit when decremented */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">129</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit                   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">128</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit                   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">255</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow unsig 8-bit when incremented   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">256</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow unsig 8-bit                    */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">512</span><span class="token punctuation">,</span>          </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">1000</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">1024</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">4096</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">32767</span>         </span><span class="token comment">/* Overflow signed 16-bit when incremented */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_32</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">2147483648LL</span><span class="token punctuation">,</span> </span><span class="token comment">/* Overflow signed 32-bit when decremented */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">100663046</span><span class="token punctuation">,</span>    </span><span class="token comment">/* Large negative number (endian-agnostic) */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">32769</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit                  */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">32768</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit                  */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">65535</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow unsig 16-bit when incremented  */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">65536</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow unsig 16 bit                   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">100663045</span><span class="token punctuation">,</span>    </span><span class="token comment">/* Large positive number (endian-agnostic) */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">2147483647</span>    </span><span class="token comment">/* Overflow signed 32-bit when incremented */</span></span></code></pre>



<p><strong>interest 8&#x2F;8</strong></p>
<p>按字节替换interest数据</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**********************
 * INTERESTING VALUES *
 **********************/</span>

stage_name  <span class="token operator">=</span> <span class="token string">"interest 8/8"</span><span class="token punctuation">;</span>  <span class="token comment">//interest 8/8 按字节替换interest数据变异策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"int8"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> len <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_8<span class="token punctuation">)</span><span class="token punctuation">;</span>

stage_val_type <span class="token operator">=</span> STAGE_VAL_LE<span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token comment">/* Setting 8-bit integers. */</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历out_buf</span>

  u8 orig <span class="token operator">=</span> out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//判断本次循环中对应在eff_map中的项是否为有效的</span>
    stage_max <span class="token operator">-=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_8<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果无效则跳过本次循环</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_8<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//遍历interesting_8数组中的数据</span>

    <span class="token comment">/* Skip if the value could be a product of bitflips or arithmetics. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>orig <span class="token operator">^</span> <span class="token punctuation">(</span>u8<span class="token punctuation">)</span>interesting_8<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">could_be_arith</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token punctuation">(</span>u8<span class="token punctuation">)</span>interesting_8<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//如果orig ^ (u8)interesting_8[j]的结果可以通过bitflip或arith阶段获得</span>
      stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过本次循环</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    stage_cur_val <span class="token operator">=</span> interesting_8<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> interesting_8<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//将循环指定的字节替换成interesting_8中的数据</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
    <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
    <span class="token comment">//返回值为1跳转至abandon_entry</span>

    out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> orig<span class="token punctuation">;</span>   <span class="token comment">//复位</span>
    stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异次数+1</span>

  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_INTEREST8<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_INTEREST8]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_INTEREST8<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_INTEREST8]累加interest 8/8变异次数</span></code></pre>



<p><strong>interest 16&#x2F;8</strong></p>
<p>按双字节替换interest数据变异策略</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Setting 16-bit integers, both endians. */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>no_arith <span class="token operator">||</span> len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_interest<span class="token punctuation">;</span>

stage_name  <span class="token operator">=</span> <span class="token string">"interest 16/8"</span><span class="token punctuation">;</span>  <span class="token comment">//interest 16/8 按双字节替换interest数据变异策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"int16"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历out_buf</span>

  u16 orig <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//判断本次循环中相邻的双字对应在eff_map中的项是否为有效的</span>
    stage_max <span class="token operator">-=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//跳过本次循环</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//遍历interesting_16，这里除以2是因为interesting_16中包含两组数据</span>

    stage_cur_val <span class="token operator">=</span> interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/* Skip if this could be a product of a bitflip, arithmetics,
       or single-byte interesting value insertion. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>orig <span class="token operator">^</span> <span class="token punctuation">(</span>u16<span class="token punctuation">)</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_arith</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token punctuation">(</span>u16<span class="token punctuation">)</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_interest</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token punctuation">(</span>u16<span class="token punctuation">)</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//判断orig ^ (u16)interesting_16[j]是否可以通过bitflip阶段、arith阶段、interest第一阶段可以获得</span>

      stage_val_type <span class="token operator">=</span> STAGE_VAL_LE<span class="token punctuation">;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//如果都不能，则进行替换本次循环中out_buf的双字</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token punctuation">)</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>orig <span class="token operator">^</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_arith</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_interest</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//判断orig ^ SWAP16(interesting_16[j])是否可以通过bitflip阶段、arith阶段、interest第一阶段可以获得（大端）</span>

      stage_val_type <span class="token operator">=</span> STAGE_VAL_BE<span class="token punctuation">;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//替换(大端)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

  <span class="token punctuation">&#125;</span>

  <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig<span class="token punctuation">;</span>  <span class="token comment">//复位</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_INTEREST16<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_INTEREST16]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_INTEREST16<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_INTEREST8]累加interest 16/8变异次数</span></code></pre>



<p><strong>interest 32&#x2F;8</strong></p>
<p>按四字节替换interest数据变异策略</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Setting 32-bit integers, both endians. */</span>

stage_name  <span class="token operator">=</span> <span class="token string">"interest 32/8"</span><span class="token punctuation">;</span>  <span class="token comment">//interest 32/8 按四字节替换interest数据变异策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"int32"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历out_buf</span>

  u32 orig <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Let's consult the effector map... */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eff_map<span class="token punctuation">[</span><span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//判断本次循环中相邻的四字对应在eff_map中的项是否为有效的</span>
    stage_max <span class="token operator">-=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//跳过本次循环</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历interesting_32</span>

    stage_cur_val <span class="token operator">=</span> interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/* Skip if this could be a product of a bitflip, arithmetics,
       or word interesting value insertion. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>orig <span class="token operator">^</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_arith</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_interest</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//判断orig ^ (u32)interesting_32[j]是否可以通过bitflip阶段、arith阶段、interest第一阶段可以获得</span>

      stage_val_type <span class="token operator">=</span> STAGE_VAL_LE<span class="token punctuation">;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//替换四字</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_bitflip</span><span class="token punctuation">(</span>orig <span class="token operator">^</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_arith</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">could_be_interest</span><span class="token punctuation">(</span>orig<span class="token punctuation">,</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//判断orig ^ SWAP32(interesting_32[j])是否可以通过bitflip阶段、arith阶段、interest第一阶段可以获得（大端）</span>

      stage_val_type <span class="token operator">=</span> STAGE_VAL_BE<span class="token punctuation">;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//替换四字（大端）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过</span>

  <span class="token punctuation">&#125;</span>

  <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> orig<span class="token punctuation">;</span>  <span class="token comment">//复位</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_INTEREST32<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_INTEREST32]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_INTEREST32<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_INTEREST32]累加interest 32/8变异次数</span></code></pre>



<h5 id="DICTIONARY-STUFF"><a href="#DICTIONARY-STUFF" class="headerlink" title="DICTIONARY STUFF"></a>DICTIONARY STUFF</h5><p>主要是基于用户提供的extra token来进行一定的变异，主要为替换和插入</p>
<p><strong>user extras (over)</strong></p>
<p>将用户指定的extras token与out_buf进行替换策略</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/********************
 * DICTIONARY STUFF *
 ********************/</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extras_cnt<span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_user_extras<span class="token punctuation">;</span>
<span class="token comment">//如果用户没有通过-x选项指定token，直接跳转至skip_user_extras</span>

<span class="token comment">/* Overwrite with user-supplied extras. */</span>

stage_name  <span class="token operator">=</span> <span class="token string">"user extras (over)"</span><span class="token punctuation">;</span>  <span class="token comment">//以用户token替换out_buf策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"ext_UO"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> extras_cnt <span class="token operator">*</span> len<span class="token punctuation">;</span>

stage_val_type <span class="token operator">=</span> STAGE_VAL_NONE<span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 last_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token comment">/* Extras are sorted by size, from smallest to largest. This means
     that we don't have to worry about restoring the buffer in
     between writes at a particular offset determined by the outer
     loop. */</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> extras_cnt<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历extras token</span>

    <span class="token comment">/* Skip extras probabilistically if extras_cnt > MAX_DET_EXTRAS. Also
       skip them if there's no room to insert the payload, if the token
       is redundant, or if its entire span has no bytes set in the effector
       map. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extras_cnt <span class="token operator">></span> MAX_DET_EXTRAS <span class="token operator">&amp;&amp;</span> <span class="token function">UR</span><span class="token punctuation">(</span>extras_cnt<span class="token punctuation">)</span> <span class="token operator">>=</span> MAX_DET_EXTRAS<span class="token punctuation">)</span> <span class="token operator">||</span>
        extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">></span> len <span class="token operator">-</span> i <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">memcmp</span><span class="token punctuation">(</span>extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">memchr</span><span class="token punctuation">(</span>eff_map <span class="token operator">+</span> <span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">EFF_SPAN_ALEN</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳过本次循环</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    last_len <span class="token operator">=</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> last_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//利用memcpy函数将当前指定的extras token覆写进out_buf中</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
    <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
    <span class="token comment">//返回值为1跳转至abandon_entry</span>
    stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Restore all the clobbered memory. */</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> in_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> last_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//从in_buf中取值恢复out_buf</span>

<span class="token punctuation">&#125;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_EXTRAS_UO<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_EXTRAS_UO]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_EXTRAS_UO<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_EXTRAS_UO]累加user extras (over)变异次数</span></code></pre>



<p><strong>user extras (insert)</strong></p>
<p>以用户token插入out_buf策略</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Insertion of user-supplied extras. */</span>

stage_name  <span class="token operator">=</span> <span class="token string">"user extras (insert)"</span><span class="token punctuation">;</span>  <span class="token comment">//以用户token插入out_buf策略</span>
stage_short <span class="token operator">=</span> <span class="token string">"ext_UI"</span><span class="token punctuation">;</span>
stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
stage_max   <span class="token operator">=</span> extras_cnt <span class="token operator">*</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

ex_tmp <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>len <span class="token operator">+</span> MAX_DICT_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//为ex_tmp开辟空间，后续会以ex_tmp作为输入进行fuzz</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> extras_cnt<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历extras token</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">></span> MAX_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果out_buf长度+token长度大于MAX_FILE（默认1024*1024）</span>
      stage_max<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//跳过本次循环</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Insert token */</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>ex_tmp <span class="token operator">+</span> i<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//利用memcpy在ex_tmp对应位置插入token</span>

    <span class="token comment">/* Copy tail */</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>ex_tmp <span class="token operator">+</span> i <span class="token operator">+</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> len <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在对应位置追加out_buf对应后续的内容</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> ex_tmp<span class="token punctuation">,</span> len <span class="token operator">+</span> extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>ex_tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果返回值为1，释放ex_tmp空间</span>
      <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>  <span class="token comment">//跳转至abandon_entry</span>
    <span class="token punctuation">&#125;</span>

    stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Copy head */</span>
  ex_tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> out_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//将out_buf[i]对应的前置内容赋值给ex_tmp[i]，因为在插入阶段插入的位置是ex_tmp + i，后续补上out_buf + 1的内容</span>

<span class="token punctuation">&#125;</span>

<span class="token function">ck_free</span><span class="token punctuation">(</span>ex_tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

stage_finds<span class="token punctuation">[</span>STAGE_EXTRAS_UI<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
<span class="token comment">//stage_finds[STAGE_EXTRAS_UI]累加出现的新路径与crash次数的和</span>
stage_cycles<span class="token punctuation">[</span>STAGE_EXTRAS_UI<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
<span class="token comment">//stage_cycles[STAGE_EXTRAS_UI]累加user extras (insert)变异次数</span></code></pre>



<p><strong>auto extras (over)</strong></p>
<p>和第一个策略差不多，以a_extras中的token替换out_buf策略</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a_extras_cnt<span class="token punctuation">)</span> <span class="token keyword">goto</span> skip_extras<span class="token punctuation">;</span>
  <span class="token comment">//如果用户没有通过-x选项指定token，直接跳转至skip_user_extras</span>

  stage_name  <span class="token operator">=</span> <span class="token string">"auto extras (over)"</span><span class="token punctuation">;</span>
  <span class="token comment">//替换阶段2，这里替换的不是extras token，而是a_extras token</span>
  stage_short <span class="token operator">=</span> <span class="token string">"ext_AO"</span><span class="token punctuation">;</span>
  stage_cur   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  stage_max   <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>a_extras_cnt<span class="token punctuation">,</span> USE_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token operator">*</span> len<span class="token punctuation">;</span>

  stage_val_type <span class="token operator">=</span> STAGE_VAL_NONE<span class="token punctuation">;</span>

  orig_hit_cnt <span class="token operator">=</span> new_hit_cnt<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u32 last_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    stage_cur_byte <span class="token operator">=</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">MIN</span><span class="token punctuation">(</span>a_extras_cnt<span class="token punctuation">,</span> USE_AUTO_EXTRAS<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//遍历a_extras</span>

      <span class="token comment">/* See the comment in the earlier code; extras are sorted by size. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">></span> len <span class="token operator">-</span> i <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">memcmp</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">memchr</span><span class="token punctuation">(</span>eff_map <span class="token operator">+</span> <span class="token function">EFF_APOS</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">EFF_SPAN_ALEN</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果a_extras大小不满足上述条件</span>

        stage_max<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">//跳出本次循环</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>

      <span class="token punctuation">&#125;</span>

      last_len <span class="token operator">=</span> a_extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> last_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//调用memcpy函数将out_buf位置替换成a_extras token</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>
      <span class="token comment">//调用common_fuzz_stuff进行测试记录</span>
      <span class="token comment">//返回值为1跳转至abandon_entry</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//变异计数器+1</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Restore all the clobbered memory. */</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> in_buf <span class="token operator">+</span> i<span class="token punctuation">,</span> last_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从in_buf中取值恢复out_buf</span>

  <span class="token punctuation">&#125;</span>

  new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  stage_finds<span class="token punctuation">[</span>STAGE_EXTRAS_AO<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
  <span class="token comment">//stage_finds[STAGE_EXTRAS_AO]累加出现的新路径与crash次数的和</span>
  stage_cycles<span class="token punctuation">[</span>STAGE_EXTRAS_AO<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
  <span class="token comment">//stage_cycles[STAGE_EXTRAS_UI]累加auto extras (over)变异次数</span>

skip_extras<span class="token operator">:</span>

  <span class="token comment">/* If we made this to here without jumping to havoc_stage or abandon_entry,
     we're properly done with deterministic steps and can mark it as such
     in the .state/ directory. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue_cur<span class="token operator">-></span>passed_det<span class="token punctuation">)</span> <span class="token function">mark_as_det_done</span><span class="token punctuation">(</span>queue_cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果没有设置queue_cur->passed_det</span>
  <span class="token comment">//调用mark_as_det_done函数对queue进行标记，如.state/目录</span></code></pre>



<h5 id="RANDOM-HAVOC"><a href="#RANDOM-HAVOC" class="headerlink" title="RANDOM HAVOC"></a>RANDOM HAVOC</h5><p>随机毁灭阶段</p>
<p>随机轮次选择随机内容做随机变化</p>
<pre class="language-c" data-language="c"><code class="language-c">  <span class="token comment">/****************
   * RANDOM HAVOC *
   ****************/</span>

havoc_stage<span class="token operator">:</span>

  stage_cur_byte <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">/* The havoc stage mutation code is also invoked when splicing files; if the
     splice_cycle variable is set, generate different descriptions and such. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>splice_cycle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检测splice_cycle</span>

    stage_name  <span class="token operator">=</span> <span class="token string">"havoc"</span><span class="token punctuation">;</span>  <span class="token comment">//标记havoc</span>
    stage_short <span class="token operator">=</span> <span class="token string">"havoc"</span><span class="token punctuation">;</span>  <span class="token comment">//标记此阶段为havoc</span>
    stage_max   <span class="token operator">=</span> <span class="token punctuation">(</span>doing_det <span class="token operator">?</span> HAVOC_CYCLES_INIT <span class="token operator">:</span> HAVOC_CYCLES<span class="token punctuation">)</span> <span class="token operator">*</span>
                  perf_score <span class="token operator">/</span> havoc_div <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> u8 tmp<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    perf_score <span class="token operator">=</span> orig_perf<span class="token punctuation">;</span>

    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"splice %u"</span><span class="token punctuation">,</span> splice_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stage_name  <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    stage_short <span class="token operator">=</span> <span class="token string">"splice"</span><span class="token punctuation">;</span>  <span class="token comment">//否则标记此阶段为splice</span>
    stage_max   <span class="token operator">=</span> SPLICE_HAVOC <span class="token operator">*</span> perf_score <span class="token operator">/</span> havoc_div <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>stage_max <span class="token operator">&lt;</span> HAVOC_MIN<span class="token punctuation">)</span> stage_max <span class="token operator">=</span> HAVOC_MIN<span class="token punctuation">;</span>

  temp_len <span class="token operator">=</span> len<span class="token punctuation">;</span>

  orig_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  havoc_queued <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span>

  <span class="token comment">/* We essentially just do several thousand runs (depending on perf_score)
     where we take the input file and make random stacked tweaks. */</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    u32 use_stacking <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>HAVOC_STACK_POW2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//产生随机数use_stacking,该随机数决定一次stage中变化的次数</span>

    stage_cur_val <span class="token operator">=</span> use_stacking<span class="token punctuation">;</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> use_stacking<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//循环use_stacking次</span>

      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extras_cnt <span class="token operator">+</span> a_extras_cnt<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//根据是否存在extras token来决定UR()函数参数(17或15)，随机产生的值作为变换方式的case选项</span>

        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>

          <span class="token comment">/* Flip a single bit somewhere. Spooky! */</span>

          <span class="token function">FLIP_BIT</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> 
          <span class="token comment">//随机选中interesting_8[]中的随机byte替换out_buf中的随机byte</span>
          <span class="token comment">/* Set byte to interesting value. */</span>

          out_buf<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> interesting_8<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>

          <span class="token comment">/* Set word to interesting value, randomly choosing endian. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//随机选择大小端序后，选中interesting_16[]中的随机word替换out_buf中的随机word</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>
              interesting_16<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>
              interesting_16<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>

          <span class="token comment">/* Set dword to interesting value, randomly choosing endian. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//随机选择大小端序后，选中interesting_32[]中的随机dword替换out_buf中的随机dword</span>
  
            <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>
              interesting_32<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>
              interesting_32<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>

          <span class="token comment">/* Randomly subtract from byte. */</span>
          <span class="token comment">//选择out_buf[]中的随机byte减随机数值</span>

          out_buf<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>

          <span class="token comment">/* Randomly add to byte. */</span>
          <span class="token comment">//选择out_buf[]中的随机byte加随机数值</span>

          out_buf<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>

          <span class="token comment">/* Randomly subtract from word, random endian. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token comment">//随机选择大小端序后，选择out_buf[]中的随机word减随机数值</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">-=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            u16 num <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">=</span>
              <span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>

          <span class="token comment">/* Randomly add to word, random endian. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token comment">//随机选择大小端序后，选择out_buf[]中的随机word加随机数值</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            u16 num <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">=</span>
              <span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token function">SWAP16</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>

          <span class="token comment">/* Randomly subtract from dword, random endian. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token comment">//随机选择大小端序后，选择out_buf[]中的随机dword减随机数值</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">-=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            u32 num <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">=</span>
              <span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>

          <span class="token comment">/* Randomly add to dword, random endian. */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token comment">//随机选择大小端序后，选择out_buf[]中的随机dword加随机数值</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            u32 pos <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            u32 num <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>ARITH_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span> <span class="token operator">=</span>
              <span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token function">SWAP32</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span>

          <span class="token comment">/* Just set a random byte to a random value. Because,
             why not. We use XOR with 1-255 to eliminate the
             possibility of a no-op. */</span>
          <span class="token comment">//选择out_buf[]中的随机byte做异或翻转</span>

          out_buf<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">11</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">12</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">/* Delete bytes. We're making this a bit more likely
               than insertion (the next option) in hopes of keeping
               files reasonably small. */</span>

            u32 del_from<span class="token punctuation">,</span> del_len<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment">/* Don't delete too much. */</span>

            del_len <span class="token operator">=</span> <span class="token function">choose_block_len</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            del_from <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> del_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//选择out_buf[]中的随机byte进行删除</span>

            <span class="token function">memmove</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> del_from<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> del_from <span class="token operator">+</span> del_len<span class="token punctuation">,</span>
                    temp_len <span class="token operator">-</span> del_from <span class="token operator">-</span> del_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            temp_len <span class="token operator">-=</span> del_len<span class="token punctuation">;</span>

            <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

        <span class="token keyword">case</span> <span class="token number">13</span><span class="token operator">:</span>
        <span class="token comment">//选择out_buf[]中的随机位置插入随机长度的内容</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">+</span> HAVOC_BLK_XL <span class="token operator">&lt;</span> MAX_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">/* Clone bytes (75%) or insert a block of constant bytes (25%). */</span>
            <span class="token comment">/*这段内容有75%的概率是out_buf[]中的内容
              有25%的概率是一段相同的随机数字
                这串数字有50%的概率是随机生成的数字
                有50%的概率从out_buf[]中随机选取一个字节*/</span>

            u8  actually_clone <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            u32 clone_from<span class="token punctuation">,</span> clone_to<span class="token punctuation">,</span> clone_len<span class="token punctuation">;</span>
            u8<span class="token operator">*</span> new_buf<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>actually_clone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

              clone_len  <span class="token operator">=</span> <span class="token function">choose_block_len</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
              clone_from <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> clone_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

              clone_len <span class="token operator">=</span> <span class="token function">choose_block_len</span><span class="token punctuation">(</span>HAVOC_BLK_XL<span class="token punctuation">)</span><span class="token punctuation">;</span>
              clone_from <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span>

            clone_to   <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            new_buf <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>temp_len <span class="token operator">+</span> clone_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Head */</span>

            <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> clone_to<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Inserted part */</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>actually_clone<span class="token punctuation">)</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf <span class="token operator">+</span> clone_to<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> clone_from<span class="token punctuation">,</span> clone_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
              <span class="token function">memset</span><span class="token punctuation">(</span>new_buf <span class="token operator">+</span> clone_to<span class="token punctuation">,</span>
                     <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">:</span> out_buf<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> clone_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Tail */</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf <span class="token operator">+</span> clone_to <span class="token operator">+</span> clone_len<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> clone_to<span class="token punctuation">,</span>
                   temp_len <span class="token operator">-</span> clone_to<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">ck_free</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            out_buf <span class="token operator">=</span> new_buf<span class="token punctuation">;</span>
            temp_len <span class="token operator">+=</span> clone_len<span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

          <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">14</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//选择out_buf[]中的随机位置覆盖随机长度的内容</span>

            <span class="token comment">/* Overwrite bytes with a randomly selected chunk (75%) or fixed
               bytes (25%). */</span>
            <span class="token comment">/*这段内容有75%的概率是out_buf[]中的内容
              有25%的概率是一段相同的随机数字
                这串数字有50%的概率是随机生成的数字
                有50%的概率从out_buf[]中随机选取一个字节*/</span>

            u32 copy_from<span class="token punctuation">,</span> copy_to<span class="token punctuation">,</span> copy_len<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            copy_len  <span class="token operator">=</span> <span class="token function">choose_block_len</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            copy_from <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> copy_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            copy_to   <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> copy_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>copy_from <span class="token operator">!=</span> copy_to<span class="token punctuation">)</span>
                <span class="token function">memmove</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> copy_to<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> copy_from<span class="token punctuation">,</span> copy_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token function">memset</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> copy_to<span class="token punctuation">,</span>
                          <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">:</span> out_buf<span class="token punctuation">[</span><span class="token function">UR</span><span class="token punctuation">(</span>temp_len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> copy_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Values 15 and 16 can be selected only if there are any extras
           present in the dictionaries. */</span>

        <span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//随机选取一段内容覆盖成extra token，token来自a_extras[use_extra].data或者extras[use_extra].data</span>

            <span class="token comment">/* Overwrite bytes with an extra. */</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extras_cnt <span class="token operator">||</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">&amp;&amp;</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

              <span class="token comment">/* No user-specified extras or odds in our favor. Let's use an
                 auto-detected one. */</span>

              u32 use_extra <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
              u32 extra_len <span class="token operator">=</span> a_extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>
              u32 insert_at<span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>extra_len <span class="token operator">></span> temp_len<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

              insert_at <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> extra_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> insert_at<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> extra_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

              <span class="token comment">/* No auto extras or odds in our favor. Use the dictionary. */</span>

              u32 use_extra <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
              u32 extra_len <span class="token operator">=</span> extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>
              u32 insert_at<span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>extra_len <span class="token operator">></span> temp_len<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

              insert_at <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">-</span> extra_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf <span class="token operator">+</span> insert_at<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> extra_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span>

            <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

        <span class="token keyword">case</span> <span class="token number">16</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//随机选取一段内容插入extra token，token来自a_extras[use_extra].data或者extras[use_extra].data</span>

            u32 use_extra<span class="token punctuation">,</span> extra_len<span class="token punctuation">,</span> insert_at <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>temp_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            u8<span class="token operator">*</span> new_buf<span class="token punctuation">;</span>

            <span class="token comment">/* Insert an extra. Do the same dice-rolling stuff as for the
               previous case. */</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extras_cnt <span class="token operator">||</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">&amp;&amp;</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

              use_extra <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
              extra_len <span class="token operator">=</span> a_extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">+</span> extra_len <span class="token operator">>=</span> MAX_FILE<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

              new_buf <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>temp_len <span class="token operator">+</span> extra_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">/* Head */</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> insert_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">/* Inserted part */</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf <span class="token operator">+</span> insert_at<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> extra_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

              use_extra <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
              extra_len <span class="token operator">=</span> extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">+</span> extra_len <span class="token operator">>=</span> MAX_FILE<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

              new_buf <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>temp_len <span class="token operator">+</span> extra_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">/* Head */</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> insert_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">/* Inserted part */</span>
              <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf <span class="token operator">+</span> insert_at<span class="token punctuation">,</span> extras<span class="token punctuation">[</span>use_extra<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> extra_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span>

            <span class="token comment">/* Tail */</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf <span class="token operator">+</span> insert_at <span class="token operator">+</span> extra_len<span class="token punctuation">,</span> out_buf <span class="token operator">+</span> insert_at<span class="token punctuation">,</span>
                   temp_len <span class="token operator">-</span> insert_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">ck_free</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            out_buf   <span class="token operator">=</span> new_buf<span class="token punctuation">;</span>
            temp_len <span class="token operator">+=</span> extra_len<span class="token punctuation">;</span>

            <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token punctuation">&#125;</span>

      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token comment">//循环叠加变换use_stacking次</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> temp_len<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//调用common_fuzz_stuff进行记录和测试</span>
    <span class="token comment">//返回值为1调用abandon_entry</span>
      <span class="token keyword">goto</span> abandon_entry<span class="token punctuation">;</span>

    <span class="token comment">/* out_buf might have been mangled a bit, so let's restore it to its
       original size and shape. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> out_buf <span class="token operator">=</span> <span class="token function">ck_realloc</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    temp_len <span class="token operator">=</span> len<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* If we're finding new stuff, let's run for a bit longer, limits
       permitting. */</span>
    <span class="token comment">//fuzz后queued_paths和havoc_queued不一样==》说明发现了新路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queued_paths <span class="token operator">!=</span> havoc_queued<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>perf_score <span class="token operator">&lt;=</span> HAVOC_MAX_MULT <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stage_max  <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">//更新stage_max</span>
        perf_score <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">//更新perf_score</span>
      <span class="token punctuation">&#125;</span>

      havoc_queued <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span>  <span class="token comment">//更新havoc_queued</span>

    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>

  new_hit_cnt <span class="token operator">=</span> queued_paths <span class="token operator">+</span> unique_crashes<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>splice_cycle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    stage_finds<span class="token punctuation">[</span>STAGE_HAVOC<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
    <span class="token comment">//stage_finds[STAGE_EXTRAS_UI]累加出现的新路径与crash次数的和</span>
    stage_cycles<span class="token punctuation">[</span>STAGE_HAVOC<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
    <span class="token comment">//stage_cycles[STAGE_EXTRAS_UI]累加user extras (insert)变异次数</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    stage_finds<span class="token punctuation">[</span>STAGE_SPLICE<span class="token punctuation">]</span>  <span class="token operator">+=</span> new_hit_cnt <span class="token operator">-</span> orig_hit_cnt<span class="token punctuation">;</span>
    <span class="token comment">//stage_finds[STAGE_EXTRAS_UI]累加出现的新路径与crash次数的和</span>
    stage_cycles<span class="token punctuation">[</span>STAGE_SPLICE<span class="token punctuation">]</span> <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>
    <span class="token comment">//stage_cycles[STAGE_EXTRAS_UI]累加user extras (insert)变异次数</span>
  <span class="token punctuation">&#125;</span></code></pre>



<h5 id="SPLICING"><a href="#SPLICING" class="headerlink" title="SPLICING"></a>SPLICING</h5><p>在经历RANDOM HAVOC阶段后没有什么效果&#x3D;&#x3D;》</p>
<p>进入SPLICING阶段&#x3D;&#x3D;》尝试拼接两个测试用例中的内容&#x3D;&#x3D;》</p>
<p>拼接完成重新执行一遍RANDOM HAVOC阶段</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">IGNORE_FINDS</span></span>

  <span class="token comment">/************
   * SPLICING *
   ************/</span>

  <span class="token comment">/* This is a last-resort strategy triggered by a full round with no findings.
     It takes the current input file, randomly selects another input, and
     splices them together at some offset, then relies on the havoc
     code to mutate that blob. */</span>

retry_splicing<span class="token operator">:</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>use_splicing <span class="token operator">&amp;&amp;</span> splice_cycle<span class="token operator">++</span> <span class="token operator">&lt;</span> SPLICE_CYCLES <span class="token operator">&amp;&amp;</span>
      queued_paths <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> queue_cur<span class="token operator">-></span>len <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果存在外部输入的fuzzer且数量&lt;SPLICE_CYCLES(默认为15)且queue数量>1且长度>1</span>

    <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> target<span class="token punctuation">;</span>
    u32 tid<span class="token punctuation">,</span> split_at<span class="token punctuation">;</span>
    u8<span class="token operator">*</span> new_buf<span class="token punctuation">;</span>
    s32 f_diff<span class="token punctuation">,</span> l_diff<span class="token punctuation">;</span>

    <span class="token comment">/* First of all, if we've modified in_buf for havoc, let's clean that
       up... */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>in_buf <span class="token operator">!=</span> orig_in<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果在经历过havoc阶段后修改过in_buf，那么在这里就需要清理一下in_buf，并重新给in_buf赋值成orig_in</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>in_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      in_buf <span class="token operator">=</span> orig_in<span class="token punctuation">;</span>
      len <span class="token operator">=</span> queue_cur<span class="token operator">-></span>len<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Pick a random queue entry and seek to it. Don't splice with yourself. */</span>

    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> tid <span class="token operator">=</span> <span class="token function">UR</span><span class="token punctuation">(</span>queued_paths<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>tid <span class="token operator">==</span> current_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    splicing_with <span class="token operator">=</span> tid<span class="token punctuation">;</span>
    target <span class="token operator">=</span> queue<span class="token punctuation">;</span>  <span class="token comment">//随机在queue中挑选一个target</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>tid <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> target <span class="token operator">=</span> target<span class="token operator">-></span>next_100<span class="token punctuation">;</span> tid <span class="token operator">-=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token comment">//纠正target取处</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tid<span class="token operator">--</span><span class="token punctuation">)</span> target <span class="token operator">=</span> target<span class="token operator">-></span>next<span class="token punctuation">;</span>

    <span class="token comment">/* Make sure that the target has a reasonable length. */</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>target <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>target<span class="token operator">-></span>len <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> target <span class="token operator">==</span> queue_cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//确保target长度合法</span>
      target <span class="token operator">=</span> target<span class="token operator">-></span>next<span class="token punctuation">;</span>
      splicing_with<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">)</span> <span class="token keyword">goto</span> retry_splicing<span class="token punctuation">;</span>

    <span class="token comment">/* Read the testcase into a new buffer. */</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>target<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//以只读方式打开target</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> target<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//没打开则抛出异常</span>

    new_buf <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>target<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建target长度空间</span>

    <span class="token function">ck_read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> new_buf<span class="token punctuation">,</span> target<span class="token operator">-></span>len<span class="token punctuation">,</span> target<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将target中的内容督导new_buf内存空间里</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Find a suitable splicing location, somewhere between the first and
       the last differing byte. Bail out if the difference is just a single
       byte or so. */</span>

    <span class="token function">locate_diffs</span><span class="token punctuation">(</span>in_buf<span class="token punctuation">,</span> new_buf<span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> target<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>f_diff<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拼接in_buf和new_buf的辅助函数</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>f_diff <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> l_diff <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> f_diff <span class="token operator">==</span> l_diff<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果被拼接文件只有一个字节左右的长度，那么就退出splicing阶段</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>new_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> retry_splicing<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Split somewhere between the first and last differing byte. */</span>

    split_at <span class="token operator">=</span> f_diff <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span>l_diff <span class="token operator">-</span> f_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//随机在第一个字节和最后一个字节之间选取一个位置</span>

    <span class="token comment">/* Do the thing. */</span>

    len <span class="token operator">=</span> target<span class="token operator">-></span>len<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>new_buf<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> split_at<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用memcpy函数在new_buf的split_at位置拼接in_buf</span>
    in_buf <span class="token operator">=</span> new_buf<span class="token punctuation">;</span>  <span class="token comment">//更新in_buf</span>

    <span class="token function">ck_free</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//释放out_buf</span>
    out_buf <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//重新创建一个len长度的内存空间out_buf</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将拼接后的in_buf拷贝到out_buf中</span>

    <span class="token keyword">goto</span> havoc_stage<span class="token punctuation">;</span>  <span class="token comment">//重新执行havoc阶段</span>

  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* !IGNORE_FINDS */</span></span>

  ret_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//设置ret_val为0</span>

abandon_entry<span class="token operator">:</span>  <span class="token comment">//abandon_entry阶段</span>

  splicing_with <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">/* Update pending_not_fuzzed count if we made it through the calibration
     cycle and have not seen this entry before. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>queue_cur<span class="token operator">-></span>cal_failed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>queue_cur<span class="token operator">-></span>was_fuzzed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果没有中断，且queue没有校准失败，且没有被fuzz过</span>
    queue_cur<span class="token operator">-></span>was_fuzzed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//标记当前queue已经被fuzz过了</span>
    pending_not_fuzzed<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">//pending_not_fuzzed计数器-1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cur<span class="token operator">-></span>favored<span class="token punctuation">)</span> pending_favored<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">//如果当前queue是favored</span>
    <span class="token comment">//pending_favored-1</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">munmap</span><span class="token punctuation">(</span>orig_in<span class="token punctuation">,</span> queue_cur<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_buf <span class="token operator">!=</span> orig_in<span class="token punctuation">)</span> <span class="token function">ck_free</span><span class="token punctuation">(</span>in_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//清理缓存</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>eff_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> ret_val<span class="token punctuation">;</span>  <span class="token comment">//返回ret_val</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">FLIP_BIT</span></span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="trim-case"><a href="#trim-case" class="headerlink" title="trim_case"></a>trim_case</h4><p>对case进行修剪，在TRIMMING中被调用</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Trim all new test cases to save cycles when doing deterministic checks. The
   trimmer uses power-of-two increments somewhere between 1/16 and 1/1024 of
   file size, to keep the stage short and sweet. */</span>
<span class="token comment">//对case进行修剪</span>
<span class="token keyword">static</span> u8 <span class="token function">trim_case</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8<span class="token operator">*</span> in_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 tmp<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> u8 clean_trace<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  u8  needs_write <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> fault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u32 trim_exec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u32 remove_len<span class="token punctuation">;</span>
  u32 len_p2<span class="token punctuation">;</span>

  <span class="token comment">/* Although the trimmer will be less useful when variable behavior is
     detected, it will still work to some extent, so we don't check for
     this. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>len <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//如果case的len小于5字节，就不需要进行修剪</span>
  <span class="token comment">//直接返回0</span>

  stage_name <span class="token operator">=</span> tmp<span class="token punctuation">;</span>  <span class="token comment">//让stage_name指向tmp数组首位</span>
  bytes_trim_in <span class="token operator">+=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>  <span class="token comment">//bytes_trim_in累加q->len</span>

  <span class="token comment">/* Select initial chunk len, starting with large steps. */</span>

  len_p2 <span class="token operator">=</span> <span class="token function">next_p2</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//len_p2为大于等于q->len的第一个2的幂次</span>

  remove_len <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>len_p2 <span class="token operator">/</span> TRIM_START_STEPS<span class="token punctuation">,</span> TRIM_MIN_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//remove_len取len_p2/16或4之间最大的那个，作为初始步长</span>

  <span class="token comment">/* Continue until the number of steps gets too high or the stepover
     gets too small. */</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>remove_len <span class="token operator">>=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>len_p2 <span class="token operator">/</span> TRIM_END_STEPS<span class="token punctuation">,</span> TRIM_MIN_BYTES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果remove_len大于等于(len_p2/1024)和(4)之间最大的</span>

    u32 remove_pos <span class="token operator">=</span> remove_len<span class="token punctuation">;</span>
    <span class="token comment">//设置remove_pos为remove_len</span>

    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"trim %s/%s"</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用sprintf格式化字符串到tmp变量中</span>

    stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    stage_max <span class="token operator">=</span> q<span class="token operator">-></span>len <span class="token operator">/</span> remove_len<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>remove_pos <span class="token operator">&lt;</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//循环每次前进remove_len个步长，直到整个文件都被遍历完为止</span>

      u32 trim_avail <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">,</span> q<span class="token operator">-></span>len <span class="token operator">-</span> remove_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
      u32 cksum<span class="token punctuation">;</span>

      <span class="token function">write_with_gap</span><span class="token punctuation">(</span>in_buf<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">,</span> remove_pos<span class="token punctuation">,</span> trim_avail<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//有in_buf中的remove_pos处开始，向后跳过remove_len个字节，写入到.cur_input中</span>

      fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//调用run_target，返回值赋值给fault中</span>
      trim_execs<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//trim_execs计数器+1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> fault <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> abort_trimming<span class="token punctuation">;</span>
      <span class="token comment">//如果主动中断，或返回值报错，直接跳转至abort_trimming</span>

      <span class="token comment">/* Note that we don't keep track of crashes or hangs here; maybe TODO? */</span>

      cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用hash32进行计算</span>

      <span class="token comment">/* If the deletion had no impact on the trace, make it permanent. This
         isn't perfect for variable-path inputs, but we're just making a
         best-effort pass, so it's not a big deal if we end up with false
         negatives every now and then. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cksum <span class="token operator">==</span> q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//判断校验值如果相等</span>

        u32 move_tail <span class="token operator">=</span> q<span class="token operator">-></span>len <span class="token operator">-</span> remove_pos <span class="token operator">-</span> trim_avail<span class="token punctuation">;</span>
        <span class="token comment">//从q->len中减去remove_len个字节</span>

        q<span class="token operator">-></span>len <span class="token operator">-=</span> trim_avail<span class="token punctuation">;</span>
        len_p2  <span class="token operator">=</span> <span class="token function">next_p2</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//并重新计算出一个len_p2</span>

        <span class="token function">memmove</span><span class="token punctuation">(</span>in_buf <span class="token operator">+</span> remove_pos<span class="token punctuation">,</span> in_buf <span class="token operator">+</span> remove_pos <span class="token operator">+</span> trim_avail<span class="token punctuation">,</span> 
                move_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将in_buf + remove_pos + trim_avail到最后的字节前移到in_buf + remove_pos处</span>
        <span class="token comment">//即删除了remove_pos向后的remove_len个字节</span>

        <span class="token comment">/* Let's save a clean trace, which will be needed by
           update_bitmap_score once we're done with the trimming stuff. */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needs_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果needs_write为0</span>

          needs_write <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置needs_write为1</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span>clean_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//保存当前的trace_bits到clean_trace中</span>

        <span class="token punctuation">&#125;</span>

      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> remove_pos <span class="token operator">+=</span> remove_len<span class="token punctuation">;</span>
      <span class="token comment">//如果不为0</span>
      <span class="token comment">//remove_pos累加remove_len，即前移remove_len个字节，如果相等则无需前移</span>

      <span class="token comment">/* Since this can be slow, update the screen every now and then. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>trim_exec<span class="token operator">++</span> <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>、
      <span class="token comment">//在trim过程中，每执行stats_update_freq次</span>
      <span class="token comment">//刷新一次界面</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//stage_cur计数器+1</span>

    <span class="token punctuation">&#125;</span>

    remove_len <span class="token operator">>>=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//remove_len减半</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* If we have made changes to in_buf, we also need to update the on-disk
     version of the test case. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    s32 fd<span class="token punctuation">;</span>

    <span class="token function">unlink</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* ignore errors 删除原来的q->fname */</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建一个新的q->fname</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将in_buf里的内容写入</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> clean_trace<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//利用clean_trace恢复trace_bits</span>
    <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

abort_trimming<span class="token operator">:</span>

  bytes_trim_out <span class="token operator">+=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>
  <span class="token keyword">return</span> fault<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="calculate-score"><a href="#calculate-score" class="headerlink" title="calculate_score"></a>calculate_score</h4><p>根据queue entry的执行速度，覆盖到的path数和路径深度来评估出一个得分&#x3D;&#x3D;》</p>
<p>该得分perf_score在后面havoc的时候使用</p>
<p>在PERFORMANCE SCORE中被引用</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Calculate case desirability score to adjust the length of havoc fuzzing.
   A helper function for fuzz_one(). Maybe some of these constants should
   go into config.h. */</span>

<span class="token keyword">static</span> u32 <span class="token function">calculate_score</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 avg_exec_us <span class="token operator">=</span> total_cal_us <span class="token operator">/</span> total_cal_cycles<span class="token punctuation">;</span>  <span class="token comment">//计算平均时间</span>
  u32 avg_bitmap_size <span class="token operator">=</span> total_bitmap_size <span class="token operator">/</span> total_bitmap_entries<span class="token punctuation">;</span>  <span class="token comment">//计算平均bitmap大小</span>
  u32 perf_score <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token comment">//设置初始值perf_score为100</span>

  <span class="token comment">/* Adjust score based on execution speed of this path, compared to the
     global average. Multiplier ranges from 0.1x to 3x. Fast inputs are
     less expensive to fuzz, so we're giving them more air time. */</span>

  <span class="token comment">/*以q->exec_us乘以一个系数==》判断和avg_exec_us的大小调整perf_score*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">0.1</span> <span class="token operator">></span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">0.25</span> <span class="token operator">></span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">></span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">0.75</span> <span class="token operator">></span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">75</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">&lt;</span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">&lt;</span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_us <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;</span> avg_exec_us<span class="token punctuation">)</span> perf_score <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

  <span class="token comment">/* Adjust score based on bitmap size. The working theory is that better
     coverage translates to better targets. Multiplier from 0.25x to 3x. */</span>

  <span class="token comment">/*以q->bitmap_size乘以一个系数==》判断与avg_bitmap_size的大小来调整perf_score*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">*</span> <span class="token number">0.3</span> <span class="token operator">></span> avg_bitmap_size<span class="token punctuation">)</span> perf_score <span class="token operator">*=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">></span> avg_bitmap_size<span class="token punctuation">)</span> perf_score <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">*</span> <span class="token number">0.75</span> <span class="token operator">></span> avg_bitmap_size<span class="token punctuation">)</span> perf_score <span class="token operator">*=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">&lt;</span> avg_bitmap_size<span class="token punctuation">)</span> perf_score <span class="token operator">*=</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;</span> avg_bitmap_size<span class="token punctuation">)</span> perf_score <span class="token operator">*=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>bitmap_size <span class="token operator">*</span> <span class="token number">1.5</span> <span class="token operator">&lt;</span> avg_bitmap_size<span class="token punctuation">)</span> perf_score <span class="token operator">*=</span> <span class="token number">0.75</span><span class="token punctuation">;</span>

  <span class="token comment">/* Adjust score based on handicap. Handicap is proportional to how late
     in the game we learned about this path. Latecomers are allowed to run
     for a bit longer until they catch up with the rest. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>handicap <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//q->handicap大于等于4</span>

    perf_score <span class="token operator">*=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    q<span class="token operator">-></span>handicap <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>handicap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果q->handicap不为0</span>

    perf_score <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    q<span class="token operator">-></span>handicap<span class="token operator">--</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Final adjustment based on input depth, under the assumption that fuzzing
     deeper test cases is more likely to reveal stuff that can't be
     discovered with traditional fuzzers. */</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>depth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//通过深度来调整perf_score</span>

    <span class="token keyword">case</span> <span class="token number">0</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">3</span><span class="token operator">:</span>   <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">7</span><span class="token operator">:</span>   perf_score <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">8</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">13</span><span class="token operator">:</span>  perf_score <span class="token operator">*=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">14</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">25</span><span class="token operator">:</span> perf_score <span class="token operator">*=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>        perf_score <span class="token operator">*=</span> <span class="token number">5</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Make sure that we don't go over limit. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>perf_score <span class="token operator">></span> HAVOC_MAX_MULT <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> perf_score <span class="token operator">=</span> HAVOC_MAX_MULT <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token comment">//确保调整后的值不会超过最大的接线</span>

  <span class="token keyword">return</span> perf_score<span class="token punctuation">;</span>  <span class="token comment">//返回perf_score</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="common-fuzz-stuff"><a href="#common-fuzz-stuff" class="headerlink" title="common_fuzz_stuff"></a>common_fuzz_stuff</h4><p>写入文件执行后判断返回结果</p>
<p>在SIMPLE BITFLIP中被调用</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Write a modified test case, run program, process results. Handle
   error conditions, returning 1 if it's time to bail out. This is
   a helper function for fuzz_one(). */</span>

EXP_ST u8 <span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u8<span class="token operator">*</span> out_buf<span class="token punctuation">,</span> u32 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 fault<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>post_handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果定义了post_handler</span>

    out_buf <span class="token operator">=</span> <span class="token function">post_handler</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用post_handler返回out_buf</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_buf <span class="token operator">||</span> <span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//如果out_buf或len其中一个为0</span>
    <span class="token comment">//直接返回0</span>

  <span class="token punctuation">&#125;</span>

  <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//写入</span>

  fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//run_target运行一下返回结果</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//如果主动中断</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fault <span class="token operator">==</span> FAULT_TMOUT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果fault值为FAULT_TMOUT</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>subseq_tmouts<span class="token operator">++</span> <span class="token operator">></span> TMOUT_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//TMOUT_LIMIT（默认250）</span>
      cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> subseq_tmouts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//当返回结果为其他时</span>
  <span class="token comment">//设置连续超时计数器为0</span>

  <span class="token comment">/* Users can hit us with SIGUSR1 to request the current input
     to be abandoned. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_requested<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果设置了skip_requested</span>

     skip_requested <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//skip_requested清0</span>
     cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//cur_skipped_paths计数器+1</span>
     <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* This handles FAULT_ERROR for us: */</span>

  queued_discovered <span class="token operator">+=</span> <span class="token function">save_if_interesting</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fault<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果发现了新的路径queued_discovered+1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>stage_cur <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span> <span class="token operator">||</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> stage_max<span class="token punctuation">)</span>
    <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果stage_cur除以stats_update_freq余数是0，或者其加一等于stage_max</span>
    <span class="token comment">//更新展示界面show_stats</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="sync-fuzzers："><a href="#sync-fuzzers：" class="headerlink" title="sync_fuzzers："></a>sync_fuzzers：</h4><p>首先查找有哪些fuzzer文件夹&#x3D;&#x3D;》读取其他fuzzer文件夹下的queue文件夹里的case&#x3D;&#x3D;》</p>
<p>依次执行&#x3D;&#x3D;》如果发现了新的path&#x3D;&#x3D;》保存在自己的queue文件夹里&#x3D;&#x3D;》</p>
<p>将最后一个sync的case id写入到**.synced&#x2F;其他fuzzer**文件里</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Grab interesting test cases from other fuzzers. */</span>
<span class="token comment">////读取sync文件夹写的queue文件，保存到自己的queue中</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  DIR<span class="token operator">*</span> sd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> sd_ent<span class="token punctuation">;</span>
  u32 sync_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  sd <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//尝试打开sync_dir目录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sd<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//打开失败则抛出异常</span>

  stage_max <span class="token operator">=</span> stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  cur_depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Look at the entries created for every other fuzzer in the sync directory. */</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sd_ent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//循环读取该文件夹下的目录和文件</span>

    <span class="token keyword">static</span> u8 stage_tmp<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    DIR<span class="token operator">*</span> qd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> qd_ent<span class="token punctuation">;</span>
    u8 <span class="token operator">*</span>qd_path<span class="token punctuation">,</span> <span class="token operator">*</span>qd_synced_path<span class="token punctuation">;</span>
    u32 min_accept <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> next_min_accept<span class="token punctuation">;</span>

    s32 id_fd<span class="token punctuation">;</span>

    <span class="token comment">/* Skip dot files and our own output directory. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token comment">//跳过“.”文件和sync_id（输出文件夹）</span>

    <span class="token comment">/* Skip anything that doesn't have a queue/ subdirectory. */</span>

    qd_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s/queue"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拼接sync_dir/sd_ent->d_name/queue路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>qd <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//尝试打开路径，如果失败则退出本次循环</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Retrieve the ID of the last seen test case. */</span>

    qd_synced_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.synced/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拼接out_dir/.synced/sd_ent->d_name目录</span>

    id_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>qd_synced_path<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//尝试打开拼接目录</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//打开失败则抛出异常</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_accept<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token comment">//从id_fd中读取4个字节到min_accept中</span>
      <span class="token function">lseek</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果成功读取，调动lseek函数调整文件内指针到开头</span>

    next_min_accept <span class="token operator">=</span> min_accept<span class="token punctuation">;</span>
    <span class="token comment">//更新next_min_accept，该变量代表之前从这个文件夹里读取到的最后一个queue的id</span>

    <span class="token comment">/* Show stats */</span>    

    <span class="token function">sprintf</span><span class="token punctuation">(</span>stage_tmp<span class="token punctuation">,</span> <span class="token string">"sync %u"</span><span class="token punctuation">,</span> <span class="token operator">++</span>sync_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//sync_cnt计数器+1，"sync %u"格式化到stage_tmp中</span>
    stage_name <span class="token operator">=</span> stage_tmp<span class="token punctuation">;</span>
    stage_cur  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    stage_max  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* For every file queued by this fuzzer, parse ID and see if we have looked at
       it before; exec a test case if not. */</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>qd_ent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>qd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//循环读取sync_dir/sd_ent->d_name/queue文件夹中的目录和文件</span>

      u8<span class="token operator">*</span> path<span class="token punctuation">;</span>
      s32 fd<span class="token punctuation">;</span>
      <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span>
          <span class="token function">sscanf</span><span class="token punctuation">(</span>qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">,</span> CASE_PREFIX <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>syncing_case<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> 
          syncing_case <span class="token operator">&lt;</span> min_accept<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token comment">//如果文件是以“.”开头，或者syncing_case标识小于min_accept文件，因为这些文件已经被sync过了，则跳出本次循环</span>

      <span class="token comment">/* OK, sounds like a new one. Let's give it a try. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>syncing_case <span class="token operator">>=</span> next_min_accept<span class="token punctuation">)</span>
      <span class="token comment">//如果syncing_case标识大于等于next_min_accept</span>
        next_min_accept <span class="token operator">=</span> syncing_case <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//设置next_min_accept为syncing_case + 1，标明next</span>

      path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> qd_path<span class="token punctuation">,</span> qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//拼接路径qd_path/qd_ent->d_name</span>

      <span class="token comment">/* Allow this to fail in case the other fuzzer is resuming or so... */</span>

      fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打开路径</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//打开路径失败</span>
         <span class="token function">ck_free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//释放path，跳出本次循环</span>
         <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fstat() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* Ignore zero-sized or oversized files. */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">&amp;&amp;</span> st<span class="token punctuation">.</span>st_size <span class="token operator">&lt;=</span> MAX_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果文件大小不为0，且小于MAX_FILE（默认1024 * 1024）</span>

        u8  fault<span class="token punctuation">;</span>
        u8<span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将文件中的内容映射进内存中</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to mmap '%s'"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//内存映射报错抛异常</span>

        <span class="token comment">/* See what happens. We rely on save_if_interesting() to catch major
           errors and save the test case. */</span>

        <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过write_to_testcase将mem写到out_file中</span>

        fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//运行对应文件，返回值赋值给fault</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment">//如果中断，直接返回</span>

        syncing_party <span class="token operator">=</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">;</span>
        <span class="token comment">//通过save_if_interesting来决定是否要将这个queue导入到自己的queue里，如果发现了新的path，就导入</span>
        queued_imported <span class="token operator">+=</span> <span class="token function">save_if_interesting</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> fault<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果返回值为1，则queued_imported计数器+1</span>
        syncing_party <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">munmap</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>stage_cur<span class="token operator">++</span> <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//stage_cur计数器+1，如果stage_cur是stats_update_freq的倍数，就刷新一次界面</span>

      <span class="token punctuation">&#125;</span>

      <span class="token function">ck_free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token function">ck_write</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_min_accept<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">,</span> qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//向当前id_fd中写入当前的next_min_accept值</span>

    <span class="token function">close</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">closedir</span><span class="token punctuation">(</span>qd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">&#125;</span>  

  <span class="token function">closedir</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>



<h4 id="save-if-interesting"><a href="#save-if-interesting" class="headerlink" title="save_if_interesting"></a>save_if_interesting</h4><p>检查这个case的执行结果是否是interesting的，决定是否保存或跳过</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check if the result of an execve() during routine fuzzing is interesting,
   save or queue the input test case for further analysis if so. Returns 1 if
   entry is saved, 0 otherwise. */</span>

<span class="token keyword">static</span> u8 <span class="token function">save_if_interesting</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">,</span> u8 fault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8  <span class="token operator">*</span>fn <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  u8  hnb<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">;</span>
  u8  keeping <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> res<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fault <span class="token operator">==</span> crash_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//如果fault为crash_mode模式</span>

    <span class="token comment">/* Keep only if there are new bits in the map, add to queue for
       future fuzzing, etc. */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//检查是否出现了new bits</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> total_crashes<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">//没有出现的话，如果设置了crash_mode</span>
      <span class="token comment">//total_crashes计数器+1</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token comment">//如果没有设置crash_mode返回0</span>
    <span class="token punctuation">&#125;</span>    

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES  </span><span class="token comment">//如果出现了new bits</span></span>

    fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id:%06u,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> queued_paths<span class="token punctuation">,</span>
                      <span class="token function">describe_op</span><span class="token punctuation">(</span>hnb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拼接路径out_dir/queue/id:00000queued_paths,describe_op(hnb)</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

    fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> queued_paths<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

    <span class="token function">add_to_queue</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用add_to_queue将拼接路径加入到队列中</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      queue_top<span class="token operator">-></span>has_new_cov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      queued_with_cov<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    queue_top<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//利用hash32计算trace_bits，赋值给exec_cksum</span>

    <span class="token comment">/* Try to calibrate inline; this also calls update_bitmap_score() when
       successful. */</span>

    res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> queue_top<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> queue_cycle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用calibrate_case函数对新添加的queue进行校验</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果校验返回值为FAULT_ERROR，抛异常</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//打开拼接路径，将mem的内容写入文件fn</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    keeping <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//设置keeping为1</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>fault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//通过Switch判断fault类型做进一步处理</span>

    <span class="token keyword">case</span> FAULT_TMOUT<span class="token operator">:</span>  <span class="token comment">//fault == FAULT_TMOUT时</span>

      <span class="token comment">/* Timeouts are not very interesting, but we're still obliged to keep
         a handful of samples. We use the presence of new bits in the
         hang-specific bitmap as a signal of uniqueness. In "dumb" mode, we
         just keep everything. */</span>

      total_tmouts<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//设置total_tmouts计数器+1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>unique_hangs <span class="token operator">>=</span> KEEP_UNIQUE_HANG<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
      <span class="token comment">//如果unique_hangs的个数超过能保存的最大数量KEEP_UNIQUE_HANG(默认为500)</span>
      <span class="token comment">//直接返回keeping</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果不是dumb_mode</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">WORD_SIZE_64</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^WORD_SIZE_64 */</span></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_tmout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
        <span class="token comment">//如果没有新的超时路径</span>
        <span class="token comment">//直接返回keeping</span>

      <span class="token punctuation">&#125;</span>

      unique_tmouts<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//unique_tmouts计数器+1</span>

      <span class="token comment">/* Before saving, we make sure that it's a genuine hang by re-running
         the target with a more generous timeout (unless the default timeout
         is already generous). */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">&lt;</span> hang_tmout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果exec_tmout &lt; hang_tmout</span>

        u8 new_fault<span class="token punctuation">;</span>
        <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将mem写入out_file</span>
        new_fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> hang_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用run_target运行一次，返回new_fault</span>

        <span class="token comment">/* A corner case that one user reported bumping into: increasing the
           timeout actually uncovers a crash. Make sure we don't discard it if
           so. */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> new_fault <span class="token operator">==</span> FAULT_CRASH<span class="token punctuation">)</span> <span class="token keyword">goto</span> keep_as_crash<span class="token punctuation">;</span>
        <span class="token comment">//如果没有发生主动中断，并且new_fault的结果为FAULT_CRASH，那么直接跳转到keep_as_crash</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> new_fault <span class="token operator">!=</span> FAULT_TMOUT<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
        <span class="token comment">//如果发生主动中断或者new_fault的结果不为FAULT_CRASH，直接返回keeping</span>

      <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>

      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs/id:%06llu,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span>
                        unique_hangs<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//拼接字符串fn:out_dir/hangs/id:000000unique_hangs,describe_op(0)</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs/id_%06llu"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span>
                        unique_hangs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

      unique_hangs<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//unique_hangs计数器+1</span>

      last_hang_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//更新last_hang_time的值并保存找到fn中</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> FAULT_CRASH<span class="token operator">:</span> <span class="token comment">//fault == FAULT_CRASH时</span>

keep_as_crash<span class="token operator">:</span>

      <span class="token comment">/* This is handled in a manner roughly similar to timeouts,
         except for slightly different limits and no need to re-run test
         cases. */</span>

      total_crashes<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//total_crashes计数器+1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>unique_crashes <span class="token operator">>=</span> KEEP_UNIQUE_CRASH<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
      <span class="token comment">//如果unique_crashes数量大于等于能保存的最大数量KEEP_UNIQUE_CRASH(默认5000)</span>
      <span class="token comment">//直接返回keeping</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果不是dumb_mode</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">WORD_SIZE_64</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用simplify_trace对trace_bits进行调整</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^WORD_SIZE_64 */</span></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_crash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
        <span class="token comment">//如果没有发现新的crash路径</span>
        <span class="token comment">//直接返回keeping</span>

      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unique_crashes<span class="token punctuation">)</span> <span class="token function">write_crash_readme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果unique_crashes为0</span>
      <span class="token comment">//调用write_crash_readme编写崩溃目录信息</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>

      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes/id:%06llu,sig:%02u,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span>
                        unique_crashes<span class="token punctuation">,</span> kill_signal<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//拼接路径</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes/id_%06llu_%02u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">,</span>
                        kill_signal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//拼接路径</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

      unique_crashes<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">//unique_crashes计数器+1</span>

      last_crash_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//更新last_crash_time时间</span>
      last_crash_execs <span class="token operator">=</span> total_execs<span class="token punctuation">;</span>  <span class="token comment">//更新last_crash_execs</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> FAULT_ERROR<span class="token operator">:</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果fault == FAULT_ERROR，抛出异常</span>

    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span><span class="token comment">//对于其他情况直接返回keeping</span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* If we're here, we apparently want to save the crash or hang
     test case, too. */</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/04/20/CVE-2019%E2%80%9317621/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2022-04-27 22:16:35
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="标签"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Fuzz/" title="Fuzz">
                        #Fuzz
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/04/28/AFL%E6%80%BB%E7%BB%93/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#AFL%E6%B3%A8%E9%87%8A"><span class="toc-text">AFL注释</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81afl-gcc-c%EF%BC%9A"><span class="toc-text">1、afl-gcc.c：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81afl-as-c"><span class="toc-text">2、afl-as.c:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81afl-fuzz-c"><span class="toc-text">3、afl-fuzz.c:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E9%85%8D%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-text">初始配置函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-signal-handlers"><span class="toc-text">setup_signal_handlers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#check-asan-opts"><span class="toc-text">check_asan_opts</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fix-up-sync"><span class="toc-text">fix_up_sync</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#save-cmdline"><span class="toc-text">save_cmdline</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fix-up-banner"><span class="toc-text">fix_up_banner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#check-if-tty"><span class="toc-text">check_if_tty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU%E7%9B%B8%E5%85%B3%E7%AE%A1%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-text">CPU相关管理函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#get-core-count"><span class="toc-text">get_core_count</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#check-crash-handling"><span class="toc-text">check_crash_handling</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#check-cpu-governor"><span class="toc-text">check_cpu_governor</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-post"><span class="toc-text">setup_post</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-shm"><span class="toc-text">setup_shm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init-count-class16"><span class="toc-text">init_count_class16</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-dirs-fds"><span class="toc-text">setup_dirs_fds</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#read-testcases"><span class="toc-text">read_testcases</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#load-auto"><span class="toc-text">load_auto</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#maybe-add-auto"><span class="toc-text">maybe_add_auto</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pivot-inputs"><span class="toc-text">pivot_inputs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#load-extras"><span class="toc-text">load_extras</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#find-timeout"><span class="toc-text">find_timeout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#detect-file-args"><span class="toc-text">detect_file_args</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-stdio-file"><span class="toc-text">setup_stdio_file</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#check-binary"><span class="toc-text">check_binary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-cur-time"><span class="toc-text">get_cur_time</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#perform-dry-run"><span class="toc-text">perform_dry_run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calibrate-case"><span class="toc-text">calibrate_case</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init-forkserver"><span class="toc-text">init_forkserver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#has-new-bits"><span class="toc-text">has_new_bits</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#run-target"><span class="toc-text">run_target</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#classify-counts"><span class="toc-text">classify_counts</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#update-bitmap-score"><span class="toc-text">update_bitmap_score</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#minimize-bits"><span class="toc-text">minimize_bits</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cull-queue"><span class="toc-text">cull_queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mark-as-redundant"><span class="toc-text">mark_as_redundant</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show-init-stats"><span class="toc-text">show_init_stats</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#find-start-position"><span class="toc-text">find_start_position</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#write-stats-file"><span class="toc-text">write_stats_file</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#save-auto"><span class="toc-text">save_auto</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FUZZ%E4%B8%BB%E8%A6%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">FUZZ主要执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzz-one"><span class="toc-text">fuzz_one:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CALIBRATION"><span class="toc-text">CALIBRATION</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TRIMMING"><span class="toc-text">TRIMMING</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PERFORMANCE-SCORE"><span class="toc-text">PERFORMANCE SCORE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SIMPLE-BITFLIP"><span class="toc-text">SIMPLE BITFLIP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ARITHMETIC-INC-x2F-DEC"><span class="toc-text">ARITHMETIC INC&#x2F;DEC</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#INTERESTING-VALUES"><span class="toc-text">INTERESTING VALUES</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DICTIONARY-STUFF"><span class="toc-text">DICTIONARY STUFF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RANDOM-HAVOC"><span class="toc-text">RANDOM HAVOC</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SPLICING"><span class="toc-text">SPLICING</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trim-case"><span class="toc-text">trim_case</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calculate-score"><span class="toc-text">calculate_score</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#common-fuzz-stuff"><span class="toc-text">common_fuzz_stuff</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sync-fuzzers%EF%BC%9A"><span class="toc-text">sync_fuzzers：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#save-if-interesting"><span class="toc-text">save_if_interesting</span></a></li></ol></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zh-Closure">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zh-Closure">Copyright © 2025 Closure</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zh-Closure">email | 765003952@qq.com</a>
        
    </div>
  
  
    <div class="footer-views">
      
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
      
      
          本站访客数<span id="busuanzi_value_site_uv"></span>人
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="可露希尔大涨价……">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + AFL%E6%B3%A8%E9%87%8A + '&url=' + http%3A%2F%2Fexample.com%2F2022%2F04%2F27%2FAFL%25E6%25B3%25A8%25E9%2587%258A%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2022/04/27/AFL%E6%B3%A8%E9%87%8A/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
